<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pioneer Field Service Log</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0A84FF">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --system-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --primary-color: #0A84FF;
            --secondary-color: #000000;
            --card-bg: #1c1c1e;
            --input-bg: #2c2c2e;
            --text-color: #ffffff;
            --text-color-secondary: rgba(235, 235, 245, 0.7);
            --text-color-tertiary: rgba(235, 235, 245, 0.55);
            --border-color: #3a3a3c;
            --separator-color: rgba(58, 58, 60, 0.6);
            --shadow-color: rgba(0, 0, 0, 0.2);
            --danger-color: #FF453A;
            --success-color: #30D158;
            --success-color-darker: #249a41;
            --placeholder-color: rgba(235, 235, 245, 0.3);
            --dialog-backdrop: rgba(0, 0, 0, 0.7);
            --progress-track-color: #38383a;
            --progress-bar-color: var(--success-color);
            --chart-color-1: #0A84FF; --chart-color-2: #30D158; --chart-color-3: #FF9F0A; --chart-color-4: #AF52DE;
            --chart-color-5: #5E5CE6; --chart-color-6: #FF69B4; --chart-color-7: #32CD32; --chart-color-8: #FFD700;
            --font-family: var(--system-font);
            --border-radius: 10px;
            --border-radius-large: 12px;
            --card-padding: 18px;
            --outer-padding: 15px;
            --transition-speed: 0.3s;
            --transition-speed-fast: 0.1s;
            --content-transition: max-height 0.35s ease-out, opacity 0.25s ease-out 0.1s, padding 0.35s ease-out, margin 0.35s ease-out;
            --dashboard-border-thickness: 2px; /* Thinner progress border */
            --progress-percent: 0;
            --celebrate-color-1: #fbc531; --celebrate-color-2: #e84118; --celebrate-color-3: #4cd137;
            --celebrate-color-4: #487eb0; --celebrate-color-5: #9c88ff;
            --primary-gradient: linear-gradient(45deg, var(--primary-color), #5856d6);
            --glass-bg: rgba(50, 50, 52, 0.65); /* Slightly adjusted */
            --glass-border-color: rgba(255, 255, 255, 0.12); /* More subtle */
            --glass-blur: 16px; /* Increased blur */
            --glass-bg-met: rgba(255, 255, 255, 0.2); /* Less white */
            --glass-border-color-met: rgba(255, 255, 255, 0.25);
            --confetti-color-1: #0A84FF; --confetti-color-2: #30D158; --confetti-color-3: #FF9F0A;
            --confetti-color-4: #AF52DE; --confetti-color-5: #FF453A; --confetti-color-6: #5E5CE6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; -webkit-tap-highlight-color: rgba(0,0,0,0); }
        body {
            font-family: var(--font-family); background-color: var(--secondary-color); color: var(--text-color);
            line-height: 1.5; padding: var(--outer-padding); overscroll-behavior-y: contain;
            -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; font-size: 16px;
        }
        [data-translate-key]::before { content: ""; }
        #loading-indicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 1.2em; transition: opacity 0.3s ease-out; }
        #loading-indicator.hidden { opacity: 0; pointer-events: none; }
        #app { max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; /* Slightly smaller gap */}
        h1 { display: none; }

        #dashboard-box {
            background-color: transparent; /* Make parent transparent for better blur */
            border-radius: var(--border-radius); padding: 12px; /* Reduced padding */
            margin-bottom: 15px; /* Reduced margin */ position: relative; overflow: hidden; display: flex; flex-direction: column;
            align-items: stretch; gap: 10px; /* Reduced gap */ z-index: 0; transition: background-color 0.5s ease-out;
        }
        #dashboard-box::before { content: ''; position: absolute; inset: 0; z-index: -2; border-radius: inherit; background-image: conic-gradient( var(--progress-bar-color) calc(var(--progress-percent) * 1%), var(--progress-track-color) calc(var(--progress-percent) * 1%) ); transition: background-image 0.5s ease-out, opacity 0.4s ease-out; opacity: 1; }
        #dashboard-box::after { content: ''; position: absolute; inset: var(--dashboard-border-thickness); background: var(--card-bg); z-index: -1; border-radius: calc(var(--border-radius) - var(--dashboard-border-thickness)); transition: opacity 0.4s ease-out, background 0.5s ease-out; opacity: 1; }
        #dashboard-box.goal-met { background-color: transparent; }
        #dashboard-box.goal-met::before { opacity: 0; transition: opacity 0.1s linear; }
        #dashboard-box.goal-met::after { opacity: 1; background: linear-gradient(135deg, var(--celebrate-color-1) 0%, var(--celebrate-color-3) 25%, var(--celebrate-color-4) 50%, var(--celebrate-color-5) 75%, var(--celebrate-color-2) 100% ); background-size: 400% 400%; animation: celebrate-gradient 8s ease infinite; }
        @keyframes celebrate-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .dashboard-section {
            background-color: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur));
            border: 1px solid var(--glass-border-color); border-radius: var(--border-radius-large);
            padding: 15px 20px; /* Reduced padding */ position: relative; z-index: 1; overflow: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease; display: flex; flex-direction: column;
            align-items: center; text-align: center; /* Center align all text in sections */
        }
        #dashboard-box.goal-met .dashboard-section { background-color: var(--glass-bg-met); border-color: var(--glass-border-color-met); }

        .hero-section { padding-top: 20px; padding-bottom: 20px; /* Reduced vertical padding */ }
        #dashboard-month-percentage { font-size: 3.5em; /* Slightly smaller */ font-weight: 700; line-height: 1; margin-bottom: 8px; /* Adjusted */ margin-top: 0; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); letter-spacing: -1px; order: 1; }
        .hero-section > span.dashboard-label[data-translate-key="dashboard.monthGoalLabel"] { font-size: 0.75em; font-weight: 500; color: var(--text-color-secondary); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 0; margin-bottom: 0; order: 2; }

        .metrics-section { padding: 12px 20px; /* Reduced */ }
        .metrics-section #dashboard-week-hours.dashboard-value { font-size: 1.7em; font-weight: 500; color: var(--text-color); line-height: 1.1; margin-bottom: 4px; margin-top: 0; }
        .metrics-section span.dashboard-label[data-translate-key="dashboard.weekHoursLabel"] { font-size: 0.7em; font-weight: 600; color: var(--text-color-tertiary); margin-bottom: 0; display: block; text-transform: uppercase; letter-spacing: 1px; }

        .summary-section { padding: 12px 20px; /* Reduced */ text-align: center; /* Force center align */}
        #dashboard-summary { font-size: 0.85em; /* Slightly smaller */ color: var(--text-color-secondary); line-height: 1.5; /* Reduced slightly */ margin-bottom: 0; margin-top: 0; width: 100%; max-width: 95%; /* Allow slight wrap */ }
        #dashboard-summary strong { color: var(--text-color); font-weight: 600; }
        #dashboard-summary span { display: block; margin-bottom: 4px; }
         /* Ensure forecast span inside summary is also centered if it exists */
        #dashboard-summary #dashboard-forecast span { text-align: center; }

        .plans-section { padding: 15px; /* Reduced */ gap: 12px; }
        #dashboard-revisits-section, #dashboard-planned-dates { width: 100%; margin-top: 0; }
        .plans-section .dashboard-label { font-size: 0.7em; font-weight: 600; color: var(--text-color-tertiary); margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 1px; }

        /* Styles for the Revisit List in Dashboard */
        #dashboard-revisit-list { list-style: none; padding: 0; margin: 0; text-align: center; font-size: 0.85em; line-height: 1.5; color: var(--text-color-secondary); width: 100%; max-height: 80px; /* Adjust as needed */ overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--separator-color) transparent; margin-top: 5px; }
        #dashboard-revisit-list::-webkit-scrollbar { width: 4px; }
        #dashboard-revisit-list::-webkit-scrollbar-thumb { background-color: var(--separator-color); border-radius: 2px; }
        #dashboard-revisit-list li { margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 2px 6px; border-radius: 4px; transition: background-color var(--transition-speed-fast) ease; }
        #dashboard-revisit-list li:hover { background-color: rgba(255, 255, 255, 0.08); }
        #dashboard-revisit-list li strong { color: var(--text-color); font-weight: 600; }
        #dashboard-revisit-list li .revisit-date { color: var(--primary-color); font-weight: 500; margin-right: 5px; }
        #dashboard-revisit-list li .revisit-name { font-style: italic; }

        /* Styles for the Planned Dates List in Dashboard */
        #dashboard-plan-list { list-style: none; padding: 0; margin: 0; text-align: center; font-size: 0.85em; line-height: 1.5; color: var(--text-color-secondary); width: 100%; max-height: 80px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--separator-color) transparent; margin-top: 5px; }
        #dashboard-plan-list::-webkit-scrollbar { width: 4px; }
        #dashboard-plan-list::-webkit-scrollbar-thumb { background-color: var(--separator-color); border-radius: 2px; }
        #dashboard-plan-list li { margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 2px 6px; border-radius: 4px; transition: background-color var(--transition-speed-fast) ease; }
        #dashboard-plan-list li:hover { background-color: rgba(255, 255, 255, 0.08); }
        #dashboard-plan-list li strong { color: var(--text-color); font-weight: 600; }
        #dashboard-plan-list .plan-warning { font-size: 0.9em; margin-left: 5px; opacity: 0.7; font-style: italic; }

        /* Goal Met Text Color Reset */
        #dashboard-box.goal-met .dashboard-section,
        #dashboard-box.goal-met #dashboard-month-percentage { color: rgba(0, 0, 0, 0.8); text-shadow: none; background: none; -webkit-text-fill-color: inherit; text-fill-color: inherit; text-align: center !important; /* Ensure centered in goal met */ }
        #dashboard-box.goal-met #dashboard-month-percentage { color: #000; }
        #dashboard-box.goal-met .hero-section > span.dashboard-label, #dashboard-box.goal-met .metrics-section span.dashboard-label, #dashboard-box.goal-met #dashboard-summary, #dashboard-box.goal-met #dashboard-plan-list li, #dashboard-box.goal-met #dashboard-forecast, #dashboard-box.goal-met #dashboard-revisit-list li, #dashboard-box.goal-met .plans-section .dashboard-label { color: rgba(0, 0, 0, 0.7); } /* Updated selector for revisit list */
        #dashboard-box.goal-met .metrics-section #dashboard-week-hours.dashboard-value, #dashboard-box.goal-met #dashboard-summary strong, #dashboard-box.goal-met #dashboard-plan-list li strong, #dashboard-box.goal-met #dashboard-forecast strong, #dashboard-box.goal-met #dashboard-revisit-list li strong { color: rgba(0, 0, 0, 0.9); } /* Updated selector for revisit list */
        #dashboard-box.goal-met #dashboard-revisit-list li .revisit-date { color: rgba(0, 0, 0, 0.8); } /* Specific color for date in goal met */
        #dashboard-box.goal-met #dashboard-plan-list li:hover, #dashboard-box.goal-met #dashboard-revisit-list li:hover { background-color: transparent; } /* Updated selector for revisit list */

        #confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 10; opacity: 0; transition: opacity 0.5s ease; }
        #dashboard-box.goal-met #confetti-container { opacity: 1; }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: var(--confetti-color-1); opacity: 0; border-radius: 2px; animation: confetti-fall 4s ease-out infinite; }
        @keyframes confetti-fall { 0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; } }

        .card { background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; transition: box-shadow var(--transition-speed) ease; }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 15px var(--card-padding); cursor: pointer; transition: background-color var(--transition-speed-fast) ease; position: relative; }
        .card-header::after { content: ''; position: absolute; bottom: 0; left: var(--card-padding); right: var(--card-padding); height: 1px; background-color: var(--border-color); opacity: 1; transition: opacity var(--transition-speed-fast) ease; }
        .card.expanded .card-header::after { opacity: 0; }
        .card:not(.expanded) .card-header:hover { background-color: rgba(255, 255, 255, 0.03); }
        .card-header h2 { color: var(--text-color); margin-bottom: 0; font-size: 1.15em; font-weight: 600; pointer-events: none; }
        .toggle-icon { font-size: 0.8em; font-weight: bold; transition: transform var(--transition-speed) ease; color: var(--text-color-secondary); margin-left: 10px; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; pointer-events: none; }
        .card.expanded .toggle-icon { transform: rotate(180deg); }
        .card-content { padding: 0 var(--card-padding); max-height: 0; opacity: 0; overflow: hidden; border-top: 1px solid var(--border-color); transition: var(--content-transition); margin-top: -1px; }
        .card.expanded .card-content { padding-top: var(--card-padding); padding-bottom: calc(var(--card-padding) + 5px); max-height: 1500px; opacity: 1; margin-top: 0; overflow: visible; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color-secondary); font-size: 0.9em; }
        input[type="date"], input[type="number"], input[type="text"], input[type="search"], textarea, select { width: 100%; padding: 11px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; font-family: var(--font-family); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-color: var(--input-bg); color: var(--text-color); }
        input[type="text"].time-input { font-variant-numeric: tabular-nums; }
        input[type="search"] { padding-right: 35px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgba(235, 235, 245, 0.6)" class="bi bi-search" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>'); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px 16px; }
        input[type="search"]::-webkit-search-cancel-button{ appearance: none; height: 14px; width: 14px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgba(235, 235, 245, 0.6)" class="bi bi-x-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>'); background-size: 14px 14px; cursor: pointer; }
        select { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgba(235, 235, 245, 0.6)" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>'); background-repeat: no-repeat; background-position: right 14px center; background-size: 12px 12px; padding-right: 40px; }
        select:focus { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%230A84FF" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>'); }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; }
        input::placeholder, textarea::placeholder { color: var(--placeholder-color); opacity: 1; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3); }
        input[type="number"] { -moz-appearance: textfield; } input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        textarea { resize: vertical; min-height: 90px; }
        #record-form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        button { background-color: var(--primary-color); color: var(--text-color); border: none; padding: 11px 22px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease, filter var(--transition-speed-fast) ease; display: inline-block; margin-right: 8px; margin-top: 10px; width: auto; transform: scale(1); filter: brightness(1); -webkit-user-select: none; user-select: none; }
        button:hover { filter: brightness(1.15); }
        button:active { transform: scale(0.95); filter: brightness(0.8); transition-duration: 0.05s; }
        button.secondary { background-color: var(--input-bg); color: var(--primary-color); border: 1px solid var(--border-color); } button.secondary:hover { background-color: #3a3a3c; filter: none; } button.secondary:active { background-color: #48484a; transform: scale(0.96); filter: brightness(1); }
        button.success { background-color: var(--success-color); color: var(--text-color); } button.success:hover { filter: brightness(1.15); } button.success:active { transform: scale(0.95); filter: brightness(0.8); }
        button.danger { background-color: var(--danger-color); color: var(--text-color); } button.danger:hover { background-color: #ff3b30; filter: brightness(1.15); } button.danger:active { background-color: #E0352D; transform: scale(0.96); filter: brightness(0.85); }
        .text-center button { width: auto; margin-right: 8px; } .text-center button:last-child { margin-right: 0; }
        .change-date-button { background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 0.9em; padding: 5px 0; margin-left: 5px; text-align: left; width: auto; margin-right: 0; margin-top: 0; } .change-date-button:hover { text-decoration: underline; } .change-date-button:active { transform: scale(0.95); filter: brightness(0.8); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; text-align: center; margin-top: 10px;}
        .stat-item { background-color: var(--input-bg); padding: 16px 12px; border-radius: 8px; }
        .stat-value { font-size: 1.7em; font-weight: 600; color: var(--text-color); display: block; margin-bottom: 2px; }
        .stat-label { font-size: 0.85em; color: var(--text-color-secondary); }
        .progress-bar-container { background-color: var(--border-color); border-radius: 5px; overflow: hidden; height: 8px; margin-top: 8px; }
        .progress-bar { background-color: var(--progress-bar-color); height: 100%; width: 0; transition: width var(--transition-speed) ease-out; }
        #history-controls { margin-bottom: 15px; display: flex; gap: 10px; padding: 0 var(--card-padding) }
        .history-search-input { flex-grow: 1; }
        #showing-results-label { font-size: 0.85em; color: var(--text-color-secondary); margin-top: 5px; display: block; text-align: right; padding: 0 var(--card-padding) 5px var(--card-padding) ; min-height: 1.2em;}
        .data-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; margin-top: 0; scrollbar-width: thin; scrollbar-color: var(--border-color) transparent; }
        .data-list::-webkit-scrollbar { width: 5px; }
        .data-list::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
        .data-list li { background-color: transparent; border-bottom: 1px solid var(--border-color); padding: 14px var(--card-padding); margin: 0; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; transition: background-color var(--transition-speed-fast) ease; }
        .data-list li:last-child { border-bottom: none; }
        .data-list li:hover { background-color: rgba(255, 255, 255, 0.02); }
        .entry-details { font-size: 0.95em; flex-grow: 1; margin-right: 10px; line-height: 1.4; padding-bottom: 5px; word-break: break-word; }
        .entry-details strong { color: var(--text-color); font-weight: 500; }
        .entry-details .hours { color: var(--primary-color); font-weight: 600; margin-left: 5px; margin-right: 5px; white-space: nowrap; }
        .entry-details .tag-badge { display: inline-block; background-color: var(--input-bg); color: var(--text-color-secondary); font-size: 0.75em; padding: 2px 6px; border-radius: 5px; margin-left: 8px; vertical-align: middle; white-space: nowrap; }
        .entry-details .notes-preview { color: var(--text-color-secondary); font-size: 0.9em; display: block; margin-top: 5px; white-space: normal; overflow-wrap: break-word; max-height: 4.5em; overflow: hidden; }
        .entry-details .revisit-completed-marker { display: inline-block; background-color: var(--success-color); color: var(--text-color); font-size: 0.7em; font-weight: 600; padding: 2px 5px; border-radius: 4px; margin-right: 8px; vertical-align: middle; text-transform: uppercase; }
        .entry-details .revisit-scheduled-date { font-size: 0.85em; color: var(--text-color-secondary); margin-left: 8px; }
        .entry-details .revisit-scheduled-date strong { color: var(--primary-color); font-weight: 500; }
        /* OPTIMIZED: Combined actions selector */
        .entry-actions, .plan-actions, .revisit-actions { flex-shrink: 0; align-self: center; margin-left: auto; white-space: nowrap; margin-top: 0; }
        .entry-actions button, .plan-actions button, .revisit-actions button { padding: 6px 10px; font-size: 0.85em; margin-left: 5px; margin-top: 0; width: auto; border-radius: 6px; }
        /* Removed redundant margin-top reset */
        .entry-actions button.secondary, .plan-actions button.secondary, .revisit-actions button.secondary { background-color: #3a3a3c; }
        .chart-container { position: relative; min-height: 300px; max-height: 400px; width: 100%; margin-top: 15px; }
        .chart-summary-text { text-align: center; font-size: 0.95em; font-weight: 500; color: var(--text-color-secondary); margin-bottom: 10px; margin-top: 5px; min-height: 1.3em; padding: 0 var(--card-padding); }
        .dialog-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--dialog-backdrop); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease; }
        .dialog-backdrop.visible { opacity: 1; visibility: visible; }
        .dialog-content { background-color: #2c2c2e; color: var(--text-color); padding: 25px; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); text-align: center; max-width: 90%; width: 320px; transform: scale(0.95); transition: transform var(--transition-speed) ease; }
        .dialog-backdrop.visible .dialog-content { transform: scale(1); }
        .dialog-content p { margin-bottom: 25px; font-size: 1.05em; line-height: 1.5; }
        .dialog-actions button { width: calc(50% - 5px); margin-top: 0; padding: 10px; font-size: 1em;}
        .hidden { display: none !important; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 10px; } .mt-2 { margin-top: 20px; }
        h3.list-title { font-size: 1em; font-weight: 600; color: var(--text-color-secondary); margin-bottom: 10px; padding-left: var(--card-padding); }
        .data-list li.placeholder { padding-left: var(--card-padding); color: var(--text-color-secondary); font-style: italic; border-bottom: none; }

        @media (min-width: 768px) {
            :root { --card-padding: 20px; /* Reduced slightly */ --outer-padding: 20px; /* Reduced */ --dashboard-border-thickness: 3px; --glass-blur: 18px; }
            #app { max-width: 860px; /* Reduced */ gap: 12px; }
            #dashboard-box { padding: 15px; gap: 12px; }
            .dashboard-section { padding: 20px 25px; /* Adjusted */ }
            .hero-section { padding-top: 25px; padding-bottom: 25px; }
            #dashboard-month-percentage { font-size: 4em; }
            .metrics-section #dashboard-week-hours.dashboard-value { font-size: 2em; }
            .summary-section { padding: 18px 25px; }
            #dashboard-summary { font-size: 0.9em; }
            .plans-section { padding: 18px 20px; }
            #dashboard-plan-list, #dashboard-revisit-list { max-height: 90px; font-size: 0.9em; } /* Applied to both lists */
            #record-form-grid { grid-template-columns: 1fr 1fr; }
            #plan-form { display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end; }
            #plan-form .form-group { margin-bottom: 0; } #plan-form .text-center { grid-column: 3 / 4; text-align: right; } #plan-form .text-center button { margin-top: 0; }
            .stats-grid { grid-template-columns: repeat(4, 1fr); gap: 15px; }
            .data-list li { flex-wrap: nowrap; align-items: center; }
            .entry-details { padding-bottom: 0; }
            /* Removed redundant style block for actions */
            .dialog-content { max-width: 400px; }
            #charts-card .card-content > .form-group { display: flex; align-items: center; gap: 20px; margin-bottom: 10px; }
            #charts-card .card-content > .form-group label { margin-bottom: 0; flex-shrink: 0; }
            #charts-card .card-content > .form-group select { flex-grow: 1; max-width: 250px; }
            #chart-total-hours-display { text-align: left; margin-left: auto; margin-bottom: 0; padding: 0; }
        }
        @media (min-width: 1200px) {
            :root { --glass-blur: 20px; }
            #app { max-width: 960px; /* Reduced */}
            #dashboard-box { padding: 18px; gap: 15px; }
            .dashboard-section { padding: 25px 30px; }
            #dashboard-month-percentage { font-size: 4.5em; letter-spacing: -2px; }
            .metrics-section #dashboard-week-hours.dashboard-value { font-size: 2.2em; }
        }
    </style>
</head>
<body>
    <div id="loading-indicator">Loading...</div>

    <div id="dashboard-box">
        <div id="confetti-container"></div>
        <div class="dashboard-section hero-section">
            <span id="dashboard-month-percentage" class="dashboard-value">0%</span>
            <span class="dashboard-label" data-translate-key="dashboard.monthGoalLabel">Meta Mensal</span>
        </div>
        <div class="dashboard-section metrics-section">
            <span class="dashboard-label" data-translate-key="dashboard.weekHoursLabel">Horas da Semana</span>
            <span id="dashboard-week-hours" class="dashboard-value">0</span>
        </div>
        <div class="dashboard-section summary-section">
             <div id="dashboard-summary">
                 <span id="dashboard-month-total">Total Mês: <strong>0h</strong></span>
                 <span id="dashboard-forecast">Defina sua meta...</span>
             </div>
        </div>
        <div class="dashboard-section plans-section hidden">
            <div id="dashboard-revisits-section" class="hidden">
                <span class="dashboard-label" data-translate-key="dashboard.upcomingRevisitsLabel">Próximas Revisitas</span>
                <ul id="dashboard-revisit-list"></ul>
            </div>
            <div id="dashboard-planned-dates" class="hidden">
                <span class="dashboard-label" data-translate-key="dashboard.plannedTripsLabel">Planos Próximos</span>
                <ul id="dashboard-plan-list"></ul>
            </div>
        </div>
    </div>

    <div id="app">
        <div class="card expanded" id="record-card">
            <div class="card-header"> <h2 data-translate-key="recordCard.title">Registrar Atividade</h2> <span class="toggle-icon">▲</span></div>
            <div class="card-content">
                <form id="record-form">
                    <input type="hidden" id="record-id">
                    <div class="form-group">
                        <label for="record-date" id="date-label">
                            <span data-translate-key="recordCard.dateLabel">Data</span>: <strong id="display-date">Hoje</strong>
                            <button type="button" class="change-date-button" id="change-date-btn" data-translate-key="recordCard.changeDateButton">Alterar</button>
                        </label>
                        <input type="date" id="record-date" class="hidden">
                    </div>
                    <div id="record-form-grid">
                        <div class="form-group">
                            <label for="record-hours" data-translate-key="recordCard.timeLabel">Tempo (HH:MM)</label>
                            <input type="text" inputmode="numeric" id="record-hours" class="time-input" required data-translate-key="recordCard.timePlaceholder" data-translate-attr="placeholder" placeholder="Ex: 2:30">
                        </div>
                        <div class="form-group">
                            <label for="record-tag" data-translate-key="recordCard.tagLabel">Tipo</label>
                            <select id="record-tag"></select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="record-notes" id="record-notes-label" data-translate-key="recordCard.notesLabel">Notas (Opcional)</label>
                        <textarea id="record-notes" rows="3" data-translate-key="recordCard.notesPlaceholder" data-translate-attr="placeholder" placeholder="Detalhes da atividade..."></textarea>
                    </div>
                    <div class="text-center" style="margin-top: 20px;">
                        <button type="submit" id="save-record-btn" data-translate-key="recordCard.saveButton">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
        <div class="card" id="revisit-card">
            <div class="card-header"><h2 data-translate-key="revisitCard.title">Revisitas</h2><span class="toggle-icon">▼</span></div>
            <div class="card-content">
                <form id="revisit-form">
                    <input type="hidden" id="revisit-id">
                    <div class="form-group">
                        <label for="revisit-name" data-translate-key="revisitCard.nameLabel">Nome/Contato</label>
                        <input type="text" id="revisit-name" required data-translate-key="revisitCard.namePlaceholder" data-translate-attr="placeholder" placeholder="Nome ou identificação">
                    </div>
                    <div class="form-group">
                        <label for="revisit-date" data-translate-key="revisitCard.dateLabel">Data Agendada (Opcional)</label>
                        <input type="date" id="revisit-date">
                    </div>
                    <div class="form-group">
                        <label for="revisit-notes" data-translate-key="revisitCard.notesLabel">Notas</label>
                        <textarea id="revisit-notes" rows="2" data-translate-key="revisitCard.notesPlaceholder" data-translate-attr="placeholder" placeholder="Assunto, local, etc."></textarea>
                    </div>
                    <div class="text-center">
                        <button type="submit" id="save-revisit-btn" data-translate-key="revisitCard.addButton">Adicionar Revisita</button>
                        <button type="button" id="clear-revisit-form-btn" class="secondary" data-translate-key="revisitCard.clearButton">Limpar</button>
                    </div>
                </form>
                <div id="revisit-list-container" class="mt-2">
                    <h3 class="list-title" data-translate-key="revisitCard.pendingListTitle">Pendentes</h3>
                    <ul id="revisit-list" class="data-list">
                        <li class="placeholder hidden" data-translate-key="revisitCard.listPlaceholderNoPending">Nenhuma revisita pendente.</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card" id="plan-card">
            <div class="card-header"><h2 data-translate-key="planCard.title">Planejamento</h2><span class="toggle-icon">▼</span></div>
            <div class="card-content">
                <form id="plan-form">
                    <input type="hidden" id="plan-id">
                    <div class="form-group">
                        <label for="plan-date" data-translate-key="planCard.dateLabel">Data</label>
                        <input type="date" id="plan-date" required>
                    </div>
                    <div class="form-group">
                        <label for="plan-hours" data-translate-key="planCard.hoursLabel">Horas Planejadas</label>
                        <input type="text" inputmode="numeric" id="plan-hours" class="time-input" required data-translate-key="planCard.hoursPlaceholder" data-translate-attr="placeholder" placeholder="Ex: 3:00">
                    </div>
                    <div class="text-center">
                        <button type="submit" id="save-plan-btn" data-translate-key="planCard.saveButton">Salvar Plano</button>
                        <button type="button" id="clear-plan-form-btn" class="secondary" data-translate-key="planCard.clearButton">Limpar</button>
                    </div>
                </form>
                <div id="planning-list-container" class="mt-2">
                    <h3 class="list-title" data-translate-key="planCard.listTitle">Datas Planejadas</h3>
                    <ul id="planning-list" class="data-list">
                        <li class="placeholder hidden" data-translate-key="planCard.listPlaceholderNoPastOrFuture">Nenhum planejamento registrado.</li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="card" id="stats-card">
            <div class="card-header"><h2 data-translate-key="statsCard.title">Estatísticas do Mês</h2><span class="toggle-icon">▼</span></div>
            <div class="card-content">
                <div class="form-group" style="max-width: 200px; margin: 0 auto 25px auto; text-align:center;">
                    <label for="monthly-goal" data-translate-key="statsCard.goalLabel">Meta Mensal (Horas)</label>
                    <input type="number" id="monthly-goal" min="1" step="1" value="70">
                    <button id="save-goal-btn" class="mt-1 secondary" style="width:100%; font-size:0.9em; padding: 8px 10px;" data-translate-key="statsCard.setGoalButton">Definir Meta</button>
                </div>
                <div class="stats-grid">
                    <div class="stat-item"><span id="stats-month-hours" class="stat-value">0</span><span class="stat-label" data-translate-key="statsCard.monthHoursLabel">Horas no Mês</span></div>
                    <div class="stat-item"><span id="stats-month-goal-progress" class="stat-value">0%</span><span class="stat-label" data-translate-key="statsCard.goalProgressLabel">Progresso da Meta</span><div class="progress-bar-container"><div id="stats-month-progress-bar" class="progress-bar"></div></div></div>
                    <div class="stat-item"><span id="stats-avg-hours-day" class="stat-value">0</span><span class="stat-label" data-translate-key="statsCard.avgHoursDayLabel">Média / Dia Ativo</span></div>
                    <div class="stat-item"><span id="stats-month-days-active" class="stat-value">0</span><span class="stat-label" data-translate-key="statsCard.daysActiveLabel">Dias Ativos</span></div>
                </div>
            </div>
        </div>
        <div class="card" id="charts-card">
            <div class="card-header"><h2 data-translate-key="chartsCard.title">Gráficos</h2><span class="toggle-icon">▼</span></div>
            <div class="card-content">
                <div class="form-group"> <label for="chart-month-selector" data-translate-key="chartsCard.monthSelectorLabel">Selecionar Mês:</label>
                    <select id="chart-month-selector"></select>
                    <p id="chart-total-hours-display" class="chart-summary-text"></p> </div>
                <div class="chart-container">
                    <canvas id="monthlyHoursChart"></canvas>
                </div>
            </div>
        </div>
        <div class="card" id="history-card">
            <div class="card-header"><h2 data-translate-key="historyCard.title">Histórico</h2><span class="toggle-icon">▼</span></div>
            <div class="card-content">
                <div id="history-controls">
                    <input type="search" id="history-search-input" class="history-search-input" data-translate-key="historyCard.searchPlaceholder" data-translate-attr="placeholder" placeholder="Buscar por data, horas, tipo ou nota...">
                </div>
                <span id="showing-results-label"></span>
                <ul id="history-list" class="data-list">
                    <li class="placeholder hidden" data-translate-key="historyCard.listPlaceholderNoRecords">Nenhum registro encontrado.</li>
                </ul>
            </div>
        </div>
        <div class="card" id="settings-card">
            <div class="card-header"><h2 data-translate-key="settingsCard.title">Configurações</h2><span class="toggle-icon">▼</span></div>
            <div class="card-content">
                 <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <div class="text-center">
                    <button id="clear-all-data-btn" class="danger" data-translate-key="settingsCard.clearDataButton">Limpar Todos os Dados</button>
                </div>
                <p id="settings-warning-text" style="margin-top: 15px; font-size: 0.9em; color: var(--text-color-secondary); text-align: center; line-height: 1.4;" data-translate-key="settingsCard.clearDataWarning">Atenção: Esta ação é irreversível e apagará todos os registros, planos e revisitas.</p>
            </div>
        </div>
    </div>

    <div id="confirmation-dialog" class="dialog-backdrop">
        <div class="dialog-content">
            <p id="dialog-message">Você tem certeza?</p>
            <div class="dialog-actions">
                <button id="dialog-confirm-btn" class="danger" data-translate-key="dialog.confirmButton">Confirmar</button>
                <button id="dialog-cancel-btn" class="secondary" data-translate-key="dialog.cancelButton">Cancelar</button>
            </div>
        </div>
    </div>

    <script>
        (async () => {
            // --- Constants & Config ---
            const translations = {}; let currentLang = 'en'; const supportedLanguages = ["pt-BR", "en", "es", "de", "fr"];
            const tagKeyMapping = {"Casa em casa": "tags.houseToHouse", "Carrinho": "tags.cart", "Cartas": "tags.letters", "Testemunho informal": "tags.informalWitnessing", "Outro": "tags.other" };
            const DEFAULT_TAG_VALUE = "Casa em casa"; const NOTES_MAX_LENGTH = 300; const REVISIT_NOTES_MAX_LENGTH = 500; const HISTORY_MONTH_LIMIT = 3; const MIN_HOURS_PER_DAY_FORECAST = 1.0;
            const LOCAL_STORAGE_KEYS = { ENTRIES: 'pioneerTracker_entries_v5.1', PLANS: 'pioneerTracker_plans_v1.1', REVISITS: 'pioneerTracker_revisits_v1.1', SETTINGS: 'pioneerTracker_settings_v1.1' };
            const CONFETTI_COUNT = 30; const DASHBOARD_REVISIT_LIMIT = 3;

            // --- DOM Element Variables ---
            let appElement, dashboardBox, confettiContainer, dashboardWeekHours, dashboardMonthPercentage, dashboardMonthTotal, dashboardForecast, dashboardPlannedDatesContainer, dashboardPlanList, recordCard, recordForm, recordIdInput, recordDateInput, dateLabel, displayDate, changeDateBtn, recordHoursInput, recordTagSelect, recordNotesInput, recordNotesLabel, saveRecordBtn, planCard, planForm, planIdInput, planDateInput, planHoursInput, savePlanBtn, clearPlanFormBtn, planningList, planningListPlaceholder, monthlyGoalInput, saveGoalBtn, statsMonthHours, statsMonthGoalProgress, statsMonthProgressBar, statsAvgHoursDay, statsMonthDaysActive, chartMonthSelector, monthlyHoursChartCtx, historyList, historySearchInput, historyListPlaceholder, showingResultsLabel, clearAllDataBtn, confirmationDialog, dialogMessage, dialogConfirmBtn, dialogCancelBtn, computedStyles, textColor, textMutedColor, tooltipBgColor, chartTotalHoursDisplay, chartColors = [];
            let revisitCard, revisitForm, revisitIdInput, revisitNameInput, revisitDateInput, revisitNotesInput, saveRevisitBtn, clearRevisitFormBtn, revisitListContainer, revisitList, revisitListPlaceholder, dashboardRevisitsSection, dashboardRevisitList, plansSection;

            // --- Data Variables ---
            let recordedEntries = [], plannedEntries = [], revisits = [], settings = { monthlyGoal: 70, goalHasBeenSet: false };

            // --- State Variables ---
            let monthlyHoursChartInstance = null, currentEditingId = null, currentConfirmCallback = null, isDateInputVisible = false, deferredInstallPrompt = null;
            let MONTH_NAMES = [], WEEKDAY_NAMES = []; let lastCheckedDateString = ''; let dateCheckInterval = null; let confettiTimeout = null;
            const loadingIndicator = document.getElementById('loading-indicator');

            // --- Initialization ---
            if (loadingIndicator) loadingIndicator.classList.remove('hidden');

            // --- Utility Functions ---
            const getNestedValue = (obj, key) => key?.split('.').reduce((acc, part) => acc && acc[part] !== undefined ? acc[part] : undefined, obj);
            const t = (key, variables = {}) => {
                const langObj = translations?.[currentLang] || translations?.['en'];
                if (!langObj) { console.error(`Lang missing: ${currentLang} & 'en'. Key: ${key}`); return `[NO LANG: ${key}]`; }
                let translation = getNestedValue(langObj, key) ?? getNestedValue(translations['en'], key);
                if (translation === undefined) return `[MISSING: ${key}]`;
                if (typeof translation !== 'string') return `[TYPE ERR: ${key}]`;
                for (const placeholder in variables) {
                    if (Object.prototype.hasOwnProperty.call(variables, placeholder)) {
                        translation = translation.replace(new RegExp(`\\{${placeholder}\\}`, 'g'), variables[placeholder]);
                    }
                }
                return translation;
            };
            const applyStaticTranslations = () => {
                document.querySelectorAll('[data-translate-key]').forEach(element => {
                    const key = element.getAttribute('data-translate-key');
                    const attr = element.getAttribute('data-translate-attr') || 'textContent';
                    const translation = t(key);
                    if (translation && !translation.startsWith('[')) {
                        if (attr === 'textContent') element.textContent = translation;
                        else if (['placeholder', 'title', 'value'].includes(attr)) element.setAttribute(attr, translation);
                    }
                });
                if (recordTagSelect) {
                    const currentVal = recordTagSelect.value;
                    recordTagSelect.innerHTML = Object.keys(tagKeyMapping)
                        .map(internalValue => `<option value="${internalValue}">${t(tagKeyMapping[internalValue] || 'tags.noTag')}</option>`)
                        .join('');
                    recordTagSelect.value = recordTagSelect.querySelector(`option[value="${currentVal}"]`) ? currentVal : DEFAULT_TAG_VALUE;
                }
                document.title = t('appTitle');
                document.documentElement.lang = currentLang.split('-')[0];
                if (recordNotesLabel) recordNotesLabel.textContent = t('recordCard.notesLabel', { maxLength: NOTES_MAX_LENGTH });
                if (recordNotesInput) recordNotesInput.maxLength = NOTES_MAX_LENGTH;
                if (revisitNotesInput) revisitNotesInput.maxLength = REVISIT_NOTES_MAX_LENGTH;
                if (loadingIndicator && !loadingIndicator.classList.contains('hidden')) loadingIndicator.textContent = t('common.loading');
            };
            const loadTranslations = async () => {
                try {
                    const response = await fetch('translations.json');
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    Object.assign(translations, await response.json()); // Use Object.assign to merge into existing object
                    const browserLang = (navigator.language || 'en').split('-')[0];
                    const browserLocale = navigator.language || 'en';
                    currentLang = (translations[browserLocale] && supportedLanguages.includes(browserLocale)) ? browserLocale
                                : (translations[browserLang] && supportedLanguages.includes(browserLang)) ? browserLang
                                : 'en';
                    if (!translations['en']) throw new Error("'en' language file missing");
                    console.log("Language selected:", currentLang);
                    MONTH_NAMES = getNestedValue(translations[currentLang], 'dates.monthNames') || ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    WEEKDAY_NAMES = getNestedValue(translations[currentLang], 'dates.weekdaysShort') || ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
                } catch (error) {
                    console.error('FATAL: Translation load error:', error);
                    if (loadingIndicator) loadingIndicator.textContent = 'Language file error!';
                    alert("Language data error. Check translations.json or network.");
                    MONTH_NAMES = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                    WEEKDAY_NAMES = ['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];
                    currentLang = 'en';
                }
            };
            const selectDOMElements = () => {
                // Select all elements at once for potential minor performance gain
                const ids = [
                    'app', 'dashboard-box', 'confetti-container', 'dashboard-week-hours', 'dashboard-month-percentage',
                    'dashboard-month-total', 'dashboard-forecast', 'dashboard-planned-dates', 'dashboard-plan-list',
                    'record-card', 'record-form', 'record-id', 'record-date', 'date-label', 'display-date', 'change-date-btn',
                    'record-hours', 'record-tag', 'record-notes', 'record-notes-label', 'save-record-btn', 'plan-card',
                    'plan-form', 'plan-id', 'plan-date', 'plan-hours', 'save-plan-btn', 'clear-plan-form-btn', 'planning-list',
                    'monthly-goal', 'save-goal-btn', 'stats-month-hours', 'stats-month-goal-progress', 'stats-month-progress-bar',
                    'stats-avg-hours-day', 'stats-month-days-active', 'chart-month-selector', 'monthlyHoursChart', 'chart-total-hours-display',
                    'history-list', 'history-search-input', 'showing-results-label', 'clear-all-data-btn', 'confirmation-dialog',
                    'dialog-message', 'dialog-confirm-btn', 'dialog-cancel-btn', 'revisit-card', 'revisit-form', 'revisit-id',
                    'revisit-name', 'revisit-date', 'revisit-notes', 'save-revisit-btn', 'clear-revisit-form-btn',
                    'revisit-list-container', 'revisit-list', 'dashboard-revisits-section', 'dashboard-revisit-list'
                ];
                const elements = ids.reduce((acc, id) => { acc[id.replace(/-(\w)/g, (_, c) => c.toUpperCase())] = document.getElementById(id); return acc; }, {});
                Object.assign(window, elements); // Assign to global scope (or a dedicated object)

                // Select elements needing querySelector
                planningListPlaceholder = planningList?.querySelector('.placeholder');
                historyListPlaceholder = historyList?.querySelector('.placeholder');
                revisitListPlaceholder = revisitList?.querySelector('.placeholder');
                plansSection = document.querySelector('.plans-section');
                monthlyHoursChartCtx = monthlyHoursChart?.getContext('2d'); // Get context after selecting canvas

                // Get computed styles
                try { computedStyles = getComputedStyle(document.body); } catch (e) { computedStyles = {}; }
                textColor = computedStyles.getPropertyValue?.('--text-color')?.trim() || '#ffffff';
                textMutedColor = computedStyles.getPropertyValue?.('--text-color-secondary')?.trim() || '#aaaaaa';
                tooltipBgColor = computedStyles.getPropertyValue?.('--card-bg')?.trim() || '#1c1c1e';
                chartColors = Array.from({ length: 8 }, (_, i) => computedStyles.getPropertyValue?.(`--chart-color-${i+1}`)?.trim() || ['#0A84FF', '#30D158', '#FF9F0A', '#AF52DE', '#5E5CE6', '#FF69B4', '#32CD32', '#FFD700'][i]);
            };
            const getCurrentDateString = () => new Date().toISOString().slice(0, 10);
            const parseLocalDate = (dateString) => {
                if (!dateString || !/^\d{4}-\d{2}-\d{2}$/.test(dateString)) return new Date(NaN);
                const [y, m, d] = dateString.split('-').map(Number);
                return new Date(y, m - 1, d);
            };
            const formatDisplayDate = (dateString) => {
                if (!dateString || !dateString.includes('-')) return dateString;
                try {
                    const date = parseLocalDate(dateString);
                    if (isNaN(date.valueOf())) throw new Error("Invalid date");
                    return new Intl.DateTimeFormat(currentLang || 'default', { day: '2-digit', month: '2-digit', year: 'numeric' }).format(date);
                } catch (e) { const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`; }
            };
            const getMonthYearString = (date) => `${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
            const getStartOfWeek = (date = new Date()) => {
                const d = new Date(date);
                d.setHours(0, 0, 0, 0);
                const diff = d.getDate() - d.getDay(); // Assumes Sunday is 0
                const sOW = new Date(d.setDate(diff));
                return sOW.toISOString().slice(0, 10);
            };
            const getDateMonthsAgo = (months) => {
                const d = new Date();
                d.setHours(0, 0, 0, 0);
                d.setMonth(d.getMonth() - months);
                return d.toISOString().slice(0, 10);
            };
            const formatMonthYearExtensive = (monthYearString) => {
                if (!monthYearString || !monthYearString.includes('/') || !Array.isArray(MONTH_NAMES) || MONTH_NAMES.length < 12) return monthYearString;
                const [m, y] = monthYearString.split('/');
                const idx = parseInt(m, 10) - 1;
                return (idx >= 0 && idx <= 11) ? `${MONTH_NAMES[idx]} ${y}` : monthYearString;
            };
            const formatHoursExtensive = (hoursDecimal, short = false) => {
                if (isNaN(hoursDecimal) || hoursDecimal < 0) hoursDecimal = 0;
                const totalMinutes = Math.round(hoursDecimal * 60);
                const hours = Math.floor(totalMinutes / 60);
                const minutes = totalMinutes % 60;
                const hKey = short ? (hours === 1 ? 'units.hour_short' : 'units.hours_short') : (hours === 1 ? 'units.hour' : 'units.hours');
                const mKey = short ? (minutes === 1 ? 'units.minute_short' : 'units.minutes_short') : (minutes === 1 ? 'units.minute' : 'units.minutes');
                const hPart = hours > 0 ? `${hours}${short ? t(hKey) : ' ' + t(hKey)}` : '';
                const mPart = minutes > 0 ? `${minutes}${short ? t(mKey) : ' ' + t(mKey)}` : '';
                if (hPart && mPart) return `${hPart}${short ? " " : ` ${t('units.andConnector')} `}${mPart}`;
                if (hPart || mPart) return hPart || mPart;
                return `0${short ? t('units.hours_short') : ' ' + t('units.hours', { count: 0 })}`;
            };
            const formatDecimalToTimeInput = (d) => {
                if (isNaN(d) || d <= 0) return "";
                const t = Math.round(d * 60), h = Math.floor(t / 60), m = t % 60;
                return `${h}:${String(m).padStart(2, '0')}`;
            };
            const parseTimeInputToDecimal = (s) => {
                if (!s) return 0;
                const t = s.trim();
                if (!t) return 0;
                const colonMatch = t.match(/^(\d{1,3}):(\d{1,2})$/);
                if (colonMatch) {
                    const h = parseInt(colonMatch[1], 10), m = parseInt(colonMatch[2], 10);
                    if (!isNaN(h) && !isNaN(m) && m >= 0 && m < 60 && h >= 0) return h + (m / 60);
                }
                const numMatch = t.match(/^(\d+)$/);
                if (numMatch) {
                    const str = numMatch[1], v = parseInt(str, 10);
                    if (isNaN(v)) return NaN;
                    if (str.length <= 2 && v < 60) return v / 60;
                    if (str.length >= 3 && str.length <= 4) {
                        const hs = str.slice(0, -2), ms = str.slice(-2);
                        const h = parseInt(hs, 10), m = parseInt(ms, 10);
                        if (!isNaN(h) && !isNaN(m) && m >= 0 && m < 60 && h >= 0) return h + (m / 60);
                    }
                }
                return NaN;
            };
            const formatRelativeDate = (dateString) => {
                if (!dateString) return '';
                const today = new Date(); today.setHours(0, 0, 0, 0);
                const inputDate = parseLocalDate(dateString);
                if (isNaN(inputDate.valueOf()) || !Array.isArray(WEEKDAY_NAMES) || WEEKDAY_NAMES.length < 7) return formatDisplayDate(dateString);
                const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1);
                const week = new Date(today); week.setDate(today.getDate() + 7);
                const inputTime = inputDate.getTime(), todayTime = today.getTime(), tomorrowTime = tomorrow.getTime();
                if (inputTime === todayTime) return t('dates.today');
                if (inputTime === tomorrowTime) return t('dates.tomorrow');
                if (inputDate > tomorrow && inputDate < week) return `${t('dates.nextPrefix')} ${WEEKDAY_NAMES[inputDate.getDay()]}`;
                return formatDisplayDate(dateString);
            };
            const saveData = () => { try { localStorage.setItem(LOCAL_STORAGE_KEYS.ENTRIES, JSON.stringify(recordedEntries)); localStorage.setItem(LOCAL_STORAGE_KEYS.PLANS, JSON.stringify(plannedEntries)); localStorage.setItem(LOCAL_STORAGE_KEYS.REVISITS, JSON.stringify(revisits)); localStorage.setItem(LOCAL_STORAGE_KEYS.SETTINGS, JSON.stringify(settings)); } catch (e) { showFeedback('feedback.saveError', 'danger'); } };
            const loadData = () => {
                try {
                    const parseJSON = (key, defaultVal = []) => {
                        const item = localStorage.getItem(key);
                        try { return item ? JSON.parse(item) : defaultVal; }
                        catch (e) { localStorage.removeItem(key); return defaultVal; }
                    };
                    recordedEntries = (parseJSON(LOCAL_STORAGE_KEYS.ENTRIES) || []).map(e => ({ ...e, notes: e.notes?.substring(0, NOTES_MAX_LENGTH) || '', tag: e.tag || DEFAULT_TAG_VALUE }));
                    plannedEntries = (parseJSON(LOCAL_STORAGE_KEYS.PLANS) || []).map(p => p.plannedHours !== undefined ? { ...p, hours: p.plannedHours, plannedHours: undefined } : p);
                    revisits = (parseJSON(LOCAL_STORAGE_KEYS.REVISITS) || []).map(rv => ({ ...rv, status: rv.status || 'pending', notes: rv.notes?.substring(0, REVISIT_NOTES_MAX_LENGTH) || '', dateAdded: rv.dateAdded || getCurrentDateString(), scheduledDate: rv.scheduledDate || null }));
                    settings = { monthlyGoal: 70, goalHasBeenSet: false, ...parseJSON(LOCAL_STORAGE_KEYS.SETTINGS, {}) };
                    if (isNaN(settings.monthlyGoal) || settings.monthlyGoal <= 0) settings.monthlyGoal = 70;
                    settings.goalHasBeenSet = !!settings.goalHasBeenSet; // Ensure boolean

                    // Sort data
                    recordedEntries.sort((a, b) => b.date.localeCompare(a.date));
                    plannedEntries.sort((a, b) => a.date.localeCompare(b.date));
                    revisits.sort((a, b) => {
                        if (a.status !== b.status) return a.status === 'pending' ? -1 : 1;
                        if (a.scheduledDate && b.scheduledDate) return a.scheduledDate.localeCompare(b.scheduledDate);
                        if (a.scheduledDate) return -1; if (b.scheduledDate) return 1;
                        return (a.dateAdded || '').localeCompare(b.dateAdded || '');
                    });
                } catch (e) {
                    recordedEntries = []; plannedEntries = []; revisits = []; settings = { monthlyGoal: 70, goalHasBeenSet: false };
                    try { localStorage.clear(); } catch (se) {}
                    showFeedback('feedback.loadError', 'danger');
                }
            };
            const triggerInstallPromptIfAvailable = () => { if (deferredInstallPrompt && settings.goalHasBeenSet) { setTimeout(() => { deferredInstallPrompt.prompt().catch(e => {}); deferredInstallPrompt = null; }, 300); } };
            const promptForMonthlyGoal = () => {
                let ok = false;
                while (!ok) {
                    const inp = prompt(t('statsCard.goalLabel'), settings.monthlyGoal);
                    if (inp === null) { ok = true; if (!settings.goalHasBeenSet) { settings.goalHasBeenSet = true; saveData(); updateAllDisplays(); } }
                    else {
                        const g = parseInt(inp, 10);
                        if (!isNaN(g) && g > 0) {
                            settings.monthlyGoal = g; settings.goalHasBeenSet = true;
                            if(monthlyGoalInput) monthlyGoalInput.value = g;
                            saveData(); ok = true; updateAllDisplays(); showFeedback("feedback.goalSetSuccess", "success"); triggerInstallPromptIfAvailable();
                        } else { alert(t("feedback.invalidGoalValue")); }
                    }
                }
            };
            const setDateInputVisibility = (visible) => {
                isDateInputVisible = visible;
                recordDateInput?.classList.toggle('hidden', !visible);
                dateLabel?.classList.toggle('visually-hidden', visible);
                if (visible) recordDateInput?.focus();
                else if (displayDate) displayDate.textContent = (!recordDateInput?.value || recordDateInput.value === getCurrentDateString()) ? t('dates.today') : formatDisplayDate(recordDateInput.value);
            };
            const toggleCard = (cardElement) => {
                if (!cardElement) return;
                const isExpanded = cardElement.classList.toggle('expanded');
                const icon = cardElement.querySelector('.toggle-icon');
                if (icon) icon.textContent = isExpanded ? '▲' : '▼';
            };
            const clearRecordForm = () => {
                recordForm?.reset();
                if (recordIdInput) recordIdInput.value = '';
                if (recordDateInput) recordDateInput.value = getCurrentDateString();
                setDateInputVisibility(false);
                if (recordTagSelect) recordTagSelect.value = DEFAULT_TAG_VALUE;
                if (saveRecordBtn) saveRecordBtn.textContent = t('recordCard.saveButton');
                saveRecordBtn?.classList.remove('editing');
                currentEditingId = null;
            };
            const handleRecordSubmit = (event) => {
                event.preventDefault();
                const id = recordIdInput?.value ? parseInt(recordIdInput.value, 10) : Date.now();
                const date = (isDateInputVisible || (recordDateInput?.value && recordDateInput.value !== getCurrentDateString())) ? recordDateInput.value : getCurrentDateString();
                const hours = parseTimeInputToDecimal(recordHoursInput?.value);
                const tag = recordTagSelect?.value || DEFAULT_TAG_VALUE;
                const notes = recordNotesInput?.value.trim().substring(0, NOTES_MAX_LENGTH);
                if (isNaN(hours) || hours <= 0) { alert(t('feedback.invalidTimeFormat')); recordHoursInput?.focus(); return; }
                if (!date) { alert(t('feedback.invalidDate')); return; }
                const entry = { id, date, hours, tag, notes, type: 'record' };
                const idx = recordedEntries.findIndex(e => e.id === id);
                if (idx > -1) recordedEntries[idx] = entry; else recordedEntries.push(entry);
                recordedEntries.sort((a, b) => b.date.localeCompare(a.date));
                saveData(); clearRecordForm(); updateAllDisplays(); showFeedback('feedback.recordSavedSuccess', 'success');
            };
            const editRecordEntry = (id) => {
                const entry = recordedEntries.find(e => e.id === id && e.type !== 'revisit_completed');
                if (entry) {
                    if (!recordCard?.classList.contains('expanded')) toggleCard(recordCard);
                    currentEditingId = id;
                    if (recordIdInput) recordIdInput.value = entry.id;
                    if (recordDateInput) recordDateInput.value = entry.date;
                    setDateInputVisibility(entry.date !== getCurrentDateString());
                    if (recordHoursInput) recordHoursInput.value = formatDecimalToTimeInput(entry.hours);
                    if (recordTagSelect) recordTagSelect.value = entry.tag || DEFAULT_TAG_VALUE;
                    if (recordNotesInput) recordNotesInput.value = entry.notes || '';
                    if (saveRecordBtn) { saveRecordBtn.textContent = t('recordCard.updateButton'); saveRecordBtn.classList.add('editing'); }
                    recordCard?.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    recordHoursInput?.focus();
                }
            };
            const deleteRecordEntry = (id) => { showConfirmationDialog(t('dialog.confirmDeleteRecordMessage'), () => { const i = recordedEntries.findIndex(e => e.id === id); if (i > -1) { recordedEntries.splice(i, 1); saveData(); updateAllDisplays(); showFeedback('feedback.recordDeletedSuccess', 'info'); if (currentEditingId === id) clearRecordForm(); } }); };
            const clearPlanForm = () => { planForm?.reset(); if (planIdInput) planIdInput.value = ''; if (savePlanBtn) savePlanBtn.textContent = t('planCard.saveButton'); currentEditingId = null; };
            const handlePlanSubmit = (event) => {
                event.preventDefault();
                const id = planIdInput?.value ? parseInt(planIdInput.value, 10) : Date.now();
                const date = planDateInput?.value;
                const hours = parseTimeInputToDecimal(planHoursInput?.value);
                if (!date || isNaN(hours) || hours <= 0) { alert(t('feedback.planFormInvalid')); planHoursInput?.focus(); return; }
                if (date < getCurrentDateString()) { alert(t('feedback.planDatePastError')); planDateInput?.focus(); return; }
                const plan = { id, date, hours };
                const idx = plannedEntries.findIndex(p => p.id === id);
                if (idx > -1) plannedEntries[idx] = plan; else plannedEntries.push(plan);
                plannedEntries.sort((a, b) => a.date.localeCompare(b.date));
                saveData(); clearPlanForm(); updateAllDisplays(); showFeedback('feedback.planSavedSuccess', 'success');
            };
            const markPlanAsDone = (id) => {
                const idx = plannedEntries.findIndex(p => p.id === id);
                if (idx === -1) { showFeedback('feedback.planNotFound', 'danger'); return; }
                const plan = plannedEntries[idx];
                const todayStr = getCurrentDateString();
                const recDate = todayStr < plan.date ? todayStr : plan.date;
                const note = t('recordCard.autoNoteFromPlan', { date: formatDisplayDate(plan.date), hours: formatHoursExtensive(plan.hours) });
                recordedEntries.push({ id: Date.now(), date: recDate, hours: plan.hours, tag: DEFAULT_TAG_VALUE, notes: note, type: 'record' });
                recordedEntries.sort((a, b) => b.date.localeCompare(a.date));
                plannedEntries.splice(idx, 1);
                saveData(); updateAllDisplays(); showFeedback('feedback.planMarkedDoneSuccess', 'success');
            };
            const deletePlanEntry = (id) => { showConfirmationDialog(t('dialog.confirmDeletePlanMessage'), () => { const initialLength = plannedEntries.length; plannedEntries = plannedEntries.filter(p => p.id !== id); if (plannedEntries.length < initialLength) { saveData(); updateAllDisplays(); showFeedback('feedback.planDeletedSuccess', 'info'); if (currentEditingId === id) clearPlanForm(); } }); };
            const handleGoalSave = () => { const g = parseInt(monthlyGoalInput?.value, 10); if (!isNaN(g) && g > 0) { settings.monthlyGoal = g; settings.goalHasBeenSet = true; saveData(); updateAllDisplays(); showFeedback('feedback.goalUpdateSuccess', 'success'); triggerInstallPromptIfAvailable(); } else { alert(t('feedback.invalidGoalValue')); if (monthlyGoalInput) monthlyGoalInput.value = settings.monthlyGoal; } };
            const handleClearAllData = () => { showConfirmationDialog(t('dialog.confirmClearAllDataMessage'), () => { recordedEntries = []; plannedEntries = []; revisits = []; settings = { monthlyGoal: 70, goalHasBeenSet: false }; if (monthlyGoalInput) monthlyGoalInput.value = settings.monthlyGoal; saveData(); clearRecordForm(); clearPlanForm(); clearRevisitForm(); updateAllDisplays(); showFeedback('feedback.clearAllDataSuccess', 'danger'); document.querySelectorAll('.card').forEach(c => { const shouldBeExpanded = c.id === 'record-card'; if (c.classList.contains('expanded') !== shouldBeExpanded) toggleCard(c); }); }); };
            const showConfirmationDialog = (message, onConfirm) => { if (dialogMessage) dialogMessage.textContent = message; currentConfirmCallback = onConfirm; confirmationDialog?.classList.add('visible'); dialogConfirmBtn?.focus(); };
            const hideConfirmationDialog = () => { confirmationDialog?.classList.remove('visible'); setTimeout(() => { currentConfirmCallback = null; }, 300); };
            const showFeedback = (key, type = 'info', vars = {}) => {
                const msg = t(key, vars);
                const fb = document.createElement('div');
                fb.textContent = msg;
                const bgColor = type === 'success' ? 'var(--success-color)' : type === 'danger' ? 'var(--danger-color)' : 'var(--primary-color)';
                fb.style.cssText = `position:fixed; bottom:20px; left:50%; transform:translateX(-50%); padding:10px 20px; border-radius:8px; z-index:1100; box-shadow:0 4px 15px rgba(0,0,0,0.2); font-size:0.95em; transition:opacity 0.5s ease, bottom 0.5s ease; opacity:0; background-color: ${bgColor}; color: var(--text-color); text-align: center; max-width: 90%;`;
                document.body.appendChild(fb);
                requestAnimationFrame(() => { fb.style.opacity = '1'; fb.style.bottom = '30px'; }); // Use rAF for smoother transition start
                setTimeout(() => { fb.style.opacity = '0'; fb.style.bottom = '10px'; }, 3500);
                setTimeout(() => { fb.remove() }, 4000); // Use remove() instead of parentNode.removeChild
            };
            const clearRevisitForm = () => { revisitForm?.reset(); if (revisitIdInput) revisitIdInput.value = ''; if (saveRevisitBtn) saveRevisitBtn.textContent = t('revisitCard.addButton'); currentEditingId = null; };
            const handleRevisitSubmit = (event) => {
                event.preventDefault();
                const id = revisitIdInput?.value ? parseInt(revisitIdInput.value, 10) : Date.now();
                const name = revisitNameInput?.value.trim();
                const scheduledDate = revisitDateInput?.value || null;
                const notes = revisitNotesInput?.value.trim().substring(0, REVISIT_NOTES_MAX_LENGTH);
                if (!name) { alert(t('feedback.revisitNameRequired')); revisitNameInput?.focus(); return; }
                const revisit = { id, name, notes, dateAdded: getCurrentDateString(), scheduledDate, status: 'pending', dateCompleted: null };
                const idx = revisits.findIndex(rv => rv.id === id);
                if (idx > -1) revisits[idx] = revisit; else revisits.push(revisit);
                revisits.sort((a, b) => { if (a.status !== b.status) return a.status === 'pending' ? -1 : 1; if (a.scheduledDate && b.scheduledDate) return a.scheduledDate.localeCompare(b.scheduledDate); if (a.scheduledDate) return -1; if (b.scheduledDate) return 1; return (a.dateAdded || '').localeCompare(b.dateAdded || ''); });
                saveData(); clearRevisitForm(); updateAllDisplays(); showFeedback('feedback.revisitSavedSuccess', 'success');
            };
            const markRevisitComplete = (id) => {
                const idx = revisits.findIndex(rv => rv.id === id);
                if (idx === -1) { showFeedback('feedback.revisitNotFound', 'danger'); return; }
                const revisit = revisits.splice(idx, 1)[0]; // Remove from pending list
                const completionDate = getCurrentDateString();
                const historyEntry = { id: Date.now(), date: completionDate, hours: 0, tag: t('historyCard.revisitCompletedTag'), notes: `${t('historyCard.revisitCompletedNotePrefix')} ${revisit.name}${revisit.notes ? `\n${t('historyCard.revisitOriginalNotes')}: ${revisit.notes}` : ''}`, type: 'revisit_completed', revisitId: revisit.id };
                recordedEntries.push(historyEntry);
                recordedEntries.sort((a, b) => b.date.localeCompare(a.date));
                saveData(); updateAllDisplays(); showFeedback('feedback.revisitMarkedCompleteSuccess', 'success');
            };
            const deleteRevisit = (id) => { showConfirmationDialog(t('dialog.confirmDeleteRevisitMessage'), () => { const initialLength = revisits.length; revisits = revisits.filter(rv => rv.id !== id); if (revisits.length < initialLength) { saveData(); updateAllDisplays(); showFeedback('feedback.revisitDeletedSuccess', 'info'); if (currentEditingId === id) clearRevisitForm(); } }); };
            const createConfetti = () => {
                if (!confettiContainer) return;
                confettiContainer.innerHTML = ''; // Clear existing
                const fragment = document.createDocumentFragment();
                for (let i = 0; i < CONFETTI_COUNT; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti'; // Use className for single class
                    confetti.style.left = `${Math.random() * 100}%`;
                    confetti.style.backgroundColor = `var(--confetti-color-${Math.floor(Math.random() * 6) + 1})`;
                    confetti.style.animationDelay = `${Math.random() * 2}s`;
                    const size = Math.random() * 6 + 6;
                    confetti.style.width = `${size}px`;
                    confetti.style.height = `${size * (Math.random() * 0.5 + 0.75)}px`;
                    if (Math.random() > 0.7) confetti.style.borderRadius = '50%';
                    fragment.appendChild(confetti);
                }
                confettiContainer.appendChild(fragment); // Append fragment once
                if (confettiTimeout) clearTimeout(confettiTimeout);
                confettiTimeout = setTimeout(() => { if (confettiContainer) confettiContainer.innerHTML = ''; }, 6000);
            };
            const removeConfetti = () => { if (confettiTimeout) clearTimeout(confettiTimeout); if (confettiContainer) confettiContainer.innerHTML = ''; };

            // --- Dashboard Update Logic ---
            const updateDashboard = () => {
                const today = new Date(); const currentMonth = today.getMonth(); const currentYear = today.getFullYear();
                let monthHours = 0, weekHours = 0;
                const startOfWeekStr = getStartOfWeek(today); const todayStr = getCurrentDateString();

                recordedEntries.forEach(entry => {
                    if (entry.type !== 'revisit_completed') {
                        const entryDate = parseLocalDate(entry.date);
                        if (!isNaN(entryDate.valueOf())) {
                            if (entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear) monthHours += entry.hours;
                            if (entry.date >= startOfWeekStr) weekHours += entry.hours;
                        }
                    }
                });

                if (dashboardWeekHours) dashboardWeekHours.textContent = formatHoursExtensive(weekHours, true);

                const goal = settings.monthlyGoal || 70;
                const percentage = goal > 0 ? Math.min(100, (monthHours / goal) * 100) : 0;
                if (dashboardMonthPercentage) dashboardMonthPercentage.textContent = `${Math.round(percentage)}%`;
                if (dashboardBox) {
                    dashboardBox.style.setProperty('--progress-percent', percentage);
                    const goalMet = percentage >= 100;
                    if (goalMet && !dashboardBox.classList.contains('goal-met')) { dashboardBox.classList.add('goal-met'); createConfetti(); }
                    else if (!goalMet && dashboardBox.classList.contains('goal-met')) { dashboardBox.classList.remove('goal-met'); removeConfetti(); }
                }

                if (dashboardMonthTotal) dashboardMonthTotal.innerHTML = `${t('dashboard.monthTotalLabel')} <strong>${formatHoursExtensive(monthHours)}</strong>`;
                const lastDayOfMonthObj = new Date(currentYear, currentMonth + 1, 0); const lastDayOfMonth = lastDayOfMonthObj.getDate(); const todayDay = today.getDate();
                const remainingDays = Math.max(0, lastDayOfMonth - todayDay); const remainingHoursNeeded = Math.max(0, goal - monthHours);
                let forecastText = '';
                if (!settings.goalHasBeenSet) forecastText = `<span>${t('dashboard.setGoalPrompt')}</span>`;
                else if (remainingHoursNeeded <= 0) forecastText = `<span>${t('dashboard.goalMet')}</span>`;
                else if (remainingDays <= 0 && todayDay === lastDayOfMonth) forecastText = `<span>${t('dashboard.goalNotMetMonthEnd')}</span>`;
                else if (remainingDays <= 0) forecastText = `<span>${t('dashboard.forecastPrefix')} ${formatHoursExtensive(remainingHoursNeeded)}.</span>`;
                else {
                    let avgNeededPerDay = remainingHoursNeeded / remainingDays; let daysToWork = remainingDays;
                    if (avgNeededPerDay > 0 && avgNeededPerDay < MIN_HOURS_PER_DAY_FORECAST) { daysToWork = Math.ceil(remainingHoursNeeded / MIN_HOURS_PER_DAY_FORECAST); avgNeededPerDay = MIN_HOURS_PER_DAY_FORECAST; }
                    const daysSuffix = t(daysToWork === 1 ? 'dashboard.forecastSuffixDaysSingular' : 'dashboard.forecastSuffixDaysPlural');
                    const suggestion = `${t('dashboard.attemptPrefix')}<strong>${formatHoursExtensive(avgNeededPerDay, true)}</strong> ${t('dashboard.perDay')} ${daysToWork} ${daysSuffix}.`;
                    forecastText = `<span>${t('dashboard.forecastPrefix')} ${formatHoursExtensive(remainingHoursNeeded)}.</span><span>${suggestion}</span>`;
                }
                const forecastSpan = document.querySelector('#dashboard-summary #dashboard-forecast');
                if (forecastSpan) forecastSpan.innerHTML = forecastText;

                // Update Dashboard Revisit List
                const pendingRevisits = revisits.filter(rv => rv.status === 'pending')
                    .sort((a, b) => {
                        const aHasFutureDate = a.scheduledDate && a.scheduledDate >= todayStr; const bHasFutureDate = b.scheduledDate && b.scheduledDate >= todayStr;
                        if (aHasFutureDate && bHasFutureDate) return a.scheduledDate.localeCompare(b.scheduledDate);
                        if (aHasFutureDate) return -1; if (bHasFutureDate) return 1;
                        if (a.scheduledDate && !b.scheduledDate) return -1; if (!a.scheduledDate && b.scheduledDate) return 1;
                        return (a.dateAdded || '').localeCompare(b.dateAdded || '');
                    });
                const displayRevisits = pendingRevisits.slice(0, DASHBOARD_REVISIT_LIMIT);

                if (dashboardRevisitList) dashboardRevisitList.innerHTML = ''; // Clear previous list
                if (displayRevisits.length > 0) {
                    dashboardRevisitsSection?.classList.remove('hidden');
                    const fragment = document.createDocumentFragment();
                    displayRevisits.forEach(rv => {
                        const li = document.createElement('li');
                        const datePart = rv.scheduledDate ? `<span class="revisit-date">${formatRelativeDate(rv.scheduledDate)}:</span> ` : '';
                        li.innerHTML = `${datePart}<span class="revisit-name">${rv.name}</span>`;
                        fragment.appendChild(li);
                    });
                    dashboardRevisitList.appendChild(fragment);
                } else {
                    dashboardRevisitsSection?.classList.add('hidden');
                }
            };
            const updateDashboardPlannedDates = () => {
                const todayStr = getCurrentDateString();
                const upcomingPlans = plannedEntries.filter(p => p.date >= todayStr).sort((a, b) => a.date.localeCompare(b.date)).slice(0, 3);

                if (dashboardPlanList) dashboardPlanList.innerHTML = ''; // Clear previous list
                if (upcomingPlans.length > 0) {
                    dashboardPlannedDatesContainer?.classList.remove('hidden');
                    const fragment = document.createDocumentFragment();
                    upcomingPlans.forEach(p => {
                        const li = document.createElement('li');
                        li.innerHTML = `<strong>${formatRelativeDate(p.date)}:</strong> ${formatHoursExtensive(p.hours, true)}`;
                        fragment.appendChild(li);
                    });
                    dashboardPlanList.appendChild(fragment);
                } else {
                    dashboardPlannedDatesContainer?.classList.add('hidden');
                }
            };

            // --- Rendering Functions ---
            // OPTIMIZED: Helper to create list item structure
            const createListItem = (detailsHtml, actionsHtml, id) => {
                const li = document.createElement('li');
                if (id) li.dataset.id = id;
                li.innerHTML = `${detailsHtml}${actionsHtml}`;
                return li;
            };

            const renderHistory = () => {
                if (!historyList) return;
                historyList.innerHTML = ''; // Clear list
                const searchTerm = historySearchInput?.value.trim().toLowerCase() || '';
                const hasSearch = searchTerm.length > 0;
                const allHistoryItems = recordedEntries; // Already sorted by loadData

                let results, labelText;
                if (hasSearch) {
                    results = allHistoryItems.filter(e => {
                        const isRevisit = e.type === 'revisit_completed';
                        const tagInternal = isRevisit ? t('historyCard.revisitCompletedTag') : (e.tag || DEFAULT_TAG_VALUE);
                        const tagTranslated = isRevisit ? tagInternal.toLowerCase() : t(tagKeyMapping[tagInternal] || 'tags.noTag').toLowerCase();
                        const formattedDate = formatDisplayDate(e.date).toLowerCase();
                        const hoursStr = isRevisit ? '' : (e.hours || 0).toString().replace('.', ',');
                        const hoursRoundedStr = isRevisit ? '' : Math.round(e.hours || 0).toString();
                        const hoursFormatted = isRevisit ? '' : formatHoursExtensive(e.hours).toLowerCase();
                        const notes = (e.notes || '').toLowerCase();
                        return formattedDate.includes(searchTerm) ||
                               (!isRevisit && (hoursStr.includes(searchTerm) || hoursRoundedStr.includes(searchTerm) || hoursFormatted.includes(searchTerm))) ||
                               tagTranslated.includes(searchTerm) || notes.includes(searchTerm) || tagInternal.toLowerCase().includes(searchTerm);
                    });
                    const countKey = results.length === 1 ? 'historyCard.resultsCountForTermSingular' : 'historyCard.resultsCountForTermPlural';
                    labelText = t(countKey, { count: results.length, term: searchTerm });
                } else {
                    const dateLimitStr = getDateMonthsAgo(HISTORY_MONTH_LIMIT);
                    results = allHistoryItems.filter(e => e.date >= dateLimitStr);
                    if (allHistoryItems.length === 0) labelText = t('historyCard.listPlaceholderNoRecords');
                    else if (results.length === 0) labelText = t('historyCard.noRecordsLastMonths', { limit: HISTORY_MONTH_LIMIT });
                    else labelText = t('historyCard.showingLastMonths', { limit: HISTORY_MONTH_LIMIT });
                }

                if (showingResultsLabel) showingResultsLabel.textContent = labelText;

                if (results.length === 0) {
                    let placeholderKey = 'historyCard.listPlaceholderNoRecords';
                    if (allHistoryItems.length > 0) placeholderKey = hasSearch ? 'historyCard.listPlaceholderNoSearchResults' : 'historyCard.listPlaceholderNoRecent';
                    if (historyListPlaceholder) { historyListPlaceholder.textContent = t(placeholderKey); historyListPlaceholder.classList.remove('hidden'); }
                } else {
                    historyListPlaceholder?.classList.add('hidden');
                    const fragment = document.createDocumentFragment();
                    results.forEach(e => {
                        const isRevisit = e.type === 'revisit_completed';
                        let detailsHtml, actionsHtml;
                        if (isRevisit) {
                            const revisitMarker = `<span class="revisit-completed-marker">${t('historyCard.revisitCompletedMarker')}</span>`;
                            const notesLines = (e.notes || '').split('\n');
                            let notesDisplay = notesLines[0] || '';
                            if (notesLines.length > 1) notesDisplay += ` (${t('historyCard.originalNotesPreviewSuffix')}...)`;
                            const notesPreview = e.notes ? `<span class="notes-preview">${notesDisplay}</span>` : `<span class="notes-preview" style="opacity:0.5;">${t('historyCard.noNotes')}</span>`;
                            detailsHtml = `<div class="entry-details">${revisitMarker}<strong>${formatDisplayDate(e.date)}:</strong> ${notesPreview}</div>`;
                            actionsHtml = '<div class="entry-actions"></div>'; // No actions for completed revisits in history
                        } else {
                            const tagInternal = e.tag || DEFAULT_TAG_VALUE;
                            const tagText = t(tagKeyMapping[tagInternal] || 'tags.noTag');
                            const tagBadge = `<span class="tag-badge" ${tagInternal === DEFAULT_TAG_VALUE ? 'style="opacity:0.6;"' : ''}>${tagText}</span>`;
                            const notesPreview = e.notes ? `<span class="notes-preview">${e.notes.replace(/\n/g, ' ')}</span>` : `<span class="notes-preview" style="opacity:0.5;">${t('historyCard.noNotes')}</span>`;
                            const hoursFormatted = formatHoursExtensive(e.hours);
                            detailsHtml = `<div class="entry-details"><strong>${formatDisplayDate(e.date)}:</strong> <span class="hours">${hoursFormatted}</span> ${tagBadge} ${notesPreview}</div>`;
                            // OPTIMIZED: Added data-action attributes for delegation
                            actionsHtml = `<div class="entry-actions"><button class="secondary" data-action="edit">${t('common.editButton')}</button> <button class="danger" data-action="delete">${t('common.deleteButton')}</button></div>`;
                        }
                        fragment.appendChild(createListItem(detailsHtml, actionsHtml, e.id));
                    });
                    historyList.appendChild(fragment);
                }
            };
            const renderPlanning = () => {
                if (!planningList) return;
                planningList.innerHTML = ''; // Clear list
                const todayStr = getCurrentDateString();
                const allPlans = [...plannedEntries]; // Already sorted by loadData

                if (allPlans.length === 0) {
                    if (planningListPlaceholder) { planningListPlaceholder.textContent = t('planCard.listPlaceholderNoPastOrFuture'); planningListPlaceholder.classList.remove('hidden'); }
                    return;
                }
                planningListPlaceholder?.classList.add('hidden');
                const fragment = document.createDocumentFragment();
                allPlans.forEach(p => {
                    const hoursDisplay = formatHoursExtensive(p.hours);
                    const isPast = p.date < todayStr;
                    const pastDateSuffix = isPast ? `<span style="opacity:0.7;margin-left:5px;">(${t('planCard.pastDateSuffix')})</span>` : '';
                    const detailsHtml = `<div class="entry-details"><strong>${formatDisplayDate(p.date)} (${formatRelativeDate(p.date)}):</strong> <span class="hours">${hoursDisplay}</span> ${pastDateSuffix}</div>`;
                    // OPTIMIZED: Added data-action attributes for delegation
                    const actionsHtml = `<div class="plan-actions"><button class="success" data-action="done">${t('planCard.markDoneButton')}</button> <button class="danger" data-action="delete">${t('common.deleteButton')}</button></div>`;
                    fragment.appendChild(createListItem(detailsHtml, actionsHtml, p.id));
                });
                planningList.appendChild(fragment);
            };
            const renderRevisits = () => {
                if (!revisitList) return;
                revisitList.innerHTML = ''; // Clear list
                const pendingRevisits = revisits.filter(rv => rv.status === 'pending'); // Already sorted by loadData/handleRevisitSubmit

                if (pendingRevisits.length === 0) {
                    if (revisitListPlaceholder) { revisitListPlaceholder.textContent = t('revisitCard.listPlaceholderNoPending'); revisitListPlaceholder.classList.remove('hidden'); }
                    return;
                }
                revisitListPlaceholder?.classList.add('hidden');
                const fragment = document.createDocumentFragment();
                pendingRevisits.forEach(rv => {
                    const notesPreview = rv.notes ? `<span class="notes-preview">${rv.notes.replace(/\n/g, ' ')}</span>` : `<span class="notes-preview" style="opacity:0.5;">${t('revisitCard.noNotes')}</span>`;
                    const scheduledDateHtml = rv.scheduledDate ? `<span class="revisit-scheduled-date">(${t('revisitCard.scheduledForLabel')} <strong>${formatRelativeDate(rv.scheduledDate)}</strong>)</span>` : '';
                    const detailsHtml = `<div class="entry-details"><strong>${rv.name}</strong>${scheduledDateHtml}${notesPreview}</div>`;
                    // OPTIMIZED: Added data-action attributes for delegation
                    const actionsHtml = `<div class="revisit-actions"><button class="success" data-action="complete">${t('revisitCard.markCompleteButton')}</button><button class="danger" data-action="delete">${t('common.deleteButton')}</button></div>`;
                    fragment.appendChild(createListItem(detailsHtml, actionsHtml, rv.id));
                });
                revisitList.appendChild(fragment);
            };
            const updateStatistics = () => {
                const today = new Date(); const currentMonth = today.getMonth(); const currentYear = today.getFullYear();
                let totalHoursMonth = 0; const activeDays = new Set();
                recordedEntries.forEach(e => {
                    if (e.type !== 'revisit_completed') {
                        const d = parseLocalDate(e.date);
                        if (!isNaN(d.valueOf()) && d.getMonth() === currentMonth && d.getFullYear() === currentYear) {
                            totalHoursMonth += e.hours; activeDays.add(e.date);
                        }
                    }
                });
                const goal = settings.monthlyGoal || 70;
                const percentProgress = settings.goalHasBeenSet ? (goal > 0 ? Math.min(Math.round((totalHoursMonth / goal) * 100), 100) : 0) : 0;
                const daysActiveCount = activeDays.size;
                const avgHoursPerActiveDay = daysActiveCount > 0 ? (totalHoursMonth / daysActiveCount) : 0;
                if (statsMonthHours) statsMonthHours.textContent = formatHoursExtensive(totalHoursMonth);
                if (statsMonthGoalProgress) statsMonthGoalProgress.textContent = settings.goalHasBeenSet ? `${percentProgress}%` : '--%';
                if (statsMonthProgressBar) statsMonthProgressBar.style.width = `${percentProgress}%`;
                if (statsAvgHoursDay) statsAvgHoursDay.textContent = formatHoursExtensive(avgHoursPerActiveDay);
                if (statsMonthDaysActive) statsMonthDaysActive.textContent = daysActiveCount;
            };
            const populateMonthSelector = () => {
                if (!chartMonthSelector) return;
                const availableMonths = [...new Set(recordedEntries.filter(e => e.type !== 'revisit_completed' && e.date).map(e => getMonthYearString(parseLocalDate(e.date))))]
                    .sort((a, b) => { const [mA, yA] = a.split('/').map(Number); const [mB, yB] = b.split('/').map(Number); return (yB - yA) || (mB - mA); });

                const oldSelectedValue = chartMonthSelector.value;
                chartMonthSelector.innerHTML = ''; // Clear options

                if (availableMonths.length === 0) {
                    chartMonthSelector.innerHTML = `<option value="">${t('chartsCard.noDataOption')}</option>`;
                    chartMonthSelector.disabled = true; return;
                }

                chartMonthSelector.disabled = false;
                const currentMonthStr = getMonthYearString(new Date());
                const currentMonthFormatted = formatMonthYearExtensive(currentMonthStr);
                let hasCurrentMonthData = availableMonths.includes(currentMonthStr);
                let optionsHtml = '';
                let didSelectOldValue = false;

                // Add current month option if not already in data and needed
                if (!hasCurrentMonthData && currentMonthFormatted && Array.isArray(MONTH_NAMES) && MONTH_NAMES.length > 0) {
                    optionsHtml += `<option value="${currentMonthStr}">${currentMonthFormatted} (${t('chartsCard.currentMonthSuffix')})</option>`;
                }

                availableMonths.forEach(monthYearValue => {
                    const monthFormatted = formatMonthYearExtensive(monthYearValue);
                    const selected = monthYearValue === oldSelectedValue || (!oldSelectedValue && monthYearValue === currentMonthStr);
                    if (selected) didSelectOldValue = true; // Track if the old value or current month was selected
                    optionsHtml += `<option value="${monthYearValue}" ${selected ? 'selected' : ''}>${monthFormatted || monthYearValue}</option>`;
                });

                chartMonthSelector.innerHTML = optionsHtml;

                // Ensure something is selected if the old value wasn't found
                if (!chartMonthSelector.value && chartMonthSelector.options.length > 0) {
                    chartMonthSelector.options[0].selected = true;
                }
            };
            const renderCharts = (selectedMonthYear) => {
                if (monthlyHoursChartInstance) { monthlyHoursChartInstance.destroy(); monthlyHoursChartInstance = null; }
                if (!selectedMonthYear || selectedMonthYear === '') { clearChartWithMessage(t('chartsCard.selectMonthMessage')); return; }

                try {
                    const [selectedMonth, selectedYear] = selectedMonthYear.split('/').map(Number);
                    const monthIndex = selectedMonth - 1;
                    const entriesForMonth = recordedEntries.filter(e => e.type !== 'revisit_completed' && e.date && parseLocalDate(e.date).getMonth() === monthIndex && parseLocalDate(e.date).getFullYear() === selectedYear);

                    if (entriesForMonth.length === 0) { clearChartWithMessage(t('chartsCard.noRecordsInMonthMessage', { month: formatMonthYearExtensive(selectedMonthYear) })); return; }

                    let totalHours = 0;
                    const hoursByTag = entriesForMonth.reduce((acc, e) => {
                        const tagName = e.tag || DEFAULT_TAG_VALUE;
                        const hours = e.hours || 0;
                        totalHours += hours;
                        acc[tagName] = (acc[tagName] || 0) + hours;
                        return acc;
                    }, {});

                    if (chartTotalHoursDisplay) chartTotalHoursDisplay.innerHTML = `${t('chartsCard.totalHoursLabel')} <strong>${formatHoursExtensive(totalHours)}</strong>`;

                    const aggregatedData = Object.entries(hoursByTag).map(([tag, hours]) => ({ label: t(tagKeyMapping[tag] || 'tags.noTag'), value: hours })).sort((a, b) => b.value - a.value);
                    const labels = aggregatedData.map(item => item.label);
                    const values = aggregatedData.map(item => item.value);
                    const backgroundColors = labels.map((_, i) => chartColors[i % chartColors.length]);

                    if (!monthlyHoursChartCtx) return;
                    monthlyHoursChartInstance = new Chart(monthlyHoursChartCtx, {
                        type: 'pie',
                        data: { labels, datasets: [{ data: values, backgroundColor: backgroundColors, borderColor: tooltipBgColor || '#1c1c1e', borderWidth: 1.5 }] },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                title: { display: true, text: t('chartsCard.percentageDistributionTitle'), color: textMutedColor, font: { size: 12, weight: 'normal' }, padding: { bottom: 15 } },
                                tooltip: { backgroundColor: tooltipBgColor, titleColor: textColor, bodyColor: textColor, displayColors: true, padding: 10, cornerRadius: 6, callbacks: { label: ctx => `${ctx.label || ''}: ${formatHoursExtensive(ctx.parsed || 0)} (${totalHours > 0 ? ((ctx.parsed / totalHours) * 100).toFixed(1) : 0}%)` } },
                                legend: { position: 'bottom', align: 'center', labels: { color: textMutedColor, boxWidth: 12, padding: 15 } }
                            }
                        }
                    });
                } catch (e) { console.error("Chart render error:", e); clearChartWithMessage(t('chartsCard.renderErrorMessage')); }
            };
            const clearChartWithMessage = (msg) => {
                if (monthlyHoursChartInstance) { monthlyHoursChartInstance.destroy(); monthlyHoursChartInstance = null; }
                if (chartTotalHoursDisplay) chartTotalHoursDisplay.textContent = '';
                const ctx = monthlyHoursChartCtx;
                if (ctx) {
                    ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                    ctx.save(); ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = textMutedColor; ctx.font = `14px ${computedStyles?.fontFamily || 'sans-serif'}`; ctx.fillText(msg, ctx.canvas.width / 2, ctx.canvas.height / 2); ctx.restore();
                }
            };

            // --- Main Update Function ---
            const updateAllDisplays = () => {
                if (typeof t !== 'function' || !translations?.[currentLang]) { console.warn("Translations not ready, skipping update."); return; }
                try {
                    applyStaticTranslations();
                    updateDashboard();
                    updateDashboardPlannedDates();
                    updateStatistics();
                    renderHistory();
                    renderPlanning();
                    renderRevisits();
                    populateMonthSelector();

                    const selVal = chartMonthSelector?.value;
                    if (!chartMonthSelector?.disabled && selVal) renderCharts(selVal);
                    else if (!chartMonthSelector?.disabled && chartMonthSelector?.options?.length > 0 && chartMonthSelector.options[0]?.value) { chartMonthSelector.options[0].selected = true; renderCharts(chartMonthSelector.options[0].value); }
                    else clearChartWithMessage(t(recordedEntries.length === 0 ? 'chartsCard.noDataYetMessage' : 'chartsCard.selectMonthMessage'));

                    if(plansSection) {
                        const isRevisitsVisible = !dashboardRevisitsSection?.classList.contains('hidden');
                        const isPlannedVisible = !dashboardPlannedDatesContainer?.classList.contains('hidden');
                        plansSection.classList.toggle('hidden', !(isRevisitsVisible || isPlannedVisible));
                    }
                } catch (err) { console.error("Error during updateAllDisplays:", err); }
            };

            // --- Input Formatting ---
            const formatTimeInputOnType = (event) => {
                const input = event.target; let value = input.value; let originalPosition = input.selectionStart;
                let numericValue = value.replace(/[^\d]/g, '').substring(0, 4); let formattedValue = numericValue; let cursorAdjust = false;
                if (numericValue.length === 3) { formattedValue = `${numericValue.substring(0, 1)}:${numericValue.substring(1)}`; if (value.indexOf(':') === -1 && originalPosition >= 1) cursorAdjust = true; }
                else if (numericValue.length >= 4) { formattedValue = `${numericValue.substring(0, numericValue.length - 2)}:${numericValue.substring(numericValue.length - 2)}`; if (value.indexOf(':') === -1 && originalPosition >= formattedValue.indexOf(':') ) cursorAdjust = true; }
                if (input.value !== formattedValue) {
                    input.value = formattedValue; let newPosition = originalPosition; if (cursorAdjust) newPosition++;
                    newPosition = Math.min(newPosition, formattedValue.length);
                    requestAnimationFrame(() => { try { input.setSelectionRange(newPosition, newPosition); } catch (e) {} });
                }
            };
            const validateTimeOnBlur = (event) => { const d = parseTimeInputToDecimal(event.target.value); if (!isNaN(d) && d >= 0) event.target.value = formatDecimalToTimeInput(d); else if (event.target.value.trim() !== '') event.target.value = ''; };
            const limitTextLength = (event, maxLength) => { if (event.target.value.length > maxLength) { event.target.value = event.target.value.substring(0, maxLength); showFeedback('feedback.notesLengthLimit', 'info', { maxLength }); } };

            // --- Service Worker ---
            const registerServiceWorker = () => { if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').then(r => console.log('SW registered:', r.scope)).catch(e => console.error('SW reg failed:', e)); }); navigator.serviceWorker.addEventListener('controllerchange', () => { console.log('SW controller changed.'); }); } };

            // --- Date Check ---
            const checkDateAndUpdate = () => { const newDateString = getCurrentDateString(); if (newDateString !== lastCheckedDateString) { lastCheckedDateString = newDateString; updateAllDisplays(); } };

            // --- Event Handlers Setup ---
            const setupEventListeners = () => {
                // Card Toggles
                appElement?.addEventListener('click', (e) => { const h = e.target.closest('.card-header'); if (h) toggleCard(h.closest('.card')); });
                document.querySelectorAll('.card-header').forEach(h => { h.setAttribute('role', 'button'); h.setAttribute('tabindex', '0'); h.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleCard(h.closest('.card')); } }); });

                // Record Form
                changeDateBtn?.addEventListener('click', () => setDateInputVisibility(true));
                recordHoursInput?.addEventListener('input', formatTimeInputOnType);
                recordHoursInput?.addEventListener('blur', validateTimeOnBlur);
                recordNotesInput?.addEventListener('input', (e) => limitTextLength(e, NOTES_MAX_LENGTH));
                recordForm?.addEventListener('submit', handleRecordSubmit);

                // Plan Form
                planHoursInput?.addEventListener('input', formatTimeInputOnType);
                planHoursInput?.addEventListener('blur', validateTimeOnBlur);
                planForm?.addEventListener('submit', handlePlanSubmit);
                clearPlanFormBtn?.addEventListener('click', clearPlanForm);

                // Revisit Form
                revisitNotesInput?.addEventListener('input', (e) => limitTextLength(e, REVISIT_NOTES_MAX_LENGTH));
                revisitForm?.addEventListener('submit', handleRevisitSubmit);
                clearRevisitFormBtn?.addEventListener('click', clearRevisitForm);

                // Settings & Stats
                saveGoalBtn?.addEventListener('click', handleGoalSave);
                monthlyGoalInput?.addEventListener('keypress', e => { if (e.key === 'Enter') { e.preventDefault(); handleGoalSave(); e.target.blur(); } });
                clearAllDataBtn?.addEventListener('click', handleClearAllData);

                // Charts
                chartMonthSelector?.addEventListener('change', (e) => renderCharts(e.target.value));

                // History
                historySearchInput?.addEventListener('input', renderHistory);

                // Dialog
                dialogConfirmBtn?.addEventListener('click', () => { if (typeof currentConfirmCallback === 'function') currentConfirmCallback(); hideConfirmationDialog(); });
                dialogCancelBtn?.addEventListener('click', hideConfirmationDialog);
                confirmationDialog?.addEventListener('click', e => { if (e.target === confirmationDialog) hideConfirmationDialog(); });

                // Install Prompt
                window.addEventListener('beforeinstallprompt', e => { e.preventDefault(); deferredInstallPrompt = e; console.log('Install prompt event captured.'); });

                // OPTIMIZED: Event Delegation for Lists
                const handleListAction = (event, listType) => {
                    const button = event.target.closest('button[data-action]');
                    if (!button) return;
                    const action = button.dataset.action;
                    const listItem = button.closest('li[data-id]');
                    const id = listItem ? parseInt(listItem.dataset.id, 10) : null;
                    if (!id) return;

                    event.stopPropagation(); // Prevent card toggle if clicking button inside header

                    switch (listType) {
                        case 'history':
                            if (action === 'edit') editRecordEntry(id);
                            else if (action === 'delete') deleteRecordEntry(id);
                            break;
                        case 'planning':
                            if (action === 'done') markPlanAsDone(id);
                            else if (action === 'delete') deletePlanEntry(id);
                            break;
                        case 'revisit':
                            if (action === 'complete') markRevisitComplete(id);
                            else if (action === 'delete') deleteRevisit(id);
                            break;
                    }
                };

                historyList?.addEventListener('click', (e) => handleListAction(e, 'history'));
                planningList?.addEventListener('click', (e) => handleListAction(e, 'planning'));
                revisitList?.addEventListener('click', (e) => handleListAction(e, 'revisit'));
            };

            // --- App Initialization Sequence ---
            await loadTranslations();
            selectDOMElements();
            loadData();
            applyStaticTranslations(); // Apply initial translations

            if (monthlyGoalInput) monthlyGoalInput.value = settings.monthlyGoal;
            if (recordDateInput) recordDateInput.value = getCurrentDateString();
            lastCheckedDateString = getCurrentDateString();
            setDateInputVisibility(false);
            clearRecordForm(); clearPlanForm(); clearRevisitForm();

            // Set initial card states
            document.querySelectorAll('.card').forEach(card => {
                const shouldBeExpanded = (card.id === 'record-card');
                card.classList.toggle('expanded', shouldBeExpanded);
                const icon = card.querySelector('.toggle-icon');
                if (icon) icon.textContent = shouldBeExpanded ? '▲' : '▼';
            });

            setupEventListeners(); // Setup all listeners

            // Start periodic check
            if (dateCheckInterval) clearInterval(dateCheckInterval);
            dateCheckInterval = setInterval(checkDateAndUpdate, 60 * 1000);

            updateAllDisplays(); // Initial full display update
            registerServiceWorker();

            // Prompt for goal if not set
            if (!settings.goalHasBeenSet && !document.querySelector('.dialog-backdrop.visible')) {
                setTimeout(promptForMonthlyGoal, 600);
            }

            if (loadingIndicator) loadingIndicator.classList.add('hidden');
            console.log("App init complete.");

        })(); // End of async IIFE
    </script>
</body>
</html>
