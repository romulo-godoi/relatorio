<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro de Campo Pioneiro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #6d97b8; /* Azul Suave */
            --secondary-color: #f7f9fc; /* Branco Neve */
            --accent-color: #82c0aa; /* Verde Menta Suave */
            --text-color: #333;
            --card-bg: #ffffff;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --placeholder-color: #aaa;
            --input-border-color: #ddd;

            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 12px;
            --card-padding: 20px;
            --transition-speed: 0.3s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html, body {
            height: 100%;
            -webkit-tap-highlight-color: transparent; /* Remove highlight azul no toque em mobile Chrome */
        }

        body {
            font-family: var(--font-family);
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 15px;
            overscroll-behavior-y: contain; /* Previne pull-to-refresh indesejado */
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app {
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        h1, h2 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: var(--card-padding);
            box-shadow: 0 4px 12px var(--shadow-color);
            opacity: 0;
            transform: translateY(20px);
            animation: fadeInUp var(--transition-speed) ease-out forwards;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }

        .card:hover {
           transform: translateY(-3px);
           box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        }

        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Aplica atraso na anima√ß√£o para efeito cascata */
        .card:nth-child(1) { animation-delay: 0.05s; }
        .card:nth-child(2) { animation-delay: 0.1s; }
        .card:nth-child(3) { animation-delay: 0.15s; }
        .card:nth-child(4) { animation-delay: 0.2s; }
        .card:nth-child(5) { animation-delay: 0.25s; }
        .card:nth-child(6) { animation-delay: 0.3s; }


        .form-group {
            margin-bottom: 18px;
        }

        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: var(--primary-color);
            font-size: 0.95em;
        }

        input[type="date"],
        input[type="number"],
        input[type="text"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--input-border-color);
            border-radius: 8px;
            font-size: 1em;
            font-family: var(--font-family);
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            appearance: none; /* Remove default styles on iOS */
            -webkit-appearance: none;
            -moz-appearance: none;
            background-color: #fff; /* Ensure background color on iOS */
        }

        input::placeholder,
        textarea::placeholder {
            color: var(--placeholder-color);
            opacity: 1; /* Firefox */
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(109, 151, 184, 0.3); /* Outline suave */
        }

        /* Specific styles for number inputs */
        input[type="number"] {
             -moz-appearance: textfield; /* Firefox */
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        textarea {
            resize: vertical;
            min-height: 80px;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color var(--transition-speed) ease, transform var(--transition-speed) ease;
            display: inline-block; /* Align multiple buttons */
            margin-right: 10px; /* Space between buttons */
            margin-top: 10px;
            width: calc(50% - 5px); /* Two buttons per line on small screens */
        }
        @media (min-width: 600px) {
             button {
                 width: auto; /* Auto width on larger screens */
             }
        }


        button:last-child {
            margin-right: 0;
        }

        button:hover {
            background-color: #577e9e; /* Darker shade of primary */
            transform: translateY(-2px);
        }

        button:active {
           transform: translateY(0px);
        }

        button.secondary {
             background-color: var(--accent-color);
        }
        button.secondary:hover {
             background-color: #6aa995; /* Darker accent */
        }

        button.danger {
            background-color: var(--danger-color);
        }
        button.danger:hover {
            background-color: #c0392b; /* Darker danger */
        }


        /* Statistics Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            text-align: center;
        }

        .stat-item {
            background-color: var(--secondary-color);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--input-border-color);
        }

        .stat-value {
            font-size: 1.6em;
            font-weight: 600;
            color: var(--primary-color);
            display: block;
        }

        .stat-label {
            font-size: 0.9em;
            color: #555;
        }

        .progress-bar-container {
            background-color: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
            height: 15px;
            margin-top: 5px;
        }

        .progress-bar {
            background-color: var(--accent-color);
            height: 100%;
            width: 0; /* Set by JS */
            transition: width var(--transition-speed) ease-out;
            text-align: center;
            color: white;
            font-size: 0.7em;
            line-height: 15px;
        }


        /* History & Planning List Styles */
        .data-list {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
             border: 1px solid var(--input-border-color);
             border-radius: 8px;
             padding: 10px;
        }

        .data-list li {
            background-color: #fdfdfd;
            border-bottom: 1px solid var(--input-border-color);
            padding: 12px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            transition: background-color var(--transition-speed) ease;
        }
        .data-list li:last-child {
            border-bottom: none;
        }
        .data-list li:hover {
             background-color: var(--secondary-color);
        }

        .entry-details {
            font-size: 0.95em;
            flex-grow: 1;
            margin-right: 10px; /* Space before buttons */
        }
         .entry-details strong {
              color: var(--primary-color);
         }
         .entry-details span {
              color: #555;
              margin: 0 3px; /* spacing */
         }

        .entry-actions button,
        .plan-actions button {
            padding: 5px 8px;
            font-size: 0.8em;
            margin-left: 5px;
            margin-top: 5px; /* Stack buttons below text on very small screens */
            width: auto; /* override button default width */
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 280px; /* Adjust as needed */
            width: 100%;
            margin-top: 20px;
        }

        /* Confirmation Dialog */
        .dialog-backdrop {
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background-color: rgba(0,0,0,0.5);
             display: flex;
             justify-content: center;
             align-items: center;
             z-index: 1000;
             opacity: 0;
             visibility: hidden;
             transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease;
         }
         .dialog-backdrop.visible {
             opacity: 1;
             visibility: visible;
         }
         .dialog-content {
             background-color: var(--card-bg);
             padding: 30px;
             border-radius: var(--border-radius);
             box-shadow: 0 5px 15px rgba(0,0,0,0.2);
             text-align: center;
             max-width: 90%;
             width: 350px;
              transform: scale(0.9);
              transition: transform var(--transition-speed) ease;
         }
          .dialog-backdrop.visible .dialog-content {
               transform: scale(1);
          }
         .dialog-content p {
              margin-bottom: 20px;
         }
         .dialog-actions button {
              width: calc(50% - 5px); /* Two buttons side-by-side */
              margin-top: 0; /* Reset top margin */
         }

        /* Helper Classes */
        .hidden {
            display: none;
        }
         .text-center {
             text-align: center;
         }
         .mt-1 { margin-top: 10px; }
         .mt-2 { margin-top: 20px; }

    </style>
</head>
<body>

    <div id="app">
        <h1>Registro de Campo</h1>

        <!-- Card: Registrar Atividade -->
        <div class="card" id="record-card">
            <h2>Registrar Atividade</h2>
            <form id="record-form">
                <input type="hidden" id="record-id"> <!-- Para edi√ß√£o -->
                <div class="form-group">
                    <label for="record-date">Data:</label>
                    <input type="date" id="record-date" required>
                </div>
                <div class="form-group">
                    <label for="record-hours">Horas (ex: 1.5 para 1h 30m):</label>
                    <input type="number" id="record-hours" step="0.25" min="0" required placeholder="Ex: 2.5">
                </div>
                 <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label for="record-placements">Pubs:</label>
                        <input type="number" id="record-placements" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label for="record-videos">V√≠deos:</label>
                        <input type="number" id="record-videos" min="0" value="0">
                    </div>
                     <div class="form-group">
                        <label for="record-rv">Revisitas:</label>
                        <input type="number" id="record-rv" min="0" value="0">
                    </div>
                     <div class="form-group">
                        <label for="record-studies">Estudos:</label>
                        <input type="number" id="record-studies" min="0" value="0">
                    </div>
                 </div>
                <div class="form-group">
                    <label for="record-notes">Notas (Opcional):</label>
                    <textarea id="record-notes" rows="2" placeholder="Ex: Revisita com Jo√£o, mostrou v√≠deo..."></textarea>
                </div>
                 <div class="text-center">
                    <button type="submit" id="save-record-btn">Salvar Registro</button>
                    <button type="button" id="clear-record-form-btn" class="secondary">Limpar Formul√°rio</button>
                 </div>
            </form>
        </div>

         <!-- Card: Planejar Atividade -->
         <div class="card" id="plan-card">
             <h2>Planejar Horas Futuras</h2>
             <form id="plan-form">
                  <input type="hidden" id="plan-id"> <!-- Para edi√ß√£o -->
                 <div class="form-group">
                     <label for="plan-date">Data Futura:</label>
                     <input type="date" id="plan-date" required>
                 </div>
                 <div class="form-group">
                     <label for="plan-hours">Horas Planejadas:</label>
                     <input type="number" id="plan-hours" step="0.25" min="0.25" required placeholder="Ex: 3">
                 </div>
                 <div class="text-center">
                    <button type="submit" id="save-plan-btn">Adicionar Plano</button>
                     <button type="button" id="clear-plan-form-btn" class="secondary">Limpar</button>
                </div>
             </form>
              <div id="planning-list-container" class="mt-2">
                  <h3>Planejamento Futuro:</h3>
                   <ul id="planning-list" class="data-list">
                        <!-- Planning items will be loaded here by JS -->
                        <li class="placeholder hidden">Nenhum planejamento futuro encontrado.</li>
                   </ul>
               </div>
         </div>

        <!-- Card: Estat√≠sticas e Progresso -->
        <div class="card" id="stats-card">
            <h2>Resumo do M√™s Atual</h2>
             <div class="form-group" style="max-width: 200px; margin: 0 auto 20px auto; text-align:center;">
                 <label for="monthly-goal">Meta Mensal de Horas:</label>
                 <input type="number" id="monthly-goal" min="1" step="1" value="70">
                 <button id="save-goal-btn" class="mt-1 secondary" style="width:100%; font-size:0.9em; padding: 8px 10px;">Salvar Meta</button>
             </div>
            <div class="stats-grid">
                <div class="stat-item">
                    <span id="stats-month-hours" class="stat-value">0</span>
                    <span class="stat-label">Horas no M√™s</span>
                </div>
                <div class="stat-item">
                    <span id="stats-month-goal-progress" class="stat-value">0%</span>
                    <span class="stat-label">Progresso da Meta</span>
                     <div class="progress-bar-container">
                         <div id="stats-month-progress-bar" class="progress-bar"></div>
                    </div>
                </div>
                <div class="stat-item">
                     <span id="stats-avg-hours-day" class="stat-value">0</span>
                     <span class="stat-label">M√©dia Horas/Dia</span>
                </div>
                 <div class="stat-item">
                     <span id="stats-month-placements" class="stat-value">0</span>
                     <span class="stat-label">Publica√ß√µes</span>
                 </div>
                 <div class="stat-item">
                     <span id="stats-month-videos" class="stat-value">0</span>
                     <span class="stat-label">V√≠deos</span>
                 </div>
                 <div class="stat-item">
                     <span id="stats-month-rv" class="stat-value">0</span>
                     <span class="stat-label">Revisitas</span>
                 </div>
                  <div class="stat-item">
                      <span id="stats-month-studies" class="stat-value">0</span>
                      <span class="stat-label">Estudos</span>
                  </div>
                  <div class="stat-item">
                       <span id="stats-month-days-active" class="stat-value">0</span>
                       <span class="stat-label">Dias Ativos</span>
                 </div>
            </div>
        </div>

        <!-- Card: Gr√°ficos -->
        <div class="card" id="charts-card">
            <h2>Visualiza√ß√£o Gr√°fica</h2>
             <div class="form-group">
                <label for="chart-month-selector">Visualizar M√™s:</label>
                <select id="chart-month-selector"></select>
            </div>
            <div class="chart-container">
                <canvas id="monthlyHoursChart"></canvas>
            </div>
             <div class="chart-container" style="height: 200px;"> <!-- Smaller height for pie chart -->
                <canvas id="activityTypeChart"></canvas>
            </div>
        </div>

        <!-- Card: Hist√≥rico Detalhado -->
        <div class="card" id="history-card">
            <h2>Hist√≥rico de Registros</h2>
            <ul id="history-list" class="data-list">
                <!-- History items will be loaded here by JS -->
                 <li class="placeholder hidden">Nenhum registro encontrado.</li>
            </ul>
        </div>

         <!-- Card: Configura√ß√µes -->
        <div class="card" id="settings-card">
             <h2>Configura√ß√µes</h2>
              <div class="text-center">
                  <button id="export-data-btn" class="secondary">Exportar Dados (JSON)</button>
                  <button id="clear-all-data-btn" class="danger">Limpar Todos os Dados</button>
              </div>
        </div>

    </div> <!-- /#app -->

     <!-- Confirmation Dialog Structure -->
     <div id="confirmation-dialog" class="dialog-backdrop">
         <div class="dialog-content">
              <p id="dialog-message">Voc√™ tem certeza?</p>
              <div class="dialog-actions">
                  <button id="dialog-confirm-btn" class="danger">Confirmar</button>
                  <button id="dialog-cancel-btn" class="secondary">Cancelar</button>
             </div>
          </div>
      </div>


    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Elements ---
            const recordForm = document.getElementById('record-form');
            const recordIdInput = document.getElementById('record-id');
            const recordDateInput = document.getElementById('record-date');
            const recordHoursInput = document.getElementById('record-hours');
            const recordPlacementsInput = document.getElementById('record-placements');
            const recordVideosInput = document.getElementById('record-videos');
            const recordRvInput = document.getElementById('record-rv');
            const recordStudiesInput = document.getElementById('record-studies');
            const recordNotesInput = document.getElementById('record-notes');
            const saveRecordBtn = document.getElementById('save-record-btn');
            const clearRecordFormBtn = document.getElementById('clear-record-form-btn');

            const planForm = document.getElementById('plan-form');
            const planIdInput = document.getElementById('plan-id');
            const planDateInput = document.getElementById('plan-date');
            const planHoursInput = document.getElementById('plan-hours');
            const savePlanBtn = document.getElementById('save-plan-btn');
             const clearPlanFormBtn = document.getElementById('clear-plan-form-btn');
            const planningList = document.getElementById('planning-list');
            const planningListPlaceholder = planningList.querySelector('.placeholder');


            const monthlyGoalInput = document.getElementById('monthly-goal');
             const saveGoalBtn = document.getElementById('save-goal-btn');
            const statsMonthHours = document.getElementById('stats-month-hours');
            const statsMonthGoalProgress = document.getElementById('stats-month-goal-progress');
            const statsMonthProgressBar = document.getElementById('stats-month-progress-bar');
             const statsAvgHoursDay = document.getElementById('stats-avg-hours-day');
             const statsMonthPlacements = document.getElementById('stats-month-placements');
             const statsMonthVideos = document.getElementById('stats-month-videos');
             const statsMonthRv = document.getElementById('stats-month-rv');
            const statsMonthStudies = document.getElementById('stats-month-studies');
             const statsMonthDaysActive = document.getElementById('stats-month-days-active');


             const chartMonthSelector = document.getElementById('chart-month-selector');
            const monthlyHoursChartCtx = document.getElementById('monthlyHoursChart').getContext('2d');
             const activityTypeChartCtx = document.getElementById('activityTypeChart').getContext('2d');

            const historyList = document.getElementById('history-list');
            const historyListPlaceholder = historyList.querySelector('.placeholder');

            const exportDataBtn = document.getElementById('export-data-btn');
             const clearAllDataBtn = document.getElementById('clear-all-data-btn');

             const confirmationDialog = document.getElementById('confirmation-dialog');
             const dialogMessage = document.getElementById('dialog-message');
             const dialogConfirmBtn = document.getElementById('dialog-confirm-btn');
             const dialogCancelBtn = document.getElementById('dialog-cancel-btn');


            // --- State & Data ---
            let recordedEntries = [];
            let plannedEntries = [];
             let settings = { monthlyGoal: 70 }; // Default goal
            let monthlyHoursChartInstance = null;
             let activityTypeChartInstance = null;
             let currentEditingId = null; // Track ID for edits
             let currentConfirmCallback = null; // Callback for confirmation dialog

            const LOCAL_STORAGE_KEYS = {
                ENTRIES: 'pioneerTracker_entries_v2',
                PLANS: 'pioneerTracker_plans_v1',
                SETTINGS: 'pioneerTracker_settings_v1'
            };

            // --- Functions ---

            // Data Handling
            function saveData() {
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEYS.ENTRIES, JSON.stringify(recordedEntries));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.PLANS, JSON.stringify(plannedEntries));
                    localStorage.setItem(LOCAL_STORAGE_KEYS.SETTINGS, JSON.stringify(settings));
                    console.log("Data saved to localStorage.");
                } catch (error) {
                    console.error("Error saving data to localStorage:", error);
                    alert("Erro ao salvar os dados. O armazenamento local pode estar cheio ou indispon√≠vel.");
                }
            }

            function loadData() {
                try {
                    const storedEntries = localStorage.getItem(LOCAL_STORAGE_KEYS.ENTRIES);
                    const storedPlans = localStorage.getItem(LOCAL_STORAGE_KEYS.PLANS);
                    const storedSettings = localStorage.getItem(LOCAL_STORAGE_KEYS.SETTINGS);

                    recordedEntries = storedEntries ? JSON.parse(storedEntries) : [];
                     // Sort entries by date descending initially
                    recordedEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

                    plannedEntries = storedPlans ? JSON.parse(storedPlans) : [];
                     // Sort plans by date ascending
                     plannedEntries.sort((a, b) => new Date(a.date) - new Date(b.date));

                    settings = storedSettings ? JSON.parse(storedSettings) : { monthlyGoal: 70 };
                    monthlyGoalInput.value = settings.monthlyGoal;
                    console.log("Data loaded from localStorage.");
                } catch (error) {
                    console.error("Error loading data from localStorage:", error);
                    recordedEntries = [];
                    plannedEntries = [];
                    settings = { monthlyGoal: 70 };
                    alert("Erro ao carregar os dados. Resetando para o padr√£o.");
                }
            }

             // Get Current Date (YYYY-MM-DD)
            function getCurrentDateString() {
                 const today = new Date();
                 const year = today.getFullYear();
                 const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                 const day = String(today.getDate()).padStart(2, '0');
                 return `${year}-${month}-${day}`;
            }
             // Format Date (DD/MM/YYYY)
             function formatDisplayDate(dateString) {
                if (!dateString || !dateString.includes('-')) return dateString;
                const [year, month, day] = dateString.split('-');
                return `${day}/${month}/${year}`;
            }
             // Get Month Year String (MM/YYYY)
            function getMonthYearString(date) {
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const year = date.getFullYear();
                return `${month}/${year}`;
             }

            // Record Form Handling
            function clearRecordForm() {
                recordForm.reset();
                recordIdInput.value = '';
                recordDateInput.value = getCurrentDateString(); // Reset date to today
                saveRecordBtn.textContent = 'Salvar Registro';
                 saveRecordBtn.classList.remove('editing'); // If you add styling for editing mode
                 currentEditingId = null;
             }

            function handleRecordSubmit(event) {
                event.preventDefault();
                const id = recordIdInput.value ? parseInt(recordIdInput.value, 10) : Date.now();
                const date = recordDateInput.value;
                 const hours = parseFloat(recordHoursInput.value) || 0;
                 const placements = parseInt(recordPlacementsInput.value, 10) || 0;
                 const videos = parseInt(recordVideosInput.value, 10) || 0;
                 const returnVisits = parseInt(recordRvInput.value, 10) || 0;
                 const studies = parseInt(recordStudiesInput.value, 10) || 0;
                const notes = recordNotesInput.value.trim();

                if (!date || hours <= 0) {
                    alert("Por favor, preencha a Data e as Horas (maior que zero).");
                    return;
                }

                const newEntry = { id, date, hours, placements, videos, returnVisits, studies, notes };

                const existingIndex = recordedEntries.findIndex(entry => entry.id === id);
                if (existingIndex > -1) {
                     // Editing existing entry
                    recordedEntries[existingIndex] = newEntry;
                } else {
                     // Adding new entry
                    recordedEntries.push(newEntry);
                }
                 // Re-sort entries after adding/editing
                 recordedEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

                saveData();
                clearRecordForm();
                renderHistory();
                renderPlanning(); // Planning might show completed status based on records
                updateAllStatsAndCharts();
                showFeedback('Registro salvo com sucesso!', 'success');
            }

             function editRecordEntry(id) {
                 const entry = recordedEntries.find(e => e.id === id);
                 if (entry) {
                     currentEditingId = id;
                     recordIdInput.value = entry.id;
                     recordDateInput.value = entry.date;
                     recordHoursInput.value = entry.hours;
                      recordPlacementsInput.value = entry.placements || 0;
                      recordVideosInput.value = entry.videos || 0;
                      recordRvInput.value = entry.returnVisits || 0;
                      recordStudiesInput.value = entry.studies || 0;
                     recordNotesInput.value = entry.notes || '';
                     saveRecordBtn.textContent = 'Atualizar Registro';
                      saveRecordBtn.classList.add('editing'); // Optional: Add styling
                      // Scroll to form for better UX
                      document.getElementById('record-card').scrollIntoView({ behavior: 'smooth' });
                      recordDateInput.focus(); // Focus on the first field
                 }
            }

             function deleteRecordEntry(id) {
                showConfirmationDialog(`Tem certeza que deseja excluir este registro? Esta a√ß√£o n√£o pode ser desfeita.`, () => {
                     recordedEntries = recordedEntries.filter(entry => entry.id !== id);
                    saveData();
                     renderHistory();
                    updateAllStatsAndCharts();
                    showFeedback('Registro exclu√≠do.', 'info');
                     // Clear form if the deleted entry was being edited
                    if (currentEditingId === id) {
                        clearRecordForm();
                     }
                });
             }

             // Planning Form Handling
             function clearPlanForm() {
                 planForm.reset();
                 planIdInput.value = '';
                 planDateInput.value = ''; // Clear date for new plan
                 savePlanBtn.textContent = 'Adicionar Plano';
                  currentEditingId = null;
             }

             function handlePlanSubmit(event) {
                event.preventDefault();
                 const id = planIdInput.value ? parseInt(planIdInput.value, 10) : Date.now();
                const date = planDateInput.value;
                 const plannedHours = parseFloat(planHoursInput.value);
                 const todayStr = getCurrentDateString();

                 if (!date || !plannedHours || plannedHours <= 0) {
                     alert("Por favor, preencha a Data Futura e as Horas Planejadas (maior que zero).");
                     return;
                 }
                 if (date < todayStr) {
                      alert("A data do planejamento deve ser hoje ou uma data futura.");
                      return;
                 }

                const newPlan = { id, date, plannedHours };

                 const existingIndex = plannedEntries.findIndex(plan => plan.id === id);
                if (existingIndex > -1) {
                     plannedEntries[existingIndex] = newPlan;
                } else {
                    plannedEntries.push(newPlan);
                 }
                 // Re-sort plans by date ascending
                 plannedEntries.sort((a, b) => new Date(a.date) - new Date(b.date));

                 saveData();
                 clearPlanForm();
                 renderPlanning();
                 showFeedback('Planejamento salvo!', 'success');
            }

             function editPlanEntry(id) {
                 const plan = plannedEntries.find(p => p.id === id);
                 if (plan) {
                     currentEditingId = id;
                     planIdInput.value = plan.id;
                     planDateInput.value = plan.date;
                     planHoursInput.value = plan.plannedHours;
                     savePlanBtn.textContent = 'Atualizar Plano';
                     document.getElementById('plan-card').scrollIntoView({ behavior: 'smooth' });
                     planDateInput.focus();
                 }
            }

            function deletePlanEntry(id) {
                showConfirmationDialog(`Tem certeza que deseja excluir este planejamento?`, () => {
                     plannedEntries = plannedEntries.filter(plan => plan.id !== id);
                     saveData();
                     renderPlanning();
                    showFeedback('Planejamento exclu√≠do.', 'info');
                    if (currentEditingId === id) {
                        clearPlanForm();
                    }
                });
             }


             // Settings Handling
             function handleGoalSave() {
                  const newGoal = parseInt(monthlyGoalInput.value, 10);
                 if (!isNaN(newGoal) && newGoal > 0) {
                      settings.monthlyGoal = newGoal;
                     saveData();
                     updateStatistics(); // Update stats immediately
                     showFeedback('Meta mensal atualizada!', 'success');
                 } else {
                     alert("Por favor, insira um n√∫mero v√°lido para a meta mensal.");
                      monthlyGoalInput.value = settings.monthlyGoal; // Revert to saved value
                 }
            }

             function handleClearAllData() {
                 showConfirmationDialog(
                     'ATEN√á√ÉO! Isso apagar√° TODOS os registros, planejamentos e configura√ß√µes. Esta a√ß√£o √© IRREVERS√çVEL. Deseja continuar?',
                     () => {
                         recordedEntries = [];
                         plannedEntries = [];
                         settings = { monthlyGoal: 70 }; // Reset settings
                         monthlyGoalInput.value = settings.monthlyGoal;
                         saveData(); // Save the empty state
                         clearRecordForm();
                         clearPlanForm();
                         renderHistory();
                         renderPlanning();
                         populateMonthSelector(); // Reset month selector
                          updateAllStatsAndCharts(); // Will update with empty data
                         showFeedback('Todos os dados foram apagados.', 'danger');
                     }
                 );
            }

             function handleExportData() {
                 const dataToExport = {
                     recordedEntries,
                     plannedEntries,
                     settings
                 };
                 const dataStr = JSON.stringify(dataToExport, null, 2); // Pretty print JSON
                 const dataBlob = new Blob([dataStr], { type: 'application/json' });
                 const url = URL.createObjectURL(dataBlob);
                 const link = document.createElement('a');
                 link.href = url;
                 link.download = `pioneiro_registro_${getCurrentDateString()}.json`;
                 document.body.appendChild(link);
                 link.click();
                 document.body.removeChild(link);
                 URL.revokeObjectURL(url); // Clean up blob URL
                 showFeedback('Dados exportados como JSON.', 'info');
             }


             // Confirmation Dialog
             function showConfirmationDialog(message, onConfirm) {
                 dialogMessage.textContent = message;
                 currentConfirmCallback = onConfirm;
                 confirmationDialog.classList.add('visible');
            }

            function hideConfirmationDialog() {
                confirmationDialog.classList.remove('visible');
                 currentConfirmCallback = null; // Clear callback
             }

             dialogConfirmBtn.addEventListener('click', () => {
                 if (typeof currentConfirmCallback === 'function') {
                     currentConfirmCallback();
                 }
                 hideConfirmationDialog();
             });

             dialogCancelBtn.addEventListener('click', hideConfirmationDialog);
              confirmationDialog.addEventListener('click', (e) => { // Close on backdrop click
                 if (e.target === confirmationDialog) {
                    hideConfirmationDialog();
                 }
             });

              // Basic Feedback (Could be improved with a styled toast notification)
              function showFeedback(message, type = 'info') {
                   console.log(`Feedback [${type}]: ${message}`); // Log for debugging
                   // Simple alert for now, can be replaced with a nicer UI element
                   // alert(message); // Use alert temporarily or implement a custom notification
              }


            // Rendering Functions
             function renderHistory() {
                historyList.innerHTML = ''; // Clear existing list
                 if (recordedEntries.length === 0) {
                    historyListPlaceholder.classList.remove('hidden');
                     return;
                }
                 historyListPlaceholder.classList.add('hidden');

                 recordedEntries.forEach(entry => {
                    const li = document.createElement('li');
                    li.dataset.id = entry.id;

                    // Determine if notes exist and add indicator/content
                     const notesIndicator = entry.notes ? `<i title="Notas: ${entry.notes}">üìù</i>` : '';
                     const notesDetail = entry.notes ? `<span>| Notas: ${entry.notes.substring(0, 30)}${entry.notes.length > 30 ? '...' : ''}</span>` : '';


                    li.innerHTML = `
                        <div class="entry-details">
                            <strong>${formatDisplayDate(entry.date)}:</strong>
                            <span>${entry.hours}h</span>
                             ${entry.placements > 0 ? `<span>| Pubs: ${entry.placements}</span>` : ''}
                             ${entry.videos > 0 ? `<span>| V√≠deos: ${entry.videos}</span>` : ''}
                             ${entry.returnVisits > 0 ? `<span>| RV: ${entry.returnVisits}</span>` : ''}
                            ${entry.studies > 0 ? `<span>| Est: ${entry.studies}</span>` : ''}
                             ${notesDetail}
                        </div>
                        <div class="entry-actions">
                            <button class="edit-btn secondary">Editar</button>
                            <button class="delete-btn danger">Excluir</button>
                        </div>
                    `;
                    li.querySelector('.edit-btn').addEventListener('click', () => editRecordEntry(entry.id));
                    li.querySelector('.delete-btn').addEventListener('click', () => deleteRecordEntry(entry.id));
                    historyList.appendChild(li);
                });
            }

             function renderPlanning() {
                planningList.innerHTML = '';
                 const todayStr = getCurrentDateString();

                 // Filter out past plans (except maybe 'today')
                const futureOrTodayPlans = plannedEntries.filter(plan => plan.date >= todayStr);
                 futureOrTodayPlans.sort((a, b) => new Date(a.date) - new Date(b.date)); // Ensure sorting

                 if (futureOrTodayPlans.length === 0) {
                     planningListPlaceholder.classList.remove('hidden');
                     return;
                 }
                planningListPlaceholder.classList.add('hidden');


                futureOrTodayPlans.forEach(plan => {
                    const li = document.createElement('li');
                    li.dataset.id = plan.id;
                    li.innerHTML = `
                        <div class="entry-details">
                             <strong>${formatDisplayDate(plan.date)}:</strong>
                            <span>Planejado: ${plan.plannedHours}h</span>
                        </div>
                         <div class="plan-actions">
                             <button class="edit-plan-btn secondary">Editar</button>
                             <button class="delete-plan-btn danger">Excluir</button>
                         </div>
                     `;
                     li.querySelector('.edit-plan-btn').addEventListener('click', () => editPlanEntry(plan.id));
                     li.querySelector('.delete-plan-btn').addEventListener('click', () => deletePlanEntry(plan.id));
                    planningList.appendChild(li);
                 });
             }

            function updateStatistics() {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                 const entriesThisMonth = recordedEntries.filter(entry => {
                     const entryDate = new Date(entry.date + 'T00:00:00'); // Ensure correct date parsing across timezones
                     return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear;
                });

                 let totalHours = 0;
                 let totalPlacements = 0;
                 let totalVideos = 0;
                 let totalRv = 0;
                 let totalStudies = 0;
                 const activeDays = new Set(); // Use a Set to count unique days

                 entriesThisMonth.forEach(entry => {
                     totalHours += entry.hours;
                      totalPlacements += entry.placements || 0;
                      totalVideos += entry.videos || 0;
                      totalRv += entry.returnVisits || 0;
                      totalStudies += entry.studies || 0;
                     activeDays.add(entry.date);
                 });

                 const goal = settings.monthlyGoal || 70;
                 const progressPercent = goal > 0 ? Math.min(Math.round((totalHours / goal) * 100), 100) : 0;
                const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
                 const avgHoursPerDay = activeDays.size > 0 ? (totalHours / activeDays.size).toFixed(1) : 0;
                 const daysActiveCount = activeDays.size;


                 statsMonthHours.textContent = totalHours.toFixed(2).replace('.', ',');
                 statsMonthGoalProgress.textContent = `${progressPercent}%`;
                 statsMonthProgressBar.style.width = `${progressPercent}%`;
                  // Optional: Add text inside progress bar if it's wide enough
                 statsMonthProgressBar.textContent = progressPercent > 15 ? `${progressPercent}%` : '';
                 statsAvgHoursDay.textContent = avgHoursPerDay.replace('.', ',');
                 statsMonthPlacements.textContent = totalPlacements;
                 statsMonthVideos.textContent = totalVideos;
                 statsMonthRv.textContent = totalRv;
                 statsMonthStudies.textContent = totalStudies;
                  statsMonthDaysActive.textContent = daysActiveCount;
            }

             function populateMonthSelector() {
                 const availableMonths = new Set();
                 recordedEntries.forEach(entry => {
                     const date = new Date(entry.date + 'T00:00:00');
                      availableMonths.add(getMonthYearString(date));
                 });

                 const sortedMonths = Array.from(availableMonths).sort((a, b) => {
                     const [monthA, yearA] = a.split('/');
                     const [monthB, yearB] = b.split('/');
                      return new Date(yearB, monthB - 1) - new Date(yearA, monthA - 1); // Sort descending (newest first)
                 });

                 chartMonthSelector.innerHTML = ''; // Clear previous options

                 if (sortedMonths.length === 0) {
                      const option = document.createElement('option');
                     option.value = '';
                      option.textContent = 'Nenhum dado dispon√≠vel';
                     chartMonthSelector.appendChild(option);
                      chartMonthSelector.disabled = true;
                     return;
                 }

                 chartMonthSelector.disabled = false;
                const currentMonthStr = getMonthYearString(new Date());

                 // Add current month first if available, otherwise add it as an option
                let hasCurrentMonth = false;
                 sortedMonths.forEach(monthStr => {
                      const option = document.createElement('option');
                     option.value = monthStr;
                     option.textContent = monthStr;
                     if (monthStr === currentMonthStr) {
                        option.selected = true;
                        hasCurrentMonth = true;
                    }
                     chartMonthSelector.appendChild(option);
                 });

                 // If current month had no data, add it manually and select it
                 if (!hasCurrentMonth) {
                      const currentMonthOption = document.createElement('option');
                     currentMonthOption.value = currentMonthStr;
                     currentMonthOption.textContent = `${currentMonthStr} (Atual)`;
                     chartMonthSelector.insertBefore(currentMonthOption, chartMonthSelector.firstChild);
                      currentMonthOption.selected = true;
                 }

             }


             function renderCharts(selectedMonthYear) {
                 // ---- Monthly Hours Chart ----
                 const [selectedMonth, selectedYear] = selectedMonthYear.split('/').map(Number);
                 const entriesForSelectedMonth = recordedEntries.filter(entry => {
                     const entryDate = new Date(entry.date + 'T00:00:00');
                     return entryDate.getMonth() + 1 === selectedMonth && entryDate.getFullYear() === selectedYear;
                 });

                  const daysInSelectedMonth = new Date(selectedYear, selectedMonth, 0).getDate();
                 const dailyHours = Array(daysInSelectedMonth).fill(0);
                  let totalPlacementsMonth = 0;
                  let totalVideosMonth = 0;
                  let totalRvMonth = 0;
                  let totalStudiesMonth = 0;


                  entriesForSelectedMonth.forEach(entry => {
                      const dayOfMonth = new Date(entry.date + 'T00:00:00').getDate();
                      dailyHours[dayOfMonth - 1] += entry.hours; // dayOfMonth is 1-based index
                     totalPlacementsMonth += entry.placements || 0;
                      totalVideosMonth += entry.videos || 0;
                      totalRvMonth += entry.returnVisits || 0;
                      totalStudiesMonth += entry.studies || 0;
                  });

                 const labels = Array.from({ length: daysInSelectedMonth }, (_, i) => i + 1); // Labels 1 to 31 (or fewer)

                 if (monthlyHoursChartInstance) {
                     monthlyHoursChartInstance.destroy();
                 }
                  monthlyHoursChartInstance = new Chart(monthlyHoursChartCtx, {
                    type: 'bar', // Bar chart for daily hours
                    data: {
                         labels: labels,
                        datasets: [{
                            label: `Horas Di√°rias (${selectedMonthYear})`,
                             data: dailyHours,
                            backgroundColor: 'rgba(109, 151, 184, 0.7)', // var(--primary-color) with opacity
                             borderColor: 'rgba(109, 151, 184, 1)', // var(--primary-color)
                             borderWidth: 1,
                            borderRadius: 4, // Rounded bars
                        }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         scales: {
                             y: {
                                 beginAtZero: true,
                                title: { display: true, text: 'Horas' }
                            },
                            x: {
                                title: { display: true, text: 'Dia do M√™s' }
                             }
                         },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                     label: function(context) {
                                         let label = context.dataset.label || '';
                                         if (label) { label += ': '; }
                                        if (context.parsed.y !== null) {
                                            label += `${context.parsed.y.toFixed(2)}h`;
                                         }
                                         return label;
                                     }
                                 }
                             },
                            legend: {
                                display: true,
                                position: 'top',
                            }
                        }
                    }
                });


                 // ---- Activity Type Pie Chart ----
                 const activityData = [
                      totalPlacementsMonth,
                      totalVideosMonth,
                      totalRvMonth,
                      totalStudiesMonth
                 ];
                 const activityLabels = ['Publica√ß√µes', 'V√≠deos', 'Revisitas', 'Estudos'];
                 const totalActivities = activityData.reduce((sum, val) => sum + val, 0);


                 if (activityTypeChartInstance) {
                      activityTypeChartInstance.destroy();
                  }

                 if (totalActivities > 0) { // Only render pie chart if there are activities
                    activityTypeChartInstance = new Chart(activityTypeChartCtx, {
                        type: 'doughnut',
                        data: {
                            labels: activityLabels,
                            datasets: [{
                                label: 'Distribui√ß√£o de Atividades',
                                data: activityData,
                                backgroundColor: [
                                    'rgba(130, 192, 170, 0.8)', // var(--accent-color)
                                     'rgba(109, 151, 184, 0.8)', // var(--primary-color)
                                    'rgba(243, 156, 18, 0.8)', // Yellow/Orange
                                    'rgba(155, 89, 182, 0.8)' // Purple
                                ],
                                borderColor: '#fff',
                                borderWidth: 2
                            }]
                         },
                         options: {
                            responsive: true,
                            maintainAspectRatio: false,
                             plugins: {
                                legend: {
                                     display: true,
                                    position: 'bottom',
                                 },
                                 title: {
                                     display: true,
                                     text: `Atividades em ${selectedMonthYear}`
                                 },
                                 tooltip: {
                                     callbacks: {
                                        label: function(context) {
                                             let label = context.label || '';
                                             if (label) { label += ': '; }
                                             if (context.parsed !== null) {
                                                const value = context.parsed;
                                                 const percentage = totalActivities > 0 ? ((value / totalActivities) * 100).toFixed(1) : 0;
                                                 label += `${value} (${percentage}%)`;
                                             }
                                             return label;
                                         }
                                     }
                                 }
                            }
                        }
                    });
                } else {
                    // Optional: Display a message if no activity data for the pie chart
                     const ctx = activityTypeChartCtx;
                     ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                     ctx.save();
                      ctx.textAlign = 'center';
                     ctx.textBaseline = 'middle';
                      ctx.fillStyle = '#aaa';
                     ctx.font = "16px " + getComputedStyle(document.body).fontFamily;
                     ctx.fillText(`Nenhuma publica√ß√£o, v√≠deo, revisita`, ctx.canvas.width / 2, ctx.canvas.height / 2 - 10);
                      ctx.fillText(`ou estudo registrado em ${selectedMonthYear}`, ctx.canvas.width / 2, ctx.canvas.height / 2 + 10);
                     ctx.restore();
                 }

            }

             function updateAllStatsAndCharts() {
                 updateStatistics();
                 populateMonthSelector(); // Update month options based on potentially new data
                  const selectedMonth = chartMonthSelector.value || getMonthYearString(new Date());
                  if (selectedMonth) { // Ensure a month is selected/available
                      renderCharts(selectedMonth);
                  } else {
                       // Handle case with no data at all - clear charts?
                       if (monthlyHoursChartInstance) monthlyHoursChartInstance.destroy();
                      if (activityTypeChartInstance) activityTypeChartInstance.destroy();
                      // Maybe display messages in chart areas
                  }
            }

            // --- Event Listeners ---
            recordForm.addEventListener('submit', handleRecordSubmit);
            clearRecordFormBtn.addEventListener('click', clearRecordForm);

            planForm.addEventListener('submit', handlePlanSubmit);
            clearPlanFormBtn.addEventListener('click', clearPlanForm);


            saveGoalBtn.addEventListener('click', handleGoalSave);
             // Optional: Also save goal when pressing Enter in the input field
            monthlyGoalInput.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter') {
                      e.preventDefault(); // Prevent potential form submission if inside one
                      handleGoalSave();
                     monthlyGoalInput.blur(); // Remove focus
                  }
            });


             chartMonthSelector.addEventListener('change', (event) => {
                renderCharts(event.target.value);
             });

             clearAllDataBtn.addEventListener('click', handleClearAllData);
             exportDataBtn.addEventListener('click', handleExportData);


            // --- Initialization ---
            function init() {
                console.log("Initializing Pioneer Tracker...");
                loadData();
                recordDateInput.value = getCurrentDateString(); // Set default date
                clearRecordForm(); // Ensure clean state on load
                clearPlanForm(); // Ensure clean state on load
                renderHistory();
                renderPlanning();
                updateAllStatsAndCharts(); // Includes initial chart render
                 console.log("Initialization complete.");
             }

             // Make sure fonts and potential external resources are loaded before potentially
             // heavy operations like chart rendering, though usually DOMContentLoaded is sufficient.
            init();

        }); // End DOMContentLoaded
    </script>

</body>
</html>