<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro de Campo Pioneiro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        :root {
            /* Apple-Inspired Dark Theme */
            --system-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --primary-color: #0A84FF; /* Apple Blue */
            --secondary-color: #000000; /* Black background */
            --card-bg: #1c1c1e; /* Dark Gray card background */
            --input-bg: #2c2c2e; /* Slightly lighter input background */
            --text-color: #ffffff; /* White text */
            --text-color-secondary: rgba(235, 235, 245, 0.6); /* Lighter Gray for secondary text/labels */
            --border-color: #3a3a3c; /* Subtle border/divider color */
            --shadow-color: rgba(0, 0, 0, 0.2);
            --danger-color: #FF453A; /* Apple Red */
            --success-color: #30D158; /* Apple Green */
            --placeholder-color: rgba(235, 235, 245, 0.3);
            --dialog-backdrop: rgba(0, 0, 0, 0.7);
            --accent-color-progress: #30D158; /* Green for progress bar */

            --font-family: var(--system-font);
            --border-radius: 10px; /* Apple-like radius */
            --card-padding: 18px;
            --outer-padding: 15px;
            --transition-speed: 0.3s;
            --transition-speed-fast: 0.2s;
            --content-transition: max-height 0.35s ease-out, opacity 0.25s ease-out 0.1s, padding 0.35s ease-out, margin 0.35s ease-out;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: var(--font-family);
            background-color: var(--secondary-color);
            color: var(--text-color);
            line-height: 1.5; /* Slightly tighter line-height */
            padding: var(--outer-padding);
            overscroll-behavior-y: contain;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            font-size: 16px; /* Base font size */
        }

        #app { max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 25px;
            font-weight: 600;
            font-size: 1.8em;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            /* No shadow, rely on background contrast */
            overflow: hidden;
            transition: box-shadow var(--transition-speed) ease;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px var(--card-padding);
            cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease;
            position: relative; /* For potential future additions like summary info */
        }
         .card-header::after { /* Subtle bottom border only when collapsed */
            content: '';
            position: absolute;
            bottom: 0;
            left: var(--card-padding);
            right: var(--card-padding);
            height: 1px;
            background-color: var(--border-color);
            opacity: 1;
            transition: opacity var(--transition-speed-fast) ease;
         }
         .card.expanded .card-header::after {
             opacity: 0; /* Hide border when expanded */
         }


        .card:not(.expanded) .card-header:hover { background-color: rgba(255, 255, 255, 0.03); }

        .card-header h2 {
            color: var(--text-color); /* White title */
            margin-bottom: 0;
            font-size: 1.15em; /* Slightly larger */
            font-weight: 600; /* Semibold */
        }

        .toggle-icon {
            font-size: 0.8em; /* Smaller icon */
            font-weight: bold;
            transition: transform var(--transition-speed) ease;
            color: var(--text-color-secondary);
            margin-left: 10px;
            width: 20px; height: 20px; /* Ensure size */
            display: inline-flex; align-items: center; justify-content: center;
             /* background-color: rgba(255,255,255,0.1); Optional: subtle background for icon */
             /* border-radius: 50%; */
        }
        .card.expanded .toggle-icon { transform: rotate(180deg); }

        .card-content {
            padding: 0 var(--card-padding) 0 var(--card-padding);
            max-height: 0;
            opacity: 0;
            overflow: hidden;
             border-top: 1px solid var(--border-color); /* Add top border for separation when expanded */
             transition: var(--content-transition);
             margin-top: -1px; /* Overlap border slightly */
        }
        .card.expanded .card-content {
             padding-top: var(--card-padding);
             padding-bottom: calc(var(--card-padding) + 5px); /* Slightly more bottom padding */
             max-height: 1500px; /* Sufficient height */
             opacity: 1;
            margin-top: 0;
            overflow: visible; /* Allow elements like date picker to show */
        }


        /* Form Styles */
        .form-group { margin-bottom: 16px; }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-color-secondary);
            font-size: 0.9em; /* Slightly smaller labels */
        }

        input[type="date"], input[type="number"], input[type="text"], textarea, select {
            width: 100%;
            padding: 11px 14px; /* Adjust padding */
            border: 1px solid var(--border-color);
            border-radius: 8px; /* Slightly smaller radius */
            font-size: 1em;
            font-family: var(--font-family);
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            appearance: none; -webkit-appearance: none; -moz-appearance: none;
            background-color: var(--input-bg);
            color: var(--text-color);
        }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; } /* Adjust icon color */

        input::placeholder, textarea::placeholder { color: var(--placeholder-color); opacity: 1; }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3); /* Apple Blue focus glow */
        }

        input[type="number"] { -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        textarea { resize: vertical; min-height: 90px; }

        button {
            background-color: var(--primary-color);
            color: var(--text-color);
            border: none;
            padding: 11px 22px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600; /* Semibold */
            cursor: pointer;
            transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease;
            display: inline-block;
            margin-right: 8px;
            margin-top: 10px;
            width: calc(50% - 4px);
        }
        @media (min-width: 600px) { button { width: auto; } }
        button:last-child { margin-right: 0; }

        button:hover { background-color: #007aff; /* Darker Apple Blue */ transform: translateY(-1px); }
        button:active { transform: translateY(0px); background-color: #3498ff; /* Lighter when pressed */ }

        button.secondary { background-color: var(--input-bg); color: var(--primary-color); border: 1px solid var(--border-color); }
        button.secondary:hover { background-color: #3a3a3c; }

        button.danger { background-color: var(--danger-color); color: var(--text-color); }
        button.danger:hover { background-color: #ff3b30; transform: translateY(-1px); }
        button.danger:active { background-color: #ff5a52; transform: translateY(0px); }

        /* Subtle Button for changing date */
         .change-date-button {
             background: none;
             border: none;
             color: var(--primary-color);
             cursor: pointer;
             font-size: 0.9em;
             padding: 5px 0;
             margin-left: 5px;
             text-align: left;
              width: auto; /* override default */
              margin-right: 0;
             margin-top: 0;
         }
         .change-date-button:hover { text-decoration: underline; }


        /* Statistics Styles (Simplified) */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; text-align: center; margin-top: 10px;}
        .stat-item { background-color: var(--input-bg); padding: 16px 12px; border-radius: 8px; }
        .stat-value { font-size: 1.7em; font-weight: 600; color: var(--text-color); display: block; margin-bottom: 2px; }
        .stat-label { font-size: 0.85em; color: var(--text-color-secondary); }
        .progress-bar-container { background-color: var(--border-color); border-radius: 5px; overflow: hidden; height: 8px; margin-top: 8px; }
        .progress-bar { background-color: var(--accent-color-progress); height: 100%; width: 0; transition: width var(--transition-speed) ease-out; }

        /* History & Planning List Styles */
        .data-list { list-style: none; padding: 0; max-height: 350px; overflow-y: auto; margin-top: 15px; /* Removed border - integrated into card */ }
        .data-list li { background-color: transparent; border-bottom: 1px solid var(--border-color); padding: 14px 0; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; transition: background-color var(--transition-speed-fast) ease; margin: 0 var(--card-padding); /* Align with card padding */ }
        .data-list li:last-child { border-bottom: none; }
        .data-list li:hover { background-color: rgba(255, 255, 255, 0.02); } /* Very subtle hover */
        .entry-details { font-size: 0.95em; flex-grow: 1; margin-right: 10px; line-height: 1.4; }
        .entry-details strong { color: var(--text-color); font-weight: 500; } /* Normal weight for date */
        .entry-details .hours { color: var(--primary-color); font-weight: 600; margin-left: 5px; margin-right: 5px;} /* Highlight hours */
         .entry-details .notes-preview { color: var(--text-color-secondary); font-size: 0.9em; display: block; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 300px; } /* Limit notes preview */

        .entry-actions button, .plan-actions button { padding: 6px 10px; font-size: 0.85em; margin-left: 5px; margin-top: 5px; width: auto; border-radius: 6px; } /* Smaller buttons */
        .entry-actions button.secondary, .plan-actions button.secondary { background-color: #3a3a3c; } /* Secondary action bg */


        /* Chart Container */
        .chart-container { position: relative; height: 250px; /* Slightly smaller */ width: 100%; margin-top: 25px; }

        /* Confirmation Dialog */
        .dialog-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--dialog-backdrop); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease; }
        .dialog-backdrop.visible { opacity: 1; visibility: visible; }
        .dialog-content { background-color: #2c2c2e; /* Dialog bg */ color: var(--text-color); padding: 25px; border-radius: 14px; /* Larger radius for dialog */ box-shadow: 0 8px 30px rgba(0,0,0,0.4); text-align: center; max-width: 90%; width: 320px; transform: scale(0.95); transition: transform var(--transition-speed) ease; }
        .dialog-backdrop.visible .dialog-content { transform: scale(1); }
        .dialog-content p { margin-bottom: 25px; font-size: 1.05em; line-height: 1.5; }
        .dialog-actions button { width: calc(50% - 5px); margin-top: 0; padding: 10px; font-size: 1em;}

        /* Helper Classes */
        .hidden { display: none !important; } /* More specific */
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        .text-center { text-align: center; }
        .mt-1 { margin-top: 10px; }
        .mt-2 { margin-top: 20px; }
    </style>
</head>
<body>

    <div id="app">
        <h1>Registro de Campo</h1>

        <!-- Card: Registrar Atividade (Expanded by default) -->
        <div class="card expanded" id="record-card">
             <div class="card-header">
                 <h2>Registrar Atividade</h2>
                 <span class="toggle-icon">▲</span>
             </div>
            <div class="card-content">
                <form id="record-form">
                    <input type="hidden" id="record-id">

                     <!-- Date Handling: Hidden by default -->
                    <div class="form-group">
                        <label for="record-date" id="date-label">
                             Data: <strong id="display-date">Hoje</strong>
                            <button type="button" class="change-date-button" id="change-date-btn">(Alterar)</button>
                        </label>
                        <input type="date" id="record-date" class="hidden">
                    </div>

                    <div class="form-group">
                        <label for="record-hours">Horas Dedicadas:</label>
                        <input type="number" id="record-hours" step="0.25" min="0" required placeholder="Ex: 2.5">
                    </div>
                    <!-- Simplified fields - Removed Placements, Videos, RV, Studies -->
                    <div class="form-group">
                        <label for="record-notes">Notas / Observações:</label>
                        <textarea id="record-notes" rows="3" placeholder="Descreva a atividade, pessoas contatadas, assuntos, etc."></textarea>
                    </div>
                    <div class="text-center" style="margin-top: 20px;">
                        <button type="submit" id="save-record-btn">Salvar Registro</button>
                        <button type="button" id="clear-record-form-btn" class="secondary">Limpar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Card: Planejar Atividade -->
        <div class="card" id="plan-card">
            <div class="card-header">
                <h2>Planejar Horas</h2>
                <span class="toggle-icon">▼</span>
            </div>
             <div class="card-content">
                <form id="plan-form">
                    <input type="hidden" id="plan-id">
                    <div class="form-group"><label for="plan-date">Data Futura:</label><input type="date" id="plan-date" required></div>
                    <div class="form-group"><label for="plan-hours">Horas Planejadas:</label><input type="number" id="plan-hours" step="0.25" min="0.25" required placeholder="Ex: 3"></div>
                    <div class="text-center">
                        <button type="submit" id="save-plan-btn">Salvar Plano</button>
                        <button type="button" id="clear-plan-form-btn" class="secondary">Limpar</button>
                    </div>
                </form>
                <div id="planning-list-container" class="mt-2">
                    <h3 style="font-size: 1em; font-weight: 600; color: var(--text-color-secondary); margin-bottom: 10px;">Próximos Planos:</h3>
                    <ul id="planning-list" class="data-list">
                        <li class="placeholder hidden">Nenhum planejamento futuro encontrado.</li>
                    </ul>
                </div>
             </div>
        </div>

        <!-- Card: Estatísticas e Progresso -->
        <div class="card" id="stats-card">
            <div class="card-header">
                 <h2>Resumo Mensal</h2>
                 <span class="toggle-icon">▼</span>
             </div>
            <div class="card-content">
                 <div class="form-group" style="max-width: 200px; margin: 0 auto 25px auto; text-align:center;">
                     <label for="monthly-goal">Meta Mensal (Horas):</label>
                     <input type="number" id="monthly-goal" min="1" step="1" value="70">
                     <button id="save-goal-btn" class="mt-1 secondary" style="width:100%; font-size:0.9em; padding: 8px 10px;">Definir Meta</button>
                 </div>
                 <div class="stats-grid">
                    <div class="stat-item">
                        <span id="stats-month-hours" class="stat-value">0</span>
                        <span class="stat-label">Horas no Mês</span>
                    </div>
                    <div class="stat-item">
                        <span id="stats-month-goal-progress" class="stat-value">0%</span>
                        <span class="stat-label">Progresso Meta</span>
                         <div class="progress-bar-container"><div id="stats-month-progress-bar" class="progress-bar"></div></div>
                    </div>
                    <div class="stat-item">
                        <span id="stats-avg-hours-day" class="stat-value">0</span>
                        <span class="stat-label">Média / Dia Ativo</span>
                    </div>
                    <div class="stat-item">
                         <span id="stats-month-days-active" class="stat-value">0</span>
                         <span class="stat-label">Dias Ativos</span>
                   </div>
                     <!-- Removed specific activity stats -->
                </div>
            </div>
        </div>

        <!-- Card: Gráficos (Only hours chart now) -->
        <div class="card" id="charts-card">
             <div class="card-header">
                <h2>Gráfico de Horas</h2>
                 <span class="toggle-icon">▼</span>
            </div>
            <div class="card-content">
                <div class="form-group">
                    <label for="chart-month-selector">Visualizar Mês:</label>
                    <select id="chart-month-selector"></select>
                </div>
                <div class="chart-container">
                    <canvas id="monthlyHoursChart"></canvas>
                </div>
                <!-- Activity Type Chart Removed -->
             </div>
        </div>

        <!-- Card: Histórico Detalhado -->
        <div class="card" id="history-card">
             <div class="card-header">
                <h2>Histórico de Registros</h2>
                 <span class="toggle-icon">▼</span>
            </div>
            <div class="card-content">
                 <h3 style="font-size: 1em; font-weight: 600; color: var(--text-color-secondary); margin-bottom: 10px;">Registros Salvos:</h3>
                <ul id="history-list" class="data-list">
                    <li class="placeholder hidden">Nenhum registro encontrado.</li>
                </ul>
             </div>
        </div>

         <!-- Card: Configurações -->
        <div class="card" id="settings-card">
             <div class="card-header">
                <h2>Configurações</h2>
                <span class="toggle-icon">▼</span>
             </div>
              <div class="card-content">
                <div class="text-center">
                    <button id="clear-all-data-btn" class="danger">Limpar Todos os Dados</button>
                </div>
                 <p style="margin-top: 15px; font-size: 0.9em; color: var(--text-color-secondary); text-align: center; line-height: 1.4;">
                    Atenção: Limpar os dados removerá permanentemente todos os seus registros, planos e meta deste navegador. Esta ação não pode ser desfeita.
                 </p>
             </div>
        </div>

    </div> <!-- /#app -->

     <!-- Confirmation Dialog Structure -->
     <div id="confirmation-dialog" class="dialog-backdrop">
         <div class="dialog-content">
              <p id="dialog-message">Você tem certeza?</p>
              <div class="dialog-actions">
                  <button id="dialog-confirm-btn" class="danger">Confirmar</button>
                  <button id="dialog-cancel-btn" class="secondary">Cancelar</button>
             </div>
          </div>
      </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            // --- DOM Elements ---
            const appElement = document.getElementById('app'); // Get main app element
            const recordCard = document.getElementById('record-card');
            const recordForm = document.getElementById('record-form');
            const recordIdInput = document.getElementById('record-id');
            const recordDateInput = document.getElementById('record-date');
             const dateLabel = document.getElementById('date-label');
             const displayDate = document.getElementById('display-date');
             const changeDateBtn = document.getElementById('change-date-btn');
            const recordHoursInput = document.getElementById('record-hours');
            // Removed Placements, Videos, RV, Studies Inputs
            const recordNotesInput = document.getElementById('record-notes');
            const saveRecordBtn = document.getElementById('save-record-btn');
            const clearRecordFormBtn = document.getElementById('clear-record-form-btn');

            const planCard = document.getElementById('plan-card');
            const planForm = document.getElementById('plan-form');
            const planIdInput = document.getElementById('plan-id');
            const planDateInput = document.getElementById('plan-date');
            const planHoursInput = document.getElementById('plan-hours');
            const savePlanBtn = document.getElementById('save-plan-btn');
            const clearPlanFormBtn = document.getElementById('clear-plan-form-btn');
            const planningList = document.getElementById('planning-list');
            const planningListPlaceholder = planningList.querySelector('.placeholder');

            const monthlyGoalInput = document.getElementById('monthly-goal');
            const saveGoalBtn = document.getElementById('save-goal-btn');
            const statsMonthHours = document.getElementById('stats-month-hours');
            const statsMonthGoalProgress = document.getElementById('stats-month-goal-progress');
            const statsMonthProgressBar = document.getElementById('stats-month-progress-bar');
            const statsAvgHoursDay = document.getElementById('stats-avg-hours-day');
             // Removed specific activity stat elements
             const statsMonthDaysActive = document.getElementById('stats-month-days-active');


            const chartMonthSelector = document.getElementById('chart-month-selector');
            const monthlyHoursChartCtx = document.getElementById('monthlyHoursChart').getContext('2d');
             // Removed Activity Type Chart Ctx

            const historyList = document.getElementById('history-list');
            const historyListPlaceholder = historyList.querySelector('.placeholder');

            const clearAllDataBtn = document.getElementById('clear-all-data-btn');

            const confirmationDialog = document.getElementById('confirmation-dialog');
            const dialogMessage = document.getElementById('dialog-message');
            const dialogConfirmBtn = document.getElementById('dialog-confirm-btn');
            const dialogCancelBtn = document.getElementById('dialog-cancel-btn');

            // --- State & Data ---
            let recordedEntries = [];
            let plannedEntries = [];
            let settings = { monthlyGoal: 70 };
            let monthlyHoursChartInstance = null;
            // Removed activityTypeChartInstance
            let currentEditingId = null;
            let currentConfirmCallback = null;
             let isDateInputVisible = false; // Track visibility for date logic

             // Get CSS Var values for Chart.js
             const computedStyles = getComputedStyle(document.body);
            const textColor = computedStyles.getPropertyValue('--text-color').trim();
            const textMutedColor = computedStyles.getPropertyValue('--text-color-secondary').trim();
            const gridColor = computedStyles.getPropertyValue('--border-color').trim();
            const tooltipBgColor = computedStyles.getPropertyValue('--card-bg').trim();
             const primaryColor = computedStyles.getPropertyValue('--primary-color').trim(); // For charts


            const LOCAL_STORAGE_KEYS = {
                ENTRIES: 'pioneerTracker_entries_v3', // Incremented version due to data structure change
                PLANS: 'pioneerTracker_plans_v1',
                SETTINGS: 'pioneerTracker_settings_v1'
            };

            // --- Functions ---

            // Data Handling
             function saveData() { /* ... (try/catch same as before) ... */
                 try { localStorage.setItem(LOCAL_STORAGE_KEYS.ENTRIES, JSON.stringify(recordedEntries)); localStorage.setItem(LOCAL_STORAGE_KEYS.PLANS, JSON.stringify(plannedEntries)); localStorage.setItem(LOCAL_STORAGE_KEYS.SETTINGS, JSON.stringify(settings)); console.log("Data saved."); } catch (error) { console.error("CRITICAL Save Error:", error); alert("ERRO GRAVE AO SALVAR!"); }
             }
            function loadData() { /* ... (try/catch same, adapted key, check v2 data if v3 fails?) ... */
                try {
                    let storedEntriesRaw = localStorage.getItem(LOCAL_STORAGE_KEYS.ENTRIES);
                     // Simple check for old data structure (optional, but helpful)
                     // This assumes old data didn't have notes but had others. Adapt if needed.
                     if (storedEntriesRaw) {
                         const sampleEntry = JSON.parse(storedEntriesRaw)[0];
                         if (sampleEntry && 'placements' in sampleEntry && !('notes' in sampleEntry)) {
                            console.warn("Old data format detected, migrating...");
                             // You might want to offer a more robust migration here,
                             // but for now, we'll just log and potentially reset.
                             // A safer approach is to ignore/clear old format on error.
                             storedEntriesRaw = null; // Force reset if structure is old/unexpected
                         }
                     }

                    recordedEntries = storedEntriesRaw ? JSON.parse(storedEntriesRaw) : [];
                    recordedEntries.sort((a, b) => new Date(b.date) - new Date(a.date));

                    const storedPlans = localStorage.getItem(LOCAL_STORAGE_KEYS.PLANS);
                    plannedEntries = storedPlans ? JSON.parse(storedPlans) : [];
                    plannedEntries.sort((a, b) => new Date(a.date) - new Date(b.date));

                    const storedSettings = localStorage.getItem(LOCAL_STORAGE_KEYS.SETTINGS);
                    settings = storedSettings ? JSON.parse(storedSettings) : { monthlyGoal: 70 };
                    monthlyGoalInput.value = settings.monthlyGoal;
                    console.log("Data loaded.");
                 } catch (error) {
                    console.error("Load Error:", error);
                     recordedEntries = []; plannedEntries = []; settings = { monthlyGoal: 70 };
                     try { /* Clear potentially corrupt keys */
                         localStorage.removeItem(LOCAL_STORAGE_KEYS.ENTRIES); localStorage.removeItem(LOCAL_STORAGE_KEYS.PLANS); localStorage.removeItem(LOCAL_STORAGE_KEYS.SETTINGS);
                         // Check for older key name and remove if needed
                          localStorage.removeItem('pioneerTracker_entries_v2');
                     } catch (removeError) { console.error("Error removing corrupt data:", removeError); }
                     alert("Erro ao carregar dados. Resetando para o padrão.");
                 }
            }

             // Date Helpers
            function getCurrentDateString() { /* ... (same) ... */
                 const t = new Date(); return `${t.getFullYear()}-${String(t.getMonth() + 1).padStart(2, '0')}-${String(t.getDate()).padStart(2, '0')}`;
             }
             function formatDisplayDate(dateString) { /* ... (same) ... */
                 if (!dateString || !dateString.includes('-')) return dateString;
                const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`;
            }
            function getMonthYearString(date) { /* ... (same) ... */
                 const m = String(date.getMonth() + 1).padStart(2, '0'); const y = date.getFullYear(); return `${m}/${y}`;
            }

             // Date Input Toggle Logic
             function setDateInputVisibility(visible) {
                 isDateInputVisible = visible;
                 if (visible) {
                     recordDateInput.classList.remove('hidden');
                     dateLabel.classList.add('visually-hidden'); // Hide "Data: Hoje" label
                     recordDateInput.focus();
                 } else {
                     recordDateInput.classList.add('hidden');
                     dateLabel.classList.remove('visually-hidden');
                     // Update display date when hiding
                      displayDate.textContent = (recordDateInput.value === getCurrentDateString()) ? "Hoje" : formatDisplayDate(recordDateInput.value);
                     recordDateInput.value = getCurrentDateString(); // Reset input value if needed? Or keep user choice? Let's keep it.
                 }
            }

             changeDateBtn.addEventListener('click', () => setDateInputVisibility(true));


            // Card Collapse/Expand Logic (CORRECTED)
             function toggleCard(cardElement) {
                 if (!cardElement) return;
                 const isExpanded = cardElement.classList.contains('expanded');
                 cardElement.classList.toggle('expanded', !isExpanded);
                 const icon = cardElement.querySelector('.toggle-icon');
                 if (icon) { icon.textContent = !isExpanded ? '▲' : '▼'; }
                 console.log("Toggled card:", cardElement.id, "Expanded:", !isExpanded);
             }

             // Attach listener to the APP container and delegate
             appElement.addEventListener('click', (event) => {
                 const header = event.target.closest('.card-header');
                 if (header) {
                    const card = header.closest('.card');
                    if (card) {
                         toggleCard(card);
                    }
                 }
             });
             // Add keyboard accessibility to headers dynamically if needed, or directly on elements
              document.querySelectorAll('.card-header').forEach(header => {
                   header.setAttribute('role', 'button');
                   header.setAttribute('tabindex', '0'); // Make focusable
                   header.addEventListener('keydown', (e) => {
                       if (e.key === 'Enter' || e.key === ' ') {
                           e.preventDefault(); // Prevent page scroll on Space
                           toggleCard(header.closest('.card'));
                       }
                   });
               });


            // Record Form Handling (SIMPLIFIED)
             function clearRecordForm() {
                recordForm.reset();
                 recordIdInput.value = '';
                recordDateInput.value = getCurrentDateString(); // Set date input value
                 setDateInputVisibility(false); // Hide date input, update label
                saveRecordBtn.textContent = 'Salvar Registro';
                saveRecordBtn.classList.remove('editing');
                currentEditingId = null;
             }

             function handleRecordSubmit(event) {
                event.preventDefault();
                const id = recordIdInput.value ? parseInt(recordIdInput.value, 10) : Date.now();
                // Use the date from the input IF it's visible OR if it has a value (means user changed it)
                 // Otherwise default to today
                const date = (isDateInputVisible || recordDateInput.value !== '') ? recordDateInput.value : getCurrentDateString();
                const hours = parseFloat(recordHoursInput.value) || 0;
                 const notes = recordNotesInput.value.trim(); // Primary data field now

                 if (hours <= 0) { alert("Por favor, insira as Horas dedicadas (maior que zero)."); return; }
                if (!date) { alert("Data inválida selecionada."); return; } // Basic check


                 // Simplified Entry Object
                 const newEntry = { id, date, hours, notes };

                 const existingIndex = recordedEntries.findIndex(entry => entry.id === id);
                 if (existingIndex > -1) { recordedEntries[existingIndex] = newEntry; }
                 else { recordedEntries.push(newEntry); }
                 recordedEntries.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort after add/edit

                 saveData(); clearRecordForm(); renderHistory(); updateAllStatsAndCharts();
                 showFeedback('Registro salvo com sucesso!', 'success');
            }

            function editRecordEntry(id) {
                const entry = recordedEntries.find(e => e.id === id);
                if (entry) {
                     if (!recordCard.classList.contains('expanded')) { toggleCard(recordCard); }

                     currentEditingId = id;
                    recordIdInput.value = entry.id;
                     // Set and potentially show the date input
                    recordDateInput.value = entry.date;
                    if (entry.date !== getCurrentDateString()) {
                         setDateInputVisibility(true); // Show if not today
                     } else {
                         setDateInputVisibility(false); // Keep hidden if today, update display text
                    }
                     recordHoursInput.value = entry.hours;
                     recordNotesInput.value = entry.notes || ''; // Notes are now crucial
                    saveRecordBtn.textContent = 'Atualizar Registro';
                     saveRecordBtn.classList.add('editing');
                     recordCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
                     recordHoursInput.focus(); // Focus on hours field
                }
             }

            function deleteRecordEntry(id) { /* ... (same as before, simplified stats/charts don't affect this) ... */
                 showConfirmationDialog(`Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.`, () => {
                     recordedEntries = recordedEntries.filter(entry => entry.id !== id); saveData(); renderHistory(); updateAllStatsAndCharts(); showFeedback('Registro excluído.', 'info');
                     if (currentEditingId === id) { clearRecordForm(); }
                 });
             }

             // Planning Form Handling (No major changes needed)
             function clearPlanForm() { /* ... (same) ... */ planForm.reset(); planIdInput.value = ''; planDateInput.value = ''; savePlanBtn.textContent = 'Salvar Plano'; currentEditingId = null; }
            function handlePlanSubmit(event) { /* ... (same) ... */
                event.preventDefault(); const id = planIdInput.value ? parseInt(planIdInput.value, 10) : Date.now(); const date = planDateInput.value; const plannedHours = parseFloat(planHoursInput.value); const todayStr = getCurrentDateString();
                if (!date || !plannedHours || plannedHours <= 0) { alert("Por favor, preencha Data Futura e Horas Planejadas (>0)."); return; }
                if (date < todayStr) { alert("Data do planejamento deve ser hoje ou futura."); return; }
                const newPlan = { id, date, plannedHours }; const existingIndex = plannedEntries.findIndex(p => p.id === id);
                if (existingIndex > -1) { plannedEntries[existingIndex] = newPlan; } else { plannedEntries.push(newPlan); }
                 plannedEntries.sort((a, b) => new Date(a.date) - new Date(b.date)); saveData(); clearPlanForm(); renderPlanning(); showFeedback('Planejamento salvo!', 'success');
            }
            function editPlanEntry(id) { /* ... (Expand card logic same as editRecordEntry) ... */
                const plan = plannedEntries.find(p => p.id === id);
                 if (plan) { if (!planCard.classList.contains('expanded')) { toggleCard(planCard); } currentEditingId = id; planIdInput.value = plan.id; planDateInput.value = plan.date; planHoursInput.value = plan.plannedHours; savePlanBtn.textContent = 'Atualizar Plano'; planCard.scrollIntoView({ behavior: 'smooth', block: 'start' }); planDateInput.focus(); }
            }
            function deletePlanEntry(id) { /* ... (same) ... */
                showConfirmationDialog(`Tem certeza que deseja excluir este planejamento?`, () => { plannedEntries = plannedEntries.filter(p => p.id !== id); saveData(); renderPlanning(); showFeedback('Planejamento excluído.', 'info'); if (currentEditingId === id) { clearPlanForm(); } });
            }


             // Settings Handling
             function handleGoalSave() { /* ... (same) ... */ const newGoal = parseInt(monthlyGoalInput.value, 10); if (!isNaN(newGoal) && newGoal > 0) { settings.monthlyGoal = newGoal; saveData(); updateStatistics(); showFeedback('Meta mensal atualizada!', 'success'); } else { alert("Insira um número válido para a meta."); monthlyGoalInput.value = settings.monthlyGoal; } }
             function handleClearAllData() { /* ... (Expand/collapse logic added) ... */
                 showConfirmationDialog('ATENÇÃO! Isso apagará TODOS os dados neste navegador. IRREVERSÍVEL. Continuar?', () => {
                     recordedEntries = []; plannedEntries = []; settings = { monthlyGoal: 70 }; monthlyGoalInput.value = settings.monthlyGoal; saveData(); clearRecordForm(); clearPlanForm(); renderHistory(); renderPlanning(); populateMonthSelector(); updateAllStatsAndCharts(); showFeedback('Todos os dados foram apagados.', 'danger');
                      // Collapse all cards except first one
                      document.querySelectorAll('.card').forEach(card => {
                          if (card.id !== 'record-card' && card.classList.contains('expanded')) toggleCard(card);
                          else if (card.id === 'record-card' && !card.classList.contains('expanded')) toggleCard(card); // Ensure record card is open
                     });
                 });
             }

             // Confirmation Dialog (same logic)
             function showConfirmationDialog(message, onConfirm) { /* ... */ dialogMessage.textContent = message; currentConfirmCallback = onConfirm; confirmationDialog.classList.add('visible'); }
             function hideConfirmationDialog() { /* ... */ confirmationDialog.classList.remove('visible'); currentConfirmCallback = null; }
            dialogConfirmBtn.addEventListener('click', () => { if (typeof currentConfirmCallback === 'function') { currentConfirmCallback(); } hideConfirmationDialog(); });
            dialogCancelBtn.addEventListener('click', hideConfirmationDialog);
            confirmationDialog.addEventListener('click', (e) => { if (e.target === confirmationDialog) { hideConfirmationDialog(); } });
             function showFeedback(message, type = 'info') { console.log(`Feedback [${type}]: ${message}`); /* alert(message); Optional */ }

            // Rendering Functions
            function renderHistory() { // SIMPLIFIED item display
                 historyList.innerHTML = '';
                 if (recordedEntries.length === 0) { historyListPlaceholder.classList.remove('hidden'); return; }
                 historyListPlaceholder.classList.add('hidden');
                 recordedEntries.forEach(entry => {
                     const li = document.createElement('li'); li.dataset.id = entry.id;
                     const notesPreview = entry.notes ? `<span class="notes-preview">${entry.notes}</span>` : '<span class="notes-preview" style="opacity: 0.5;">Sem notas</span>'; // Show preview or placeholder
                     li.innerHTML = `
                        <div class="entry-details">
                            <strong>${formatDisplayDate(entry.date)}:</strong>
                            <span class="hours">${entry.hours}h</span>
                            ${notesPreview}
                        </div>
                        <div class="entry-actions">
                             <button class="edit-btn secondary">Editar</button>
                             <button class="delete-btn danger">Excluir</button>
                        </div>
                     `;
                     li.querySelector('.edit-btn').addEventListener('click', (e) => { e.stopPropagation(); editRecordEntry(entry.id); }); // Stop propagation needed if using event delegation on list items
                     li.querySelector('.delete-btn').addEventListener('click', (e) => { e.stopPropagation(); deleteRecordEntry(entry.id); });
                     historyList.appendChild(li);
                });
             }
             function renderPlanning() { // Slightly updated item display
                planningList.innerHTML = ''; const todayStr = getCurrentDateString(); const futurePlans = plannedEntries.filter(plan => plan.date >= todayStr).sort((a, b) => new Date(a.date) - new Date(b.date));
                 if (futurePlans.length === 0) { planningListPlaceholder.classList.remove('hidden'); return; } planningListPlaceholder.classList.add('hidden');
                futurePlans.forEach(plan => {
                     const li = document.createElement('li'); li.dataset.id = plan.id;
                     li.innerHTML = `
                         <div class="entry-details">
                             <strong>${formatDisplayDate(plan.date)}:</strong>
                              <span class="hours">${plan.plannedHours}h</span> Planejadas
                         </div>
                         <div class="plan-actions">
                             <button class="edit-plan-btn secondary">Editar</button>
                             <button class="delete-plan-btn danger">Excluir</button>
                         </div>
                     `;
                    li.querySelector('.edit-plan-btn').addEventListener('click', (e) => { e.stopPropagation(); editPlanEntry(plan.id); });
                    li.querySelector('.delete-plan-btn').addEventListener('click', (e) => { e.stopPropagation(); deletePlanEntry(plan.id); });
                     planningList.appendChild(li);
                 });
             }
            function updateStatistics() { // SIMPLIFIED stats
                 const currentMonth = new Date().getMonth(); const currentYear = new Date().getFullYear();
                 const entriesThisMonth = recordedEntries.filter(entry => { const entryDate = new Date(entry.date + 'T00:00:00'); return entryDate.getMonth() === currentMonth && entryDate.getFullYear() === currentYear; });
                 let totalHours = 0; const activeDays = new Set();
                 entriesThisMonth.forEach(entry => { totalHours += entry.hours; activeDays.add(entry.date); });
                 const goal = settings.monthlyGoal || 70;
                 const progressPercent = goal > 0 ? Math.min(Math.round((totalHours / goal) * 100), 100) : 0;
                 const avgHoursPerDay = activeDays.size > 0 ? (totalHours / activeDays.size).toFixed(1) : 0;
                 const daysActiveCount = activeDays.size;
                 statsMonthHours.textContent = totalHours.toFixed(1).replace('.', ','); statsMonthGoalProgress.textContent = `${progressPercent}%`; statsMonthProgressBar.style.width = `${progressPercent}%`; /* Removed text in progress bar */ statsAvgHoursDay.textContent = avgHoursPerDay.replace('.', ','); statsMonthDaysActive.textContent = daysActiveCount;
            }
             function populateMonthSelector() { /* ... (same logic as before) ... */ const availableMonths = new Set(); recordedEntries.forEach(e => { availableMonths.add(getMonthYearString(new Date(e.date + 'T00:00:00'))); }); const sortedMonths = Array.from(availableMonths).sort((a, b)=>{const[mA,yA]=a.split('/'); const[mB,yB]=b.split('/'); return new Date(yB,mB-1)-new Date(yA,mA-1);}); chartMonthSelector.innerHTML = ''; if (sortedMonths.length === 0) {const o = document.createElement('option'); o.value=''; o.textContent='Nenhum dado'; chartMonthSelector.appendChild(o); chartMonthSelector.disabled = true; return;} chartMonthSelector.disabled=false; const currentMonthStr=getMonthYearString(new Date()); let hasCurrentMonth=false; sortedMonths.forEach(mStr => {const o=document.createElement('option');o.value=mStr; o.textContent=mStr; if(mStr===currentMonthStr){o.selected=true; hasCurrentMonth=true;} chartMonthSelector.appendChild(o);}); if(!hasCurrentMonth){const o=document.createElement('option');o.value=currentMonthStr;o.textContent=`${currentMonthStr} (Atual)`; chartMonthSelector.insertBefore(o, chartMonthSelector.firstChild); o.selected=true;} }


            function renderCharts(selectedMonthYear) { // ONLY Hours Chart
                const [selectedMonth, selectedYear] = selectedMonthYear.split('/').map(Number);
                 const entriesForSelectedMonth = recordedEntries.filter(entry => { const d = new Date(entry.date + 'T00:00:00'); return d.getMonth() + 1 === selectedMonth && d.getFullYear() === selectedYear; });
                 const daysInSelectedMonth = new Date(selectedYear, selectedMonth, 0).getDate();
                 const dailyHours = Array(daysInSelectedMonth).fill(0);
                 entriesForSelectedMonth.forEach(entry => { dailyHours[new Date(entry.date + 'T00:00:00').getDate() - 1] += entry.hours; });
                 const labels = Array.from({ length: daysInSelectedMonth }, (_, i) => i + 1);

                 // Destroy existing chart
                 if (monthlyHoursChartInstance) { monthlyHoursChartInstance.destroy(); }

                 // Create Bar Chart
                 monthlyHoursChartInstance = new Chart(monthlyHoursChartCtx, {
                    type: 'bar',
                     data: { labels: labels, datasets: [{ label: `Horas Diárias (${selectedMonthYear})`, data: dailyHours, backgroundColor: primaryColor, borderColor: primaryColor, borderWidth: 0, borderRadius: 4 }] }, // Adjusted styling
                     options: {
                         responsive: true, maintainAspectRatio: false,
                         scales: {
                             y: { beginAtZero: true, title: { display: false }, ticks: { color: textMutedColor, padding: 10 }, grid: { color: gridColor, drawBorder: false } },
                             x: { title: { display: false }, ticks: { color: textMutedColor }, grid: { display: false } } // Hide x-axis grid lines
                         },
                         plugins: {
                             tooltip: {
                                backgroundColor: tooltipBgColor, titleColor: textColor, bodyColor: textColor, displayColors: false, padding: 10, cornerRadius: 6,
                                callbacks: { label: ctx => `Dia ${ctx.label}: ${ctx.parsed.y !== null ? ctx.parsed.y.toFixed(1) : 0}h` }
                             },
                             legend: { display: false } // Hide legend
                         }
                    }
                });
                 // Removed Activity Chart logic
            }

             function updateAllStatsAndCharts() { /* ... (Only calls update for hours chart) ... */
                 updateStatistics(); populateMonthSelector();
                 const selectedMonth = chartMonthSelector.value || getMonthYearString(new Date());
                 if (selectedMonth && recordedEntries.length > 0) { renderCharts(selectedMonth); } else { // Clear/Show message if no data
                     if (monthlyHoursChartInstance) monthlyHoursChartInstance.destroy();
                     const ctx = monthlyHoursChartCtx; ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height); ctx.save(); ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = textMutedColor; ctx.font = "14px " + computedStyles.fontFamily; ctx.fillText(recordedEntries.length === 0 ? `Registre suas horas para ver o gráfico.` : `Selecione um mês`, ctx.canvas.width / 2, ctx.canvas.height / 2 ); ctx.restore();
                 }
            }


            // --- Event Listeners (Primary Form Date Toggle already added) ---
            recordForm.addEventListener('submit', handleRecordSubmit);
            clearRecordFormBtn.addEventListener('click', clearRecordForm);
            planForm.addEventListener('submit', handlePlanSubmit);
            clearPlanFormBtn.addEventListener('click', clearPlanForm);
            saveGoalBtn.addEventListener('click', handleGoalSave);
            monthlyGoalInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') { e.preventDefault(); handleGoalSave(); monthlyGoalInput.blur(); } });
            chartMonthSelector.addEventListener('change', (event) => { if (event.target.value) renderCharts(event.target.value); });
            clearAllDataBtn.addEventListener('click', handleClearAllData);


            // --- Initialization ---
             function init() {
                 console.log("Initializing Pioneer Tracker (Apple Dark Style)...");
                 loadData(); // Load existing data first
                 recordDateInput.value = getCurrentDateString(); // Set default hidden date
                 setDateInputVisibility(false); // Ensure date starts hidden and label correct
                 clearRecordForm(); // Reset form state
                 clearPlanForm();
                 renderHistory(); renderPlanning();
                  // Initial Card State (Ensure record card is expanded, others collapsed)
                  document.querySelectorAll('.card').forEach(card => {
                      const shouldBeExpanded = (card.id === 'record-card');
                       if (card.classList.contains('expanded') !== shouldBeExpanded) {
                            toggleCard(card); // Only toggle if state is wrong
                       } else {
                            // Ensure icon matches state even if not toggling
                           const icon = card.querySelector('.toggle-icon');
                           if(icon) icon.textContent = shouldBeExpanded ? '▲' : '▼';
                       }
                  });
                 updateAllStatsAndCharts();
                 console.log("Initialization complete.");
             }

            init();

        }); // End DOMContentLoaded
    </script>

</body>
</html>