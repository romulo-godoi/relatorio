<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pioneer Field Service Log</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0A84FF">
    <link rel="apple-touch-icon" href="icon-192x192.png">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script> <script src="https://cdn.jsdelivr.net/npm/gun/sea.js"></script>

    <style>
        :root {
            --system-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --primary-color: #0A84FF; --secondary-color: #000000; --card-bg: #1c1c1e; --input-bg: #2c2c2e;
            --text-color: #ffffff; --text-color-secondary: rgba(235, 235, 245, 0.7); --text-color-tertiary: rgba(235, 235, 245, 0.55);
            --border-color: #3a3a3c; --separator-color: rgba(58, 58, 60, 0.6); --shadow-color: rgba(0, 0, 0, 0.2);
            --danger-color: #FF453A; --success-color: #30D158; --success-color-darker: #249a41;
            --placeholder-color: rgba(235, 235, 245, 0.3); --dialog-backdrop: rgba(0, 0, 0, 0.7);
            --progress-track-color: #38383a; --progress-bar-color: var(--success-color);
            --chart-color-1: #0A84FF; --chart-color-2: #30D158; --chart-color-3: #FF9F0A; --chart-color-4: #AF52DE;
            --chart-color-5: #5E5CE6; --chart-color-6: #FF69B4; --chart-color-7: #32CD32; --chart-color-8: #FFD700;
            --font-family: var(--system-font); --border-radius: 10px; --border-radius-large: 12px;
            --card-padding: 18px; --outer-padding: 15px; --transition-speed: 0.3s; --transition-speed-fast: 0.1s;
            --content-transition: max-height 0.35s ease-out, opacity 0.25s ease-out 0.1s, padding 0.35s ease-out, margin 0.35s ease-out;
            --dashboard-border-thickness: 2px; --progress-percent: 0;
            --celebrate-color-1: #fbc531; --celebrate-color-2: #e84118; --celebrate-color-3: #4cd137;
            --celebrate-color-4: #487eb0; --celebrate-color-5: #9c88ff;
            --primary-gradient: linear-gradient(45deg, var(--primary-color), #5856d6);
            --glass-bg: rgba(50, 50, 52, 0.65); --glass-border-color: rgba(255, 255, 255, 0.12); --glass-blur: 16px;
            --glass-bg-met: rgba(255, 255, 255, 0.2); --glass-border-color-met: rgba(255, 255, 255, 0.25);
            --confetti-color-1: #0A84FF; --confetti-color-2: #30D158; --confetti-color-3: #FF9F0A;
            --confetti-color-4: #AF52DE; --confetti-color-5: #FF453A; --confetti-color-6: #5E5CE6;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; } html, body { height: 100%; -webkit-tap-highlight-color: rgba(0,0,0,0); }
        body { font-family: var(--font-family); background-color: var(--secondary-color); color: var(--text-color); line-height: 1.5; padding: var(--outer-padding); overscroll-behavior-y: contain; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; font-size: 16px; }
        [data-translate-key]::before { content: ""; }
        #loading-indicator { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 9999; color: white; font-size: 1.2em; transition: opacity 0.3s ease-out; }
        #loading-indicator.hidden { opacity: 0; pointer-events: none; }
        #app { max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 10px; } h1 { display: none; }
        #dashboard-box { background-color: transparent; border-radius: var(--border-radius); padding: 12px; margin-bottom: 15px; position: relative; overflow: hidden; display: flex; flex-direction: column; align-items: stretch; gap: 10px; z-index: 0; transition: background-color 0.5s ease-out; }
        #dashboard-box::before { content: ''; position: absolute; inset: 0; z-index: -2; border-radius: inherit; background-image: conic-gradient( var(--progress-bar-color) calc(var(--progress-percent) * 1%), var(--progress-track-color) calc(var(--progress-percent) * 1%) ); transition: background-image 0.5s ease-out, opacity 0.4s ease-out; opacity: 1; }
        #dashboard-box::after { content: ''; position: absolute; inset: var(--dashboard-border-thickness); background: var(--card-bg); z-index: -1; border-radius: calc(var(--border-radius) - var(--dashboard-border-thickness)); transition: opacity 0.4s ease-out, background 0.5s ease-out; opacity: 1; }
        #dashboard-box.goal-met { background-color: transparent; } #dashboard-box.goal-met::before { opacity: 0; transition: opacity 0.1s linear; }
        #dashboard-box.goal-met::after { opacity: 1; background: linear-gradient(135deg, var(--celebrate-color-1) 0%, var(--celebrate-color-3) 25%, var(--celebrate-color-4) 50%, var(--celebrate-color-5) 75%, var(--celebrate-color-2) 100% ); background-size: 400% 400%; animation: celebrate-gradient 8s ease infinite; }
        @keyframes celebrate-gradient { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .dashboard-section { background-color: var(--glass-bg); backdrop-filter: blur(var(--glass-blur)); -webkit-backdrop-filter: blur(var(--glass-blur)); border: 1px solid var(--glass-border-color); border-radius: var(--border-radius-large); padding: 15px 20px; position: relative; z-index: 1; overflow: hidden; transition: background-color 0.3s ease, border-color 0.3s ease; display: flex; flex-direction: column; align-items: center; text-align: center; }
        #dashboard-box.goal-met .dashboard-section { background-color: var(--glass-bg-met); border-color: var(--glass-border-color-met); }
        .hero-section { padding-top: 20px; padding-bottom: 20px; }
        #dashboard-month-percentage { font-size: 3.5em; font-weight: 700; line-height: 1; margin-bottom: 8px; margin-top: 0; background: var(--primary-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; text-fill-color: transparent; text-shadow: 0 2px 8px rgba(0, 0, 0, 0.2); letter-spacing: -1px; order: 1; }
        .hero-section > span.dashboard-label[data-translate-key="dashboard.monthGoalLabel"] { font-size: 0.75em; font-weight: 500; color: var(--text-color-secondary); text-transform: uppercase; letter-spacing: 1.5px; margin-top: 0; margin-bottom: 0; order: 2; }
        .metrics-section { padding: 12px 20px; } .metrics-section #dashboard-week-hours.dashboard-value { font-size: 1.7em; font-weight: 500; color: var(--text-color); line-height: 1.1; margin-bottom: 4px; margin-top: 0; }
        .metrics-section span.dashboard-label[data-translate-key="dashboard.weekHoursLabel"] { font-size: 0.7em; font-weight: 600; color: var(--text-color-tertiary); margin-bottom: 0; display: block; text-transform: uppercase; letter-spacing: 1px; }
        .summary-section { padding: 12px 20px; text-align: center; } #dashboard-summary { font-size: 0.85em; color: var(--text-color-secondary); line-height: 1.5; margin-bottom: 0; margin-top: 0; width: 100%; max-width: 95%; }
        #dashboard-summary strong { color: var(--text-color); font-weight: 600; } #dashboard-summary span { display: block; margin-bottom: 4px; } #dashboard-summary #dashboard-forecast span { text-align: center; }
        .plans-section { padding: 15px; gap: 12px; } #dashboard-revisits-section, #dashboard-planned-dates { width: 100%; margin-top: 0; }
        .plans-section .dashboard-label { font-size: 0.7em; font-weight: 600; color: var(--text-color-tertiary); margin-bottom: 5px; display: block; text-transform: uppercase; letter-spacing: 1px; }
        #dashboard-revisit-list, #dashboard-plan-list { list-style: none; padding: 0; margin: 0; text-align: center; font-size: 0.85em; line-height: 1.5; color: var(--text-color-secondary); width: 100%; max-height: 80px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--separator-color) transparent; margin-top: 5px; }
        #dashboard-revisit-list::-webkit-scrollbar, #dashboard-plan-list::-webkit-scrollbar { width: 4px; } #dashboard-revisit-list::-webkit-scrollbar-thumb, #dashboard-plan-list::-webkit-scrollbar-thumb { background-color: var(--separator-color); border-radius: 2px; }
        #dashboard-revisit-list li, #dashboard-plan-list li { margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 2px 6px; border-radius: 4px; transition: background-color var(--transition-speed-fast) ease; }
        #dashboard-revisit-list li:hover, #dashboard-plan-list li:hover { background-color: rgba(255, 255, 255, 0.08); }
        #dashboard-revisit-list li strong, #dashboard-plan-list li strong { color: var(--text-color); font-weight: 600; }
        #dashboard-revisit-list li .revisit-date { color: var(--primary-color); font-weight: 500; margin-right: 5px; } #dashboard-revisit-list li .revisit-name { font-style: italic; } #dashboard-plan-list .plan-warning { font-size: 0.9em; margin-left: 5px; opacity: 0.7; font-style: italic; }
        #dashboard-box.goal-met .dashboard-section, #dashboard-box.goal-met #dashboard-month-percentage { color: rgba(0, 0, 0, 0.8); text-shadow: none; background: none; -webkit-text-fill-color: inherit; text-fill-color: inherit; text-align: center !important; }
        #dashboard-box.goal-met #dashboard-month-percentage { color: #000; }
        #dashboard-box.goal-met .hero-section > span.dashboard-label, #dashboard-box.goal-met .metrics-section span.dashboard-label, #dashboard-box.goal-met #dashboard-summary, #dashboard-box.goal-met #dashboard-plan-list li, #dashboard-box.goal-met #dashboard-forecast, #dashboard-box.goal-met #dashboard-revisit-list li, #dashboard-box.goal-met .plans-section .dashboard-label { color: rgba(0, 0, 0, 0.7); }
        #dashboard-box.goal-met .metrics-section #dashboard-week-hours.dashboard-value, #dashboard-box.goal-met #dashboard-summary strong, #dashboard-box.goal-met #dashboard-plan-list li strong, #dashboard-box.goal-met #dashboard-forecast strong, #dashboard-box.goal-met #dashboard-revisit-list li strong { color: rgba(0, 0, 0, 0.9); }
        #dashboard-box.goal-met #dashboard-revisit-list li .revisit-date { color: rgba(0, 0, 0, 0.8); }
        #dashboard-box.goal-met #dashboard-plan-list li:hover, #dashboard-box.goal-met #dashboard-revisit-list li:hover { background-color: transparent; }
        #confetti-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; overflow: hidden; z-index: 10; opacity: 0; transition: opacity 0.5s ease; } #dashboard-box.goal-met #confetti-container { opacity: 1; }
        .confetti { position: absolute; width: 10px; height: 10px; background-color: var(--confetti-color-1); opacity: 0; border-radius: 2px; animation: confetti-fall 4s ease-out infinite; }
        @keyframes confetti-fall { 0% { transform: translateY(-10vh) rotateZ(0deg); opacity: 1; } 100% { transform: translateY(110vh) rotateZ(720deg); opacity: 0; } }
        .card { background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; transition: box-shadow var(--transition-speed) ease; }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 15px var(--card-padding); cursor: pointer; transition: background-color var(--transition-speed-fast) ease; position: relative; }
        .card-header::after { content: ''; position: absolute; bottom: 0; left: var(--card-padding); right: var(--card-padding); height: 1px; background-color: var(--border-color); opacity: 1; transition: opacity var(--transition-speed-fast) ease; }
        .card.expanded .card-header::after { opacity: 0; } .card:not(.expanded) .card-header:hover { background-color: rgba(255, 255, 255, 0.03); }
        .card-header h2 { color: var(--text-color); margin-bottom: 0; font-size: 1.15em; font-weight: 600; pointer-events: none; }
        .toggle-icon { font-size: 0.8em; font-weight: bold; transition: transform var(--transition-speed) ease; color: var(--text-color-secondary); margin-left: 10px; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; pointer-events: none; }
        .card.expanded .toggle-icon { transform: rotate(180deg); }
        .card-content { padding: 0 var(--card-padding); max-height: 0; opacity: 0; overflow: hidden; border-top: 1px solid var(--border-color); transition: var(--content-transition); margin-top: -1px; }
        .card.expanded .card-content { padding-top: var(--card-padding); padding-bottom: calc(var(--card-padding) + 5px); max-height: 1500px; opacity: 1; margin-top: 0; overflow: visible; }
        .form-group { margin-bottom: 16px; } label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color-secondary); font-size: 0.9em; }
        input[type="date"], input[type="number"], input[type="text"], input[type="search"], input[type="password"], textarea, select { width: 100%; padding: 11px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; font-family: var(--font-family); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-color: var(--input-bg); color: var(--text-color); }
        input[type="text"].time-input { font-variant-numeric: tabular-nums; }
        input[type="search"] { padding-right: 35px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgba(235, 235, 245, 0.6)" class="bi bi-search" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>'); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px 16px; }
        input[type="search"]::-webkit-search-cancel-button{ appearance: none; height: 14px; width: 14px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgba(235, 235, 245, 0.6)" class="bi bi-x-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>'); background-size: 14px 14px; cursor: pointer; }
        select { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgba(235, 235, 245, 0.6)" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>'); background-repeat: no-repeat; background-position: right 14px center; background-size: 12px 12px; padding-right: 40px; }
        select:focus { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%230A84FF" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>'); }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; } input::placeholder, textarea::placeholder { color: var(--placeholder-color); opacity: 1; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3); }
        input[type="number"], input[type="password"][inputmode="numeric"] { -moz-appearance: textfield; } input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button, input[type="password"][inputmode="numeric"]::-webkit-inner-spin-button, input[type="password"][inputmode="numeric"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        textarea { resize: vertical; min-height: 90px; } #record-form-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        button { background-color: var(--primary-color); color: var(--text-color); border: none; padding: 11px 22px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease, filter var(--transition-speed-fast) ease; display: inline-block; margin-right: 8px; margin-top: 10px; width: auto; transform: scale(1); filter: brightness(1); -webkit-user-select: none; user-select: none; }
        button:hover { filter: brightness(1.15); } button:active { transform: scale(0.95); filter: brightness(0.8); transition-duration: 0.05s; }
        button.secondary { background-color: var(--input-bg); color: var(--primary-color); border: 1px solid var(--border-color); } button.secondary:hover { background-color: #3a3a3c; filter: none; } button.secondary:active { background-color: #48484a; transform: scale(0.96); filter: brightness(1); }
        button.success { background-color: var(--success-color); color: var(--text-color); } button.success:hover { filter: brightness(1.15); } button.success:active { transform: scale(0.95); filter: brightness(0.8); }
        button.danger { background-color: var(--danger-color); color: var(--text-color); } button.danger:hover { background-color: #ff3b30; filter: brightness(1.15); } button.danger:active { background-color: #E0352D; transform: scale(0.96); filter: brightness(0.85); }
        button.info { background-color: var(--primary-color); } button.info:hover { filter: brightness(1.15); }
        .text-center button { width: auto; margin-right: 8px; } .text-center button:last-child { margin-right: 0; }
        .change-date-button { background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 0.9em; padding: 5px 0; margin-left: 5px; text-align: left; width: auto; margin-right: 0; margin-top: 0; } .change-date-button:hover { text-decoration: underline; } .change-date-button:active { transform: scale(0.95); filter: brightness(0.8); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; text-align: center; margin-top: 10px;}
        .stat-item { background-color: var(--input-bg); padding: 16px 12px; border-radius: 8px; }
        .stat-value { font-size: 1.7em; font-weight: 600; color: var(--text-color); display: block; margin-bottom: 2px; }
        .stat-label { font-size: 0.85em; color: var(--text-color-secondary); }
        .progress-bar-container { background-color: var(--border-color); border-radius: 5px; overflow: hidden; height: 8px; margin-top: 8px; }
        .progress-bar { background-color: var(--progress-bar-color); height: 100%; width: 0; transition: width var(--transition-speed) ease-out; }
        #history-controls { margin-bottom: 15px; display: flex; gap: 10px; padding: 0 var(--card-padding) } .history-search-input { flex-grow: 1; }
        #showing-results-label { font-size: 0.85em; color: var(--text-color-secondary); margin-top: 5px; display: block; text-align: right; padding: 0 var(--card-padding) 5px var(--card-padding) ; min-height: 1.2em;}
        .data-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; margin-top: 0; scrollbar-width: thin; scrollbar-color: var(--border-color) transparent; }
        .data-list::-webkit-scrollbar { width: 5px; } .data-list::-webkit-scrollbar-thumb { background-color: var(--border-color); border-radius: 3px; }
        .data-list li { background-color: transparent; border-bottom: 1px solid var(--border-color); padding: 14px var(--card-padding); margin: 0; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; transition: background-color var(--transition-speed-fast) ease; }
        .data-list li:last-child { border-bottom: none; } .data-list li:hover { background-color: rgba(255, 255, 255, 0.02); }
        .entry-details { font-size: 0.95em; flex-grow: 1; margin-right: 10px; line-height: 1.4; padding-bottom: 5px; word-break: break-word; }
        .entry-details strong { color: var(--text-color); font-weight: 500; } .entry-details .hours { color: var(--primary-color); font-weight: 600; margin-left: 5px; margin-right: 5px; white-space: nowrap; }
        .entry-details .tag-badge { display: inline-block; background-color: var(--input-bg); color: var(--text-color-secondary); font-size: 0.75em; padding: 2px 6px; border-radius: 5px; margin-left: 8px; vertical-align: middle; white-space: nowrap; }
        .entry-details .notes-preview { color: var(--text-color-secondary); font-size: 0.9em; display: block; margin-top: 5px; white-space: normal; overflow-wrap: break-word; max-height: 4.5em; overflow: hidden; }
        .entry-details .revisit-completed-marker { display: inline-block; background-color: var(--success-color); color: var(--text-color); font-size: 0.7em; font-weight: 600; padding: 2px 5px; border-radius: 4px; margin-right: 8px; vertical-align: middle; text-transform: uppercase; }
        .entry-details .revisit-scheduled-date { font-size: 0.85em; color: var(--text-color-secondary); margin-left: 8px; } .entry-details .revisit-scheduled-date strong { color: var(--primary-color); font-weight: 500; }
        .entry-actions, .plan-actions, .revisit-actions { flex-shrink: 0; align-self: center; margin-left: auto; }
        .entry-actions button, .plan-actions button, .revisit-actions button { padding: 6px 10px; font-size: 0.85em; margin-left: 5px; margin-top: 0; width: auto; border-radius: 6px; }
        .plan-actions button, .revisit-actions button { margin-top: 5px; } .entry-actions button.secondary, .plan-actions button.secondary, .revisit-actions button.secondary { background-color: #3a3a3c; }
        .chart-container { position: relative; min-height: 300px; max-height: 400px; width: 100%; margin-top: 15px; }
        .chart-summary-text { text-align: center; font-size: 0.95em; font-weight: 500; color: var(--text-color-secondary); margin-bottom: 10px; margin-top: 5px; min-height: 1.3em; padding: 0 var(--card-padding); }
        .dialog-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--dialog-backdrop); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease; }
        .dialog-backdrop.visible { opacity: 1; visibility: visible; }
        .dialog-content { background-color: #2c2c2e; color: var(--text-color); padding: 25px; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); text-align: center; max-width: 90%; width: 320px; transform: scale(0.95); transition: transform var(--transition-speed) ease; }
        .dialog-backdrop.visible .dialog-content { transform: scale(1); } .dialog-content p { margin-bottom: 25px; font-size: 1.05em; line-height: 1.5; }
        .dialog-actions button { width: calc(50% - 5px); margin-top: 0; padding: 10px; font-size: 1em;}
        #data-management-buttons { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; } #last-export-date, #sync-status-display { font-size: 0.85em; color: var(--text-color-secondary); text-align: center; margin-top: 15px; min-height: 1.2em; }
        .hidden { display: none !important; } .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        .text-center { text-align: center; } .mt-1 { margin-top: 10px; } .mt-2 { margin-top: 20px; }
        h3.list-title { font-size: 1em; font-weight: 600; color: var(--text-color-secondary); margin-bottom: 10px; padding-left: var(--card-padding); }
        .data-list li.placeholder { padding-left: var(--card-padding); color: var(--text-color-secondary); font-style: italic; border-bottom: none; }
        .sync-settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--dialog-backdrop); display: flex; justify-content: center; align-items: center; z-index: 1050; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease; }
        .sync-settings-modal.active { opacity: 1; visibility: visible; }
        .sync-settings-modal .modal-content { background-color: var(--input-bg); color: var(--text-color); padding: 25px; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); max-width: 90%; width: 400px; position: relative; }
        .sync-settings-modal .modal-content h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.2em; }
        .sync-settings-modal .modal-content p { margin-bottom: 10px; font-size: 0.9em; color: var(--text-color-secondary); }
        .sync-settings-modal .modal-content p.text-xs { font-size: 0.8em; color: var(--text-color-tertiary); margin-top:5px; }
        .sync-settings-modal .modal-content .form-group { margin-bottom: 20px; }
        .sync-settings-modal .modal-content button { margin-top: 10px; width:100%; }
        .sync-settings-modal .modal-content .close-btn { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 1.5em; color: var(--text-color-secondary); cursor: pointer; padding: 5px; line-height: 1; width: auto; margin:0; }
        .sync-settings-modal .modal-content .close-btn:hover { color: var(--text-color); }
        #sync-pin-status {text-align:center; font-size:0.9em; margin-top:15px; min-height:1.3em;}
        @media (min-width: 768px) {
            :root { --card-padding: 20px; --outer-padding: 20px; --dashboard-border-thickness: 3px; --glass-blur: 18px; } #app { max-width: 860px; gap: 12px; } #dashboard-box { padding: 15px; gap: 12px; } .dashboard-section { padding: 20px 25px; } .hero-section { padding-top: 25px; padding-bottom: 25px; } #dashboard-month-percentage { font-size: 4em; } .metrics-section #dashboard-week-hours.dashboard-value { font-size: 2em; } .summary-section { padding: 18px 25px; } #dashboard-summary { font-size: 0.9em; } .plans-section { padding: 18px 20px; } #dashboard-plan-list, #dashboard-revisit-list { max-height: 90px; font-size: 0.9em; } #record-form-grid { grid-template-columns: 1fr 1fr; }
            #plan-form { display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end; } #plan-form .form-group { margin-bottom: 0; } #plan-form .text-center { grid-column: 3 / 4; text-align: right; } #plan-form .text-center button { margin-top: 0; }
            .stats-grid { grid-template-columns: repeat(4, 1fr); gap: 15px; } .data-list li { flex-wrap: nowrap; align-items: center; } .entry-details { padding-bottom: 0; } .entry-actions, .plan-actions, .revisit-actions { white-space: nowrap; margin-top: 0; } .dialog-content { max-width: 400px; }
            #charts-card .card-content > .form-group { display: flex; align-items: center; gap: 20px; margin-bottom: 10px; } #charts-card .card-content > .form-group label { margin-bottom: 0; flex-shrink: 0; } #charts-card .card-content > .form-group select { flex-grow: 1; max-width: 250px; } #chart-total-hours-display { text-align: left; margin-left: auto; margin-bottom: 0; padding: 0; }
        }
        @media (min-width: 1200px) { :root { --glass-blur: 20px; } #app { max-width: 960px; } #dashboard-box { padding: 18px; gap: 15px; } .dashboard-section { padding: 25px 30px; } #dashboard-month-percentage { font-size: 4.5em; letter-spacing: -2px; } .metrics-section #dashboard-week-hours.dashboard-value { font-size: 2.2em; } }
    </style>
</head>
<body>
    <div id="loading-indicator">Loading...</div>

    <div id="dashboard-box">
        <div id="confetti-container"></div>
        <div class="dashboard-section hero-section">
            <span id="dashboard-month-percentage" class="dashboard-value">0%</span>
            <span class="dashboard-label" data-translate-key="dashboard.monthGoalLabel">Meta Mensal</span>
        </div>
        <div class="dashboard-section metrics-section">
            <span class="dashboard-label" data-translate-key="dashboard.weekHoursLabel">Horas da Semana</span>
            <span id="dashboard-week-hours" class="dashboard-value">0</span>
        </div>
        <div class="dashboard-section summary-section">
             <div id="dashboard-summary">
                 <span id="dashboard-month-total">Total Mês: <strong>0h</strong></span>
                 <span id="dashboard-forecast">Defina sua meta...</span>
             </div>
        </div>
        <div class="dashboard-section plans-section hidden">
            <div id="dashboard-revisits-section" class="hidden">
                <span class="dashboard-label" data-translate-key="dashboard.upcomingRevisitsLabel">Próximas Revisitas</span>
                <ul id="dashboard-revisit-list"></ul>
            </div>
            <div id="dashboard-planned-dates" class="hidden">
                <span class="dashboard-label" data-translate-key="dashboard.plannedTripsLabel">Planos Próximos</span>
                <ul id="dashboard-plan-list"></ul>
            </div>
        </div>
    </div>

    <div id="app">
        <div class="card expanded" id="record-card"><div class="card-header"> <h2 data-translate-key="recordCard.title">Registrar Atividade</h2> <span class="toggle-icon">▲</span></div><div class="card-content"><form id="record-form"><input type="hidden" id="record-id"><div class="form-group"><label for="record-date" id="date-label"><span data-translate-key="recordCard.dateLabel">Data</span>: <strong id="display-date">Hoje</strong><button type="button" class="change-date-button" id="change-date-btn" data-translate-key="recordCard.changeDateButton">Alterar</button></label><input type="date" id="record-date" class="hidden"></div><div id="record-form-grid"><div class="form-group"><label for="record-hours" data-translate-key="recordCard.timeLabel">Tempo (HH:MM)</label><input type="text" inputmode="numeric" id="record-hours" class="time-input" required data-translate-key="recordCard.timePlaceholder" data-translate-attr="placeholder" placeholder="Ex: 2:30"></div><div class="form-group"><label for="record-tag" data-translate-key="recordCard.tagLabel">Tipo</label><select id="record-tag"></select></div></div><div class="form-group"><label for="record-notes" id="record-notes-label" data-translate-key="recordCard.notesLabel">Notas (Opcional)</label><textarea id="record-notes" rows="3" data-translate-key="recordCard.notesPlaceholder" data-translate-attr="placeholder" placeholder="Detalhes da atividade..."></textarea></div><div class="text-center" style="margin-top: 20px;"><button type="submit" id="save-record-btn" data-translate-key="recordCard.saveButton">Salvar</button></div></form></div></div>
        <div class="card" id="revisit-card"><div class="card-header"><h2 data-translate-key="revisitCard.title">Revisitas</h2><span class="toggle-icon">▼</span></div><div class="card-content"><form id="revisit-form"><input type="hidden" id="revisit-id"><div class="form-group"><label for="revisit-name" data-translate-key="revisitCard.nameLabel">Nome/Contato</label><input type="text" id="revisit-name" required data-translate-key="revisitCard.namePlaceholder" data-translate-attr="placeholder" placeholder="Nome ou identificação"></div><div class="form-group"><label for="revisit-date" data-translate-key="revisitCard.dateLabel">Data Agendada (Opcional)</label><input type="date" id="revisit-date"></div><div class="form-group"><label for="revisit-notes" data-translate-key="revisitCard.notesLabel">Notas</label><textarea id="revisit-notes" rows="2" data-translate-key="revisitCard.notesPlaceholder" data-translate-attr="placeholder" placeholder="Assunto, local, etc."></textarea></div><div class="text-center"><button type="submit" id="save-revisit-btn" data-translate-key="revisitCard.addButton">Adicionar Revisita</button><button type="button" id="clear-revisit-form-btn" class="secondary" data-translate-key="revisitCard.clearButton">Limpar</button></div></form><div id="revisit-list-container" class="mt-2"><h3 class="list-title" data-translate-key="revisitCard.pendingListTitle">Pendentes</h3><ul id="revisit-list" class="data-list"><li class="placeholder hidden" data-translate-key="revisitCard.listPlaceholderNoPending">Nenhuma revisita pendente.</li></ul></div></div></div>
        <div class="card" id="plan-card"><div class="card-header"><h2 data-translate-key="planCard.title">Planejamento</h2><span class="toggle-icon">▼</span></div><div class="card-content"><form id="plan-form"><input type="hidden" id="plan-id"><div class="form-group"><label for="plan-date" data-translate-key="planCard.dateLabel">Data</label><input type="date" id="plan-date" required></div><div class="form-group"><label for="plan-hours" data-translate-key="planCard.hoursLabel">Horas Planejadas</label><input type="text" inputmode="numeric" id="plan-hours" class="time-input" required data-translate-key="planCard.hoursPlaceholder" data-translate-attr="placeholder" placeholder="Ex: 3:00"></div><div class="text-center"><button type="submit" id="save-plan-btn" data-translate-key="planCard.saveButton">Salvar Plano</button><button type="button" id="clear-plan-form-btn" class="secondary" data-translate-key="planCard.clearButton">Limpar</button></div></form><div id="planning-list-container" class="mt-2"><h3 class="list-title" data-translate-key="planCard.listTitle">Datas Planejadas</h3><ul id="planning-list" class="data-list"><li class="placeholder hidden" data-translate-key="planCard.listPlaceholderNoPastOrFuture">Nenhum planejamento registrado.</li></ul></div></div></div>
        <div class="card" id="stats-card"><div class="card-header"><h2 data-translate-key="statsCard.title">Estatísticas do Mês</h2><span class="toggle-icon">▼</span></div><div class="card-content"><div class="form-group" style="max-width: 200px; margin: 0 auto 25px auto; text-align:center;"><label for="monthly-goal" data-translate-key="statsCard.goalLabel">Meta Mensal (Horas)</label><input type="number" id="monthly-goal" min="1" step="1" value="70"><button id="save-goal-btn" class="mt-1 secondary" style="width:100%; font-size:0.9em; padding: 8px 10px;" data-translate-key="statsCard.setGoalButton">Definir Meta</button></div><div class="stats-grid"><div class="stat-item"><span id="stats-month-hours" class="stat-value">0</span><span class="stat-label" data-translate-key="statsCard.monthHoursLabel">Horas no Mês</span></div><div class="stat-item"><span id="stats-month-goal-progress" class="stat-value">0%</span><span class="stat-label" data-translate-key="statsCard.goalProgressLabel">Progresso da Meta</span><div class="progress-bar-container"><div id="stats-month-progress-bar" class="progress-bar"></div></div></div><div class="stat-item"><span id="stats-avg-hours-day" class="stat-value">0</span><span class="stat-label" data-translate-key="statsCard.avgHoursDayLabel">Média / Dia Ativo</span></div><div class="stat-item"><span id="stats-month-days-active" class="stat-value">0</span><span class="stat-label" data-translate-key="statsCard.daysActiveLabel">Dias Ativos</span></div></div></div></div>
        <div class="card" id="charts-card"><div class="card-header"><h2 data-translate-key="chartsCard.title">Gráficos</h2><span class="toggle-icon">▼</span></div><div class="card-content"><div class="form-group"> <label for="chart-month-selector" data-translate-key="chartsCard.monthSelectorLabel">Selecionar Mês:</label><select id="chart-month-selector"></select><p id="chart-total-hours-display" class="chart-summary-text"></p> </div><div class="chart-container"><canvas id="monthlyHoursChart"></canvas></div></div></div>
        <div class="card" id="history-card"><div class="card-header"><h2 data-translate-key="historyCard.title">Histórico</h2><span class="toggle-icon">▼</span></div><div class="card-content"><div id="history-controls"><input type="search" id="history-search-input" class="history-search-input" data-translate-key="historyCard.searchPlaceholder" data-translate-attr="placeholder" placeholder="Buscar por data, horas, tipo ou nota..."></div><span id="showing-results-label"></span><ul id="history-list" class="data-list"><li class="placeholder hidden" data-translate-key="historyCard.listPlaceholderNoRecords">Nenhum registro encontrado.</li></ul></div></div>
        <div class="card" id="settings-card">
            <div class="card-header"><h2 data-translate-key="settingsCard.title">Configurações</h2><span class="toggle-icon">▼</span></div>
            <div class="card-content">
                <h3 class="list-title" data-translate-key="settingsCard.dataManagementTitle">Gerenciamento de Dados</h3>
                <div id="data-management-buttons">
                    <button id="import-data-btn" class="secondary" data-translate-key="settingsCard.importButton">Importar Dados</button>
                    <button id="export-data-btn" data-translate-key="settingsCard.exportButton">Exportar Dados</button>
                </div>
                <input type="file" id="import-file-input" class="hidden" accept=".json">
                <p id="last-export-date" data-translate-key="settingsCard.lastExportLabel">Última exportação: Nunca</p>
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <h3 class="list-title" data-translate-key="sync.title">Sincronização P2P</h3>
                <button id="open-sync-settings-btn" class="secondary" data-translate-key="sync.openSettingsButton">Configurar Sincronização</button>
                <p id="sync-status-display" data-translate-key="sync.statusDefault">Status: Desconectado</p>
                <hr style="border: none; border-top: 1px solid var(--border-color); margin: 20px 0;">
                <div class="form-group">
                    <label for="language-selector" data-translate-key="settingsCard.languageLabel">Idioma</label>
                    <select id="language-selector"></select>
                </div>
            </div>
        </div>
    </div>

    <div id="confirmation-dialog" class="dialog-backdrop"><div class="dialog-content"><p id="dialog-message">Você tem certeza?</p><div class="dialog-actions"><button id="dialog-confirm-btn" class="danger" data-translate-key="dialog.confirmButton">Confirmar</button><button id="dialog-cancel-btn" class="secondary" data-translate-key="dialog.cancelButton">Cancelar</button></div></div></div>
    <div id="sync-settings-modal" class="sync-settings-modal">
        <div class="modal-content">
            <button id="close-sync-settings-btn" class="close-btn" aria-label="Fechar">&times;</button>
            <h3 data-translate-key="sync.settingsTitle">Configurações de Sincronização</h3>
            <p data-translate-key="sync.settingsDesc">Insira uma chave numérica (PIN) para sincronizar seus dados apenas com dispositivos que usem a mesma chave. Deixe em branco para desativar.</p>
            <div class="form-group">
                <label for="sync-pin-input" data-translate-key="sync.pinLabel">Chave Numérica (PIN):</label>
                <input type="password" id="sync-pin-input" inputmode="numeric" pattern="[0-9]*" data-translate-key="sync.pinPlaceholder" data-translate-attr="placeholder" placeholder="Ex: 123456">
                <p class="text-xs" data-translate-key="sync.pinHelper">Use apenas números. Recomendado 6+ dígitos.</p>
            </div>
            <button id="save-sync-pin-btn" class="info" data-translate-key="sync.savePinButton">Salvar Chave e Reiniciar Sincronização</button>
            <p id="sync-pin-status"></p>
        </div>
    </div>

    <script>
        (async () => {
            let translations = {}; let currentLang = 'en'; const supportedLanguages = ["pt-BR", "en", "es", "de", "fr"];
            const tagKeyMapping = {"Casa em casa": "tags.houseToHouse", "Carrinho": "tags.cart", "Cartas": "tags.letters", "Testemunho informal": "tags.informalWitnessing", "Outro": "tags.other" };
            const DEFAULT_TAG_VALUE = "Casa em casa"; const NOTES_MAX_LENGTH = 300; const REVISIT_NOTES_MAX_LENGTH = 500; const HISTORY_MONTH_LIMIT = 3; const MIN_HOURS_PER_DAY_FORECAST = 1.0;
            const BASE_LS_KEYS = { ENTRIES: 'pioneerTracker_entries_v5.1', PLANS: 'pioneerTracker_plans_v1.1', REVISITS: 'pioneerTracker_revisits_v1.1', SETTINGS: 'pioneerTracker_settings_v1.2', LAST_EXPORT_DATE: 'pioneerTracker_lastExport_v1.0' };
            const CONFETTI_COUNT = 30; const DASHBOARD_REVISIT_LIMIT = 3;

            let appElement, dashboardBox, confettiContainer, dashboardWeekHours, dashboardMonthPercentage, dashboardMonthTotal, dashboardForecast, dashboardPlannedDatesContainer, dashboardPlanList, recordCard, recordForm, recordIdInput, recordDateInput, dateLabel, displayDate, changeDateBtn, recordHoursInput, recordTagSelect, recordNotesInput, recordNotesLabel, saveRecordBtn, planCard, planForm, planIdInput, planDateInput, planHoursInput, savePlanBtn, clearPlanFormBtn, planningList, planningListPlaceholder, monthlyGoalInput, saveGoalBtn, statsMonthHours, statsMonthGoalProgress, statsMonthProgressBar, statsAvgHoursDay, statsMonthDaysActive, chartMonthSelector, monthlyHoursChartCtx, historyList, historySearchInput, historyListPlaceholder, showingResultsLabel, confirmationDialog, dialogMessage, dialogConfirmBtn, dialogCancelBtn, computedStyles, textColor, textMutedColor, tooltipBgColor, chartTotalHoursDisplay, chartColors = [];
            let revisitCard, revisitForm, revisitIdInput, revisitNameInput, revisitDateInput, revisitNotesInput, saveRevisitBtn, clearRevisitFormBtn, revisitListContainer, revisitList, revisitListPlaceholder, dashboardRevisitsSection, dashboardRevisitList, plansSection;
            let exportDataBtn, importDataBtn, importFileInput, lastExportDateDisplay, languageSelector;
            let openSyncSettingsBtn, syncSettingsModal, closeSyncSettingsBtn, syncPinInput, saveSyncPinBtn, syncPinStatus, syncStatusDisplay;

            let recordedEntries = [], plannedEntries = [], revisits = [];
            const defaultSettings = { monthlyGoal: 70, goalHasBeenSet: false, language: null };
            let settings = { ...defaultSettings };
            let lastExportTimestamp = null;

            let monthlyHoursChartInstance = null, currentEditingId = null, currentConfirmCallback = null, isDateInputVisible = false, deferredInstallPrompt = null;
            let MONTH_NAMES = [], WEEKDAY_NAMES = []; let lastCheckedDateString = ''; let dateCheckInterval = null; let confettiTimeout = null; const loadingIndicator = document.getElementById('loading-indicator');

            const SYNC_PIN_STORAGE_KEY = 'pioneerLog_sync_pin_v1'; const GUN_PEERS = ['https://gun-manhattan.herokuapp.com/gun', 'https://gunjs.herokuapp.com/gun'];
            const GUN_NODE_PREFIX = 'pioneerLogSync_';
            const NODE_KEYS = { ENTRIES: 'entries', PLANS: 'plans', REVISITS: 'revisits', SETTINGS: 'settings', LAST_EXPORT: 'lastExport' };
            let gun, entriesGun, plansGun, revisitsGun, settingsGun, lastExportTimestampGun;
            let currentSyncPin = null; let isSyncInitialized = false;

            if (loadingIndicator) loadingIndicator.classList.remove('hidden');

            function getNestedValue(o,k){if(!k||typeof k!=='string')return undefined;return k.split('.').reduce((a,p)=>a&&a[p]!==undefined?a[p]:undefined,o);}
            function t(k,v={}){const l=translations?.[currentLang]||translations?.['en'];if(!l){console.error(`Lang missing: ${currentLang} & 'en'. Key: ${k}`);return `[NO LANG: ${k}]`;}let tr=getNestedValue(l,k);if(tr===undefined){const fl=translations['en'];if(fl)tr=getNestedValue(fl,k);if(tr===undefined)return `[MISSING: ${k}]`;}if(typeof tr!=='string'){return `[TYPE ERR: ${k}]`;}for(const p in v){if(Object.prototype.hasOwnProperty.call(v,p)){tr=tr.replace(new RegExp(`\\{${p}\\}`, 'g'),v[p]);}}return tr;}
            function applyStaticTranslations(){document.querySelectorAll('[data-translate-key]').forEach(el=>{const k=el.getAttribute('data-translate-key');const a=el.getAttribute('data-translate-attr')||'textContent';const tr=t(k);if(tr&&!tr.startsWith('[')){if(a==='textContent')el.textContent=tr;else if(['placeholder','title','value'].includes(a))el.setAttribute(a,tr);}});if(recordTagSelect){const cV=recordTagSelect.value;recordTagSelect.innerHTML='';Object.keys(tagKeyMapping).forEach(iV=>{const o=document.createElement('option');o.value=iV;o.textContent=t(tagKeyMapping[iV]||'tags.noTag');recordTagSelect.appendChild(o);});if(recordTagSelect.querySelector(`option[value="${cV}"]`))recordTagSelect.value=cV;else recordTagSelect.value=DEFAULT_TAG_VALUE;}document.title=t('appTitle');document.documentElement.lang=currentLang.split('-')[0];if(recordNotesLabel)recordNotesLabel.textContent=t('recordCard.notesLabel',{maxLength:NOTES_MAX_LENGTH});if(recordNotesInput)recordNotesInput.maxLength=NOTES_MAX_LENGTH;if(revisitNotesInput)revisitNotesInput.maxLength=REVISIT_NOTES_MAX_LENGTH;if(loadingIndicator&&!loadingIndicator.classList.contains('hidden'))loadingIndicator.textContent=t('common.loading');updateLastExportDateDisplay();populateLanguageSelector();updateSyncStatusDisplay();}

            async function loadTranslations(){try{const r=await fetch('translations.json');if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);translations=await r.json();const sL=settings.language;const bL=navigator.language||'en';const bLng=bL.split('-')[0];if(sL&&translations[sL]&&supportedLanguages.includes(sL)){currentLang=sL;}else if(translations[bL]&&supportedLanguages.includes(bL)){currentLang=bL;}else if(translations[bLng]&&supportedLanguages.includes(bLng)){currentLang=bLng;}else if(translations['en']){currentLang='en';}else{throw new Error("'en' language file missing");}console.log("Language selected:",currentLang);if(settings.language!==currentLang){settings.language=currentLang;}MONTH_NAMES=getNestedValue(translations[currentLang],'dates.monthNames')||getNestedValue(translations['en'],'dates.monthNames');WEEKDAY_NAMES=getNestedValue(translations[currentLang],'dates.weekdaysShort')||getNestedValue(translations['en'],'dates.weekdaysShort');if(!Array.isArray(MONTH_NAMES)||MONTH_NAMES.length!==12){MONTH_NAMES=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];}if(!Array.isArray(WEEKDAY_NAMES)||WEEKDAY_NAMES.length!==7){WEEKDAY_NAMES=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];}}catch(e){console.error('FATAL: Translation load error:',e);if(loadingIndicator)loadingIndicator.textContent='Language file error!';alert("Language data error. Check translations.json or network.");MONTH_NAMES=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];WEEKDAY_NAMES=['Dom','Seg','Ter','Qua','Qui','Sex','Sáb'];currentLang='en';settings.language='en';}}

            function getLocalStorageKeyWithSync(baseKey){const sK=currentSyncPin||'public';return`${baseKey}_${sK}`;}
            function getSyncPin(){return localStorage.getItem(SYNC_PIN_STORAGE_KEY);}
            function setSyncPin(pin){const oP=currentSyncPin;if(pin&&pin.trim()!==''){localStorage.setItem(SYNC_PIN_STORAGE_KEY,pin.trim());}else{localStorage.removeItem(SYNC_PIN_STORAGE_KEY);}currentSyncPin=pin?pin.trim():null;if(oP!==currentSyncPin){clearLocalStorageForPin(oP);console.log("Sync PIN changed, restarting sync operations.");initializeSyncFramework(true);}}
            function openSyncSettingsModal(){if(syncPinInput)syncPinInput.value=currentSyncPin||'';if(syncPinStatus)syncPinStatus.textContent='';syncSettingsModal?.classList.add('active');}
            function closeSyncSettingsModal(){syncSettingsModal?.classList.remove('active');}
            function saveSyncPinHandler(){const nPIn=syncPinInput?.value.trim();const sPS=syncPinStatus;if(nPIn!==''&&!/^\d+$/.test(nPIn)){if(sPS){sPS.textContent=t('sync.errorPinNumeric');sPS.style.color='var(--danger-color)';}return;}const oP=currentSyncPin;setSyncPin(nPIn);if(sPS){sPS.textContent=t('sync.pinSavedRestart');sPS.style.color='var(--success-color)';}updateSyncStatusDisplay();setTimeout(()=>{closeSyncSettingsModal();if(oP!==(nPIn||null)){console.log("PIN changed by user, re-initializing.");resetAndInitializeAppSyncData();}else{initializeGunSync();}},1500);}

            function selectDOMElements(){appElement=document.getElementById('app');dashboardBox=document.getElementById('dashboard-box');confettiContainer=document.getElementById('confetti-container');dashboardWeekHours=document.getElementById('dashboard-week-hours');dashboardMonthPercentage=document.getElementById('dashboard-month-percentage');dashboardMonthTotal=document.getElementById('dashboard-month-total');dashboardForecast=document.getElementById('dashboard-forecast');dashboardPlannedDatesContainer=document.getElementById('dashboard-planned-dates');dashboardPlanList=document.getElementById('dashboard-plan-list');recordCard=document.getElementById('record-card');recordForm=document.getElementById('record-form');recordIdInput=document.getElementById('record-id');recordDateInput=document.getElementById('record-date');dateLabel=document.getElementById('date-label');displayDate=document.getElementById('display-date');changeDateBtn=document.getElementById('change-date-btn');recordHoursInput=document.getElementById('record-hours');recordTagSelect=document.getElementById('record-tag');recordNotesInput=document.getElementById('record-notes');recordNotesLabel=document.getElementById('record-notes-label');saveRecordBtn=document.getElementById('save-record-btn');planCard=document.getElementById('plan-card');planForm=document.getElementById('plan-form');planIdInput=document.getElementById('plan-id');planDateInput=document.getElementById('plan-date');planHoursInput=document.getElementById('plan-hours');savePlanBtn=document.getElementById('save-plan-btn');clearPlanFormBtn=document.getElementById('clear-plan-form-btn');planningList=document.getElementById('planning-list');planningListPlaceholder=planningList?.querySelector('.placeholder');monthlyGoalInput=document.getElementById('monthly-goal');saveGoalBtn=document.getElementById('save-goal-btn');statsMonthHours=document.getElementById('stats-month-hours');statsMonthGoalProgress=document.getElementById('stats-month-goal-progress');statsMonthProgressBar=document.getElementById('stats-month-progress-bar');statsAvgHoursDay=document.getElementById('stats-avg-hours-day');statsMonthDaysActive=document.getElementById('stats-month-days-active');chartMonthSelector=document.getElementById('chart-month-selector');monthlyHoursChartCtx=document.getElementById('monthlyHoursChart')?.getContext('2d');chartTotalHoursDisplay=document.getElementById('chart-total-hours-display');historyList=document.getElementById('history-list');historySearchInput=document.getElementById('history-search-input');historyListPlaceholder=historyList?.querySelector('.placeholder');showingResultsLabel=document.getElementById('showing-results-label');confirmationDialog=document.getElementById('confirmation-dialog');dialogMessage=document.getElementById('dialog-message');dialogConfirmBtn=document.getElementById('dialog-confirm-btn');dialogCancelBtn=document.getElementById('dialog-cancel-btn');revisitCard=document.getElementById('revisit-card');revisitForm=document.getElementById('revisit-form');revisitIdInput=document.getElementById('revisit-id');revisitNameInput=document.getElementById('revisit-name');revisitDateInput=document.getElementById('revisit-date');revisitNotesInput=document.getElementById('revisit-notes');saveRevisitBtn=document.getElementById('save-revisit-btn');clearRevisitFormBtn=document.getElementById('clear-revisit-form-btn');revisitListContainer=document.getElementById('revisit-list-container');revisitList=document.getElementById('revisit-list');revisitListPlaceholder=revisitList?.querySelector('.placeholder');dashboardRevisitsSection=document.getElementById('dashboard-revisits-section');dashboardRevisitList=document.getElementById('dashboard-revisit-list');plansSection=document.querySelector('.plans-section');exportDataBtn=document.getElementById('export-data-btn');importDataBtn=document.getElementById('import-data-btn');importFileInput=document.getElementById('import-file-input');lastExportDateDisplay=document.getElementById('last-export-date');languageSelector=document.getElementById('language-selector');openSyncSettingsBtn=document.getElementById('open-sync-settings-btn');syncSettingsModal=document.getElementById('sync-settings-modal');closeSyncSettingsBtn=document.getElementById('close-sync-settings-btn');syncPinInput=document.getElementById('sync-pin-input');saveSyncPinBtn=document.getElementById('save-sync-pin-btn');syncPinStatus=document.getElementById('sync-pin-status');syncStatusDisplay=document.getElementById('sync-status-display');try{computedStyles=getComputedStyle(document.body);}catch(e){computedStyles={};}textColor=computedStyles.getPropertyValue?.('--text-color')?.trim()||'#ffffff';textMutedColor=computedStyles.getPropertyValue?.('--text-color-secondary')?.trim()||'#aaaaaa';tooltipBgColor=computedStyles.getPropertyValue?.('--card-bg')?.trim()||'#1c1c1e';chartColors=['#0A84FF','#30D158','#FF9F0A','#AF52DE','#5E5CE6','#FF69B4','#32CD32','#FFD700'].map((f,i)=>computedStyles.getPropertyValue?.(`--chart-color-${i+1}`)?.trim()||f);}
            function getCurrentDateString(){const t=new Date();return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;}
            function parseLocalDate(dS){if(!dS||!/^\d{4}-\d{2}-\d{2}$/.test(dS))return new Date(NaN);const[y,m,d]=dS.split('-').map(Number);return new Date(y,m-1,d);}
            function formatDisplayDate(dS){if(!dS||!dS.includes('-'))return dS;try{const d=parseLocalDate(dS);if(isNaN(d.valueOf()))throw new Error("Invalid date");const o={day:'2-digit',month:'2-digit',year:'numeric'};return new Intl.DateTimeFormat(currentLang||'default',o).format(d);}catch(e){const[y,m,d]=dS.split('-');return`${d}/${m}/${y}`;}}
            function formatTimestamp(ts){if(!ts)return t('common.never');try{const d=new Date(ts);if(isNaN(d.valueOf()))return t('common.invalidDate');const o={day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'};return new Intl.DateTimeFormat(currentLang||'default',o).format(d);}catch(e){return t('common.invalidDate');}}
            function getMonthYearString(d){const m=String(d.getMonth()+1).padStart(2,'0');const y=d.getFullYear();return`${m}/${y}`;}
            function getStartOfWeek(d=new Date()){const dt=new Date(d);dt.setHours(0,0,0,0);const dOW=dt.getDay();const diff=dt.getDate()-dOW;const sOW=new Date(dt.setDate(diff));return`${sOW.getFullYear()}-${String(sOW.getMonth()+1).padStart(2,'0')}-${String(sOW.getDate()).padStart(2,'0')}`;}
            function getDateMonthsAgo(mths){const d=new Date();d.setHours(0,0,0,0);d.setMonth(d.getMonth()-mths);return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
            function formatMonthYearExtensive(mYS){if(!mYS||!mYS.includes('/')||!Array.isArray(MONTH_NAMES)||MONTH_NAMES.length<12)return mYS;const[m,y]=mYS.split('/');const i=parseInt(m,10)-1;if(i<0||i>11)return mYS;return`${MONTH_NAMES[i]} ${y}`;}
            function formatHoursExtensive(hD,s=false){if(isNaN(hD)||hD<0)hD=0;const tM=Math.round(hD*60);const hrs=Math.floor(tM/60);const mins=tM%60;const hK=s?(hrs===1?'units.hour_short':'units.hours_short'):(hrs===1?'units.hour':'units.hours');const mK=s?(mins===1?'units.minute_short':'units.minutes_short'):(mins===1?'units.minute':'units.minutes');let rs='',hP='',mP='';if(hrs>0){const hU=t(hK);hP=`${hrs}${s?hU:' '+hU}`; }if(mins>0){const mU=t(mK);mP=`${mins}${s?mU:' '+mU}`; }if(hP&&mP){const c=s?" ":` ${t('units.andConnector')} `;rs=`${hP}${c}${mP}`;}else{rs=hP||mP;}if(rs===''){const zK=s?'units.hours_short':'units.hours';rs=`0${s?t(zK):' '+t(zK,{count:0})}`; }return rs;}
            function formatDecimalToTimeInput(d){if(isNaN(d)||d<=0)return"";const t=Math.round(d*60),h=Math.floor(t/60),m=t%60;return`${h}:${String(m).padStart(2,'0')}`;}
            function parseTimeInputToDecimal(s){if(!s)return 0;const t=s.trim();if(!t)return 0;const cM=t.match(/^(\d{1,3}):(\d{1,2})$/);if(cM){const h=parseInt(cM[1],10),m=parseInt(cM[2],10);if(!isNaN(h)&&!isNaN(m)&&m>=0&&m<60&&h>=0)return h+(m/60);}const nM=t.match(/^(\d+)$/);if(nM){const str=nM[1],v=parseInt(str,10);if(isNaN(v))return NaN;if(str.length<=2){if(v<60)return v/60;}if(str.length>=3&&str.length<=4){const hS=str.slice(0,-2),mS=str.slice(-2);const h=parseInt(hS,10),m=parseInt(mS,10);if(!isNaN(h)&&!isNaN(m)&&m>=0&&m<60&&h>=0)return h+(m/60);}}return NaN;}
            function formatRelativeDate(dS){if(!dS)return'';const today=new Date();today.setHours(0,0,0,0);const iD=parseLocalDate(dS);if(isNaN(iD.valueOf())||!Array.isArray(WEEKDAY_NAMES)||WEEKDAY_NAMES.length<7){return formatDisplayDate(dS);}const tmrw=new Date(today);tmrw.setDate(today.getDate()+1);const week=new Date(today);week.setDate(today.getDate()+7);const iT=iD.getTime();const tT=today.getTime();const tmT=tmrw.getTime();if(iT===tT)return t('dates.today');if(iT===tmT)return t('dates.tomorrow');if(iD>tmrw&&iD<week){return`${t('dates.nextPrefix')} ${WEEKDAY_NAMES[iD.getDay()]}`;}return formatDisplayDate(dS);}

            function saveDataToLocalStorage(){try{localStorage.setItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.ENTRIES),JSON.stringify(recordedEntries));localStorage.setItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.PLANS),JSON.stringify(plannedEntries));localStorage.setItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.REVISITS),JSON.stringify(revisits));localStorage.setItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.SETTINGS),JSON.stringify(settings));localStorage.setItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.LAST_EXPORT_DATE),JSON.stringify(lastExportTimestamp));}catch(e){console.error("Error saving to LS with sync:",e);showFeedback('feedback.saveError','danger');}}
            function loadDataFromLocalStorage(){try{currentSyncPin=getSyncPin();const sSet=localStorage.getItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.SETTINGS));settings={...defaultSettings,...JSON.parse(sSet||'{}')};if(isNaN(settings.monthlyGoal)||settings.monthlyGoal<=0)settings.monthlyGoal=70;if(typeof settings.goalHasBeenSet!=='boolean')settings.goalHasBeenSet=false;if(!settings.language||!supportedLanguages.includes(settings.language))settings.language=null;let sEnt=localStorage.getItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.ENTRIES));if(sEnt){try{const p=JSON.parse(sEnt);recordedEntries=Array.isArray(p)?p.map(e=>({...e,notes:e.notes?.substring(0,NOTES_MAX_LENGTH)||'',tag:e.tag||DEFAULT_TAG_VALUE})):(()=>{throw new Error("Entries not array")})();}catch(e){recordedEntries=[];localStorage.removeItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.ENTRIES));}}const sPla=localStorage.getItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.PLANS));plannedEntries=sPla?JSON.parse(sPla):[];plannedEntries.forEach(p=>{if(p.plannedHours!==undefined&&typeof p.plannedHours==='number'){p.hours=p.plannedHours;delete p.plannedHours;}});const sRev=localStorage.getItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.REVISITS));revisits=sRev?JSON.parse(sRev):[];revisits=revisits.map(rv=>({...rv,status:rv.status||'pending',notes:rv.notes?.substring(0,REVISIT_NOTES_MAX_LENGTH)||'',dateAdded:rv.dateAdded||getCurrentDateString(),scheduledDate:rv.scheduledDate||null}));const sLED=localStorage.getItem(getLocalStorageKeyWithSync(BASE_LS_KEYS.LAST_EXPORT_DATE));lastExportTimestamp=sLED?JSON.parse(sLED):null;if(typeof lastExportTimestamp!=='number'&&lastExportTimestamp!==null){lastExportTimestamp=null;}sortAllDataLocally();}catch(e){console.error("Error loading from LS with sync:",e);recordedEntries=[];plannedEntries=[];revisits=[];settings={...defaultSettings};lastExportTimestamp=null;try{localStorage.clear();}catch(se){}showFeedback('feedback.loadError','danger');}}
            function sortAllDataLocally(){recordedEntries.sort((a,b)=>b.date.localeCompare(a.date));plannedEntries.sort((a,b)=>a.date.localeCompare(b.date));revisits.sort((a,b)=>{if(a.status!==b.status)return a.status==='pending'?-1:1;if(a.scheduledDate&&b.scheduledDate)return a.scheduledDate.localeCompare(b.scheduledDate);if(a.scheduledDate)return-1;if(b.scheduledDate)return 1;return(a.dateAdded||'').localeCompare(b.dateAdded||'');});}
            function clearLocalStorageForPin(pinToClear){if(!pinToClear)pinToClear='public';try{Object.values(BASE_LS_KEYS).forEach(baseKey=>{localStorage.removeItem(`${baseKey}_${pinToClear}`);});console.log(`LocalStorage cleared for pin: ${pinToClear}`);}catch(e){console.error("Error clearing LS for pin:",e);}}

            function updateSyncStatusDisplay(){if(!syncStatusDisplay)return;const k=currentSyncPin;if(k){syncStatusDisplay.textContent=t('sync.statusActive',{pinEnd:k.slice(-4)});syncStatusDisplay.title=t('sync.statusActiveTitle',{pinFull:k});}else{syncStatusDisplay.textContent=t('sync.statusPublic');syncStatusDisplay.title='';}}

            function getGunNodeName(baseNodeKey){const p=currentSyncPin||'public_v2';return`${GUN_NODE_PREFIX}${baseNodeKey}_${p}`;}
            function initializeGunSync(isHardReset=false){if(!window.Gun){console.error("GunJS not loaded!");showFeedback('sync.gunMissing','danger');return;}if(gun&&!isHardReset&&isSyncInitialized)return;console.log(`Initializing Gun with PIN: ${currentSyncPin||'public'}`);if(gun){Object.values(NODE_KEYS).forEach(k=>{const gn=gun.get(getGunNodeName(k));if(gn)gn.off();});entriesGun=null;plansGun=null;revisitsGun=null;settingsGun=null;lastExportTimestampGun=null;}gun=Gun({peers:GUN_PEERS,localStorage:false,radisk:false});entriesGun=gun.get(getGunNodeName(NODE_KEYS.ENTRIES));plansGun=gun.get(getGunNodeName(NODE_KEYS.PLANS));revisitsGun=gun.get(getGunNodeName(NODE_KEYS.REVISITS));settingsGun=gun.get(getGunNodeName(NODE_KEYS.SETTINGS));lastExportTimestampGun=gun.get(getGunNodeName(NODE_KEYS.LAST_EXPORT));
                entriesGun.map().on((d,id)=>{if(id&&d===null){recordedEntries=recordedEntries.filter(e=>e.id.toString()!==id.toString());console.log(`GUN: Deleted entry ${id}`);}else if(id&&d){const idx=recordedEntries.findIndex(e=>e.id.toString()===id.toString());if(idx>-1){if(JSON.stringify(recordedEntries[idx])!==JSON.stringify(d))recordedEntries[idx]={...recordedEntries[idx],...d};}else{recordedEntries.push(d);}console.log(`GUN: Received entry ${id}`);}sortAllDataLocally();saveDataToLocalStorage();updateAllDisplays();});
                plansGun.map().on((d,id)=>{if(id&&d===null){plannedEntries=plannedEntries.filter(p=>p.id.toString()!==id.toString());console.log(`GUN: Deleted plan ${id}`);}else if(id&&d){const idx=plannedEntries.findIndex(p=>p.id.toString()===id.toString());if(idx>-1){if(JSON.stringify(plannedEntries[idx])!==JSON.stringify(d))plannedEntries[idx]={...plannedEntries[idx],...d};}else{plannedEntries.push(d);}console.log(`GUN: Received plan ${id}`);}sortAllDataLocally();saveDataToLocalStorage();updateAllDisplays();});
                revisitsGun.map().on((d,id)=>{if(id&&d===null){revisits=revisits.filter(r=>r.id.toString()!==id.toString());console.log(`GUN: Deleted revisit ${id}`);}else if(id&&d){const idx=revisits.findIndex(r=>r.id.toString()===id.toString());if(idx>-1){if(JSON.stringify(revisits[idx])!==JSON.stringify(d))revisits[idx]={...revisits[idx],...d};}else{revisits.push(d);}console.log(`GUN: Received revisit ${id}`);}sortAllDataLocally();saveDataToLocalStorage();updateAllDisplays();});
                settingsGun.on(d=>{if(d){const oL=settings.language;const oG=settings.goalHasBeenSet;settings={...defaultSettings,...d};console.log("GUN: Received settings",settings);saveDataToLocalStorage();if(oL!==settings.language&&settings.language){currentLang=settings.language;loadTranslations().then(()=>updateAllDisplays());}else if(oG!==settings.goalHasBeenSet){updateAllDisplays();}else{updateAllDisplays();}}});
                lastExportTimestampGun.on(d=>{if(typeof d==='number'||d===null){lastExportTimestamp=d;console.log("GUN: Received lastExportTimestamp",lastExportTimestamp);saveDataToLocalStorage();updateLastExportDateDisplay();}});
                isSyncInitialized=true;updateSyncStatusDisplay();console.log("Gun listeners initialized.");
            }
            function resetAndInitializeAppSyncData(){console.log("Resetting and initializing app sync data...");currentSyncPin=getSyncPin();loadDataFromLocalStorage();if(!currentSyncPin&&Object.keys(translations).length>0&&!syncSettingsModal.classList.contains('active')){setTimeout(openSyncSettingsModal,200);}initializeGunSync(true);updateAllDisplays();}
            function initializeSyncFramework(isPinChange = false) {currentSyncPin = getSyncPin();if(isPinChange){loadDataFromLocalStorage();initializeGunSync(true);updateAllDisplays();} else {if(!currentSyncPin && translations && Object.keys(translations).length > 0 && !syncSettingsModal.classList.contains('active')) {setTimeout(openSyncSettingsModal, 500);} else if (currentSyncPin || !Object.keys(translations).length) {initializeGunSync();}}}

            function triggerInstallPromptIfAvailable(c='?'){if(deferredInstallPrompt&&settings.goalHasBeenSet){setTimeout(()=>{deferredInstallPrompt.prompt().catch(e=>{});deferredInstallPrompt=null;},300);}}
            function promptForMonthlyGoal(){let ok=false;const m=t('statsCard.goalLabel');while(!ok){const i=prompt(m,settings.monthlyGoal);if(i===null){ok=true;if(!settings.goalHasBeenSet){settings.goalHasBeenSet=true;saveDataToLocalStorage();settingsGun?.put(settings);updateAllDisplays();}}else{const g=parseInt(i,10);if(!isNaN(g)&&g>0){settings.monthlyGoal=g;settings.goalHasBeenSet=true;if(monthlyGoalInput)monthlyGoalInput.value=g;saveDataToLocalStorage();settingsGun?.put(settings);ok=true;updateAllDisplays();showFeedback("feedback.goalSetSuccess","success");triggerInstallPromptIfAvailable('initial goal');}else{alert(t("feedback.invalidGoalValue"));}}}}
            function setDateInputVisibility(v){isDateInputVisible=v;if(v){recordDateInput?.classList.remove('hidden');dateLabel?.classList.add('visually-hidden');recordDateInput?.focus();}else{recordDateInput?.classList.add('hidden');dateLabel?.classList.remove('visually-hidden');if(displayDate)displayDate.textContent=(!recordDateInput?.value||recordDateInput.value===getCurrentDateString())?t('dates.today'):formatDisplayDate(recordDateInput.value);}}
            function toggleCard(cE){if(!cE)return;const iE=cE.classList.contains('expanded');cE.classList.toggle('expanded',!iE);const i=cE.querySelector('.toggle-icon');if(i)i.textContent=!iE?'▲':'▼';}
            function clearRecordForm(){recordForm?.reset();if(recordIdInput)recordIdInput.value='';if(recordDateInput)recordDateInput.value=getCurrentDateString();setDateInputVisibility(false);if(recordTagSelect)recordTagSelect.value=DEFAULT_TAG_VALUE;if(recordNotesInput)recordNotesInput.value='';if(recordHoursInput)recordHoursInput.value='';if(saveRecordBtn)saveRecordBtn.textContent=t('recordCard.saveButton');saveRecordBtn?.classList.remove('editing');currentEditingId=null;}
            function handleRecordSubmit(ev){ev.preventDefault();const idVal=recordIdInput?.value;const id=idVal?parseInt(idVal,10):Date.now();const dA=(isDateInputVisible||(recordDateInput?.value&&recordDateInput.value!==getCurrentDateString()))?recordDateInput.value:getCurrentDateString();const h=parseTimeInputToDecimal(recordHoursInput?.value);const tg=recordTagSelect?.value||DEFAULT_TAG_VALUE;const n=recordNotesInput?.value.trim().substring(0,NOTES_MAX_LENGTH);if(isNaN(h)||h<=0){alert(t('feedback.invalidTimeFormat'));recordHoursInput?.focus();return;}if(!dA){alert(t('feedback.invalidDate'));return;}const en={id,date:dA,hours:h,tag:tg,notes:n,type:'record',updatedAt:Date.now()};const idx=recordedEntries.findIndex(e=>e.id===id);if(idx>-1)recordedEntries[idx]=en;else recordedEntries.push(en);recordedEntries.sort((a,b)=>b.date.localeCompare(a.date));saveDataToLocalStorage();entriesGun?.get(id.toString()).put(en);clearRecordForm();updateAllDisplays();showFeedback('feedback.recordSavedSuccess','success');}
            function editRecordEntry(id){const en=recordedEntries.find(e=>e.id===id&&e.type!=='revisit_completed');if(en){if(!recordCard?.classList.contains('expanded'))toggleCard(recordCard);currentEditingId=id;if(recordIdInput)recordIdInput.value=en.id;if(recordDateInput)recordDateInput.value=en.date;setDateInputVisibility(en.date!==getCurrentDateString());if(recordHoursInput)recordHoursInput.value=formatDecimalToTimeInput(en.hours);if(recordTagSelect)recordTagSelect.value=en.tag||DEFAULT_TAG_VALUE;if(recordNotesInput)recordNotesInput.value=en.notes||'';if(saveRecordBtn){saveRecordBtn.textContent=t('recordCard.updateButton');saveRecordBtn.classList.add('editing');}recordCard?.scrollIntoView({behavior:'smooth',block:'start'});recordHoursInput?.focus();}}
            function deleteRecordEntry(id){showConfirmationDialog(t('dialog.confirmDeleteRecordMessage'),()=>{const i=recordedEntries.findIndex(e=>e.id===id);if(i>-1){const dId=recordedEntries[i].id;recordedEntries.splice(i,1);saveDataToLocalStorage();entriesGun?.get(dId.toString()).put(null);updateAllDisplays();showFeedback('feedback.recordDeletedSuccess','info');if(currentEditingId===id)clearRecordForm();}});}
            function clearPlanForm(){planForm?.reset();if(planIdInput)planIdInput.value='';if(planDateInput)planDateInput.value='';if(planHoursInput)planHoursInput.value='';if(savePlanBtn)savePlanBtn.textContent=t('planCard.saveButton');currentEditingId=null;}
            function handlePlanSubmit(ev){ev.preventDefault();const idVal=planIdInput?.value;const id=idVal?parseInt(idVal,10):Date.now();const dA=planDateInput?.value;const h=parseTimeInputToDecimal(planHoursInput?.value);const tS=getCurrentDateString();if(!dA||isNaN(h)||h<=0){alert(t('feedback.planFormInvalid'));planHoursInput?.focus();return;}if(dA<tS){alert(t('feedback.planDatePastError'));planDateInput?.focus();return;}const pl={id,date:dA,hours:h,updatedAt:Date.now()};const idx=plannedEntries.findIndex(p=>p.id===id);if(idx>-1)plannedEntries[idx]=pl;else plannedEntries.push(pl);plannedEntries.sort((a,b)=>a.date.localeCompare(b.date));saveDataToLocalStorage();plansGun?.get(id.toString()).put(pl);clearPlanForm();updateAllDisplays();showFeedback('feedback.planSavedSuccess','success');}
            function markPlanAsDone(id){const idx=plannedEntries.findIndex(p=>p.id===id);if(idx===-1){showFeedback('feedback.planNotFound','danger');return;}const pl=plannedEntries[idx];const tS=getCurrentDateString();const rD=tS<pl.date?tS:pl.date;const n=t('recordCard.autoNoteFromPlan',{date:formatDisplayDate(pl.date),hours:formatHoursExtensive(pl.hours)});const enId=Date.now();const en={id:enId,date:rD,hours:pl.hours,tag:DEFAULT_TAG_VALUE,notes:n,type:'record',updatedAt:Date.now()};recordedEntries.push(en);recordedEntries.sort((a,b)=>b.date.localeCompare(a.date));plannedEntries.splice(idx,1);saveDataToLocalStorage();entriesGun?.get(enId.toString()).put(en);plansGun?.get(pl.id.toString()).put(null);updateAllDisplays();showFeedback('feedback.planMarkedDoneSuccess','success');}
            function deletePlanEntry(id){showConfirmationDialog(t('dialog.confirmDeletePlanMessage'),()=>{plannedEntries=plannedEntries.filter(p=>p.id!==id);saveDataToLocalStorage();plansGun?.get(id.toString()).put(null);updateAllDisplays();showFeedback('feedback.planDeletedSuccess','info');if(currentEditingId===id)clearPlanForm();});}
            function handleGoalSave(){const g=parseInt(monthlyGoalInput?.value,10);if(!isNaN(g)&&g>0){settings.monthlyGoal=g;settings.goalHasBeenSet=true;settings.updatedAt=Date.now();saveDataToLocalStorage();settingsGun?.put(settings);updateAllDisplays();showFeedback('feedback.goalUpdateSuccess','success');triggerInstallPromptIfAvailable('goal save');}else{alert(t('feedback.invalidGoalValue'));if(monthlyGoalInput)monthlyGoalInput.value=settings.monthlyGoal;}}

            function showConfirmationDialog(m,oC){if(dialogMessage)dialogMessage.textContent=m;currentConfirmCallback=oC;confirmationDialog?.classList.add('visible');dialogConfirmBtn?.focus();}
            function hideConfirmationDialog(){confirmationDialog?.classList.remove('visible');setTimeout(()=>{currentConfirmCallback=null;},300);}
            function showFeedback(k,tp='info',vrs={}){let ms=t(k,vrs);const fb=document.createElement('div');fb.textContent=ms;fb.style.cssText=`position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:10px 20px;border-radius:8px;z-index:1100;box-shadow:0 4px 15px rgba(0,0,0,0.2);font-size:0.95em;transition:opacity 0.5s ease,bottom 0.5s ease;opacity:0;background-color:${tp==='success'?'var(--success-color)':tp==='danger'?'var(--danger-color)':'var(--primary-color)'};color:var(--text-color);text-align:center;max-width:90%;`;document.body.appendChild(fb);setTimeout(()=>{fb.style.opacity='1';fb.style.bottom='30px';},10);setTimeout(()=>{fb.style.opacity='0';fb.style.bottom='10px';},3500);setTimeout(()=>{fb.parentNode?.removeChild(fb)},4000);}
            function clearRevisitForm(){revisitForm?.reset();if(revisitIdInput)revisitIdInput.value='';if(revisitNameInput)revisitNameInput.value='';if(revisitDateInput)revisitDateInput.value='';if(revisitNotesInput)revisitNotesInput.value='';if(saveRevisitBtn)saveRevisitBtn.textContent=t('revisitCard.addButton');currentEditingId=null;}
            function handleRevisitSubmit(ev){ev.preventDefault();const idVal=revisitIdInput?.value;const id=idVal?parseInt(idVal,10):Date.now();const nm=revisitNameInput?.value.trim();const sD=revisitDateInput?.value||null;const n=revisitNotesInput?.value.trim().substring(0,REVISIT_NOTES_MAX_LENGTH);const dA=getCurrentDateString();if(!nm){alert(t('feedback.revisitNameRequired'));revisitNameInput?.focus();return;}const rv={id,name:nm,notes:n,dateAdded:dA,scheduledDate:sD,status:'pending',dateCompleted:null,updatedAt:Date.now()};const idx=revisits.findIndex(r=>r.id===id);if(idx>-1){revisits[idx]=rv;}else{revisits.push(rv);}revisits.sort((a,b)=>{if(a.status!==b.status)return a.status==='pending'?-1:1;if(a.scheduledDate&&b.scheduledDate)return a.scheduledDate.localeCompare(b.scheduledDate);if(a.scheduledDate)return-1;if(b.scheduledDate)return 1;return(a.dateAdded||'').localeCompare(b.dateAdded||'');});saveDataToLocalStorage();revisitsGun?.get(id.toString()).put(rv);clearRevisitForm();updateAllDisplays();showFeedback('feedback.revisitSavedSuccess','success');}
            function markRevisitComplete(id){const idx=revisits.findIndex(r=>r.id===id);if(idx===-1){showFeedback('feedback.revisitNotFound','danger');return;}const rv=revisits[idx];const cD=getCurrentDateString();rv.status='completed';rv.dateCompleted=cD;const hEId=Date.now();const hE={id:hEId,date:cD,hours:0,tag:t('historyCard.revisitCompletedTag'),notes:`${t('historyCard.revisitCompletedNotePrefix')} ${rv.name}${rv.notes?`\n${t('historyCard.revisitOriginalNotes')}: ${rv.notes}`:''}`,type:'revisit_completed',revisitId:rv.id,updatedAt:Date.now()};recordedEntries.push(hE);recordedEntries.sort((a,b)=>b.date.localeCompare(a.date));revisits.splice(idx,1);saveDataToLocalStorage();entriesGun?.get(hEId.toString()).put(hE);revisitsGun?.get(rv.id.toString()).put(null);updateAllDisplays();showFeedback('feedback.revisitMarkedCompleteSuccess','success');}
            function deleteRevisit(id){showConfirmationDialog(t('dialog.confirmDeleteRevisitMessage'),()=>{const iL=revisits.length;revisits=revisits.filter(r=>r.id!==id);if(revisits.length<iL){saveDataToLocalStorage();revisitsGun?.get(id.toString()).put(null);updateAllDisplays();showFeedback('feedback.revisitDeletedSuccess','info');if(currentEditingId===id)clearRevisitForm();}});}
            function createConfetti(){if(!confettiContainer)return;confettiContainer.innerHTML='';for(let i=0;i<CONFETTI_COUNT;i++){const c=document.createElement('div');c.classList.add('confetti');c.style.left=`${Math.random()*100}%`;c.style.backgroundColor=`var(--confetti-color-${Math.floor(Math.random()*6)+1})`;c.style.animationDelay=`${Math.random()*2}s`;const sz=Math.random()*6+6;c.style.width=`${sz}px`;c.style.height=`${sz*(Math.random()*0.5+0.75)}px`;if(Math.random()>0.7){c.style.borderRadius='50%';}confettiContainer.appendChild(c);}if(confettiTimeout)clearTimeout(confettiTimeout);confettiTimeout=setTimeout(()=>{if(confettiContainer)confettiContainer.innerHTML='';},6000);}
            function removeConfetti(){if(confettiTimeout)clearTimeout(confettiTimeout);if(confettiContainer)confettiContainer.innerHTML='';}

            function handleExportData(){try{const dTExp={version:'1.2_sync',exportedAt:new Date().toISOString(),entries:recordedEntries,plans:plannedEntries,revisits:revisits,settings:settings,lastExportTimestamp:lastExportTimestamp};const jD=JSON.stringify(dTExp,null,2);const b=new Blob([jD],{type:'application/json'});const u=URL.createObjectURL(b);const a=document.createElement('a');const dS=new Date().toISOString().split('T')[0];a.href=u;a.download=`pioneer-field-service-log_backup_${dS}.json`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u);lastExportTimestamp=Date.now();lastExportTimestampGun?.put(lastExportTimestamp);saveDataToLocalStorage();updateLastExportDateDisplay();showFeedback('feedback.exportSuccess','success');}catch(e){console.error("Export failed:",e);showFeedback('feedback.exportError','danger');}}
            function handleImportData(){importFileInput?.click();}
            function processImportFile(ev){const f=ev.target.files?.[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const tx=e.target?.result;if(typeof tx!=='string')throw new Error("File content is not text");const iD=JSON.parse(tx);if(typeof iD!=='object'||iD===null||!Array.isArray(iD.entries)||!Array.isArray(iD.plans)||!Array.isArray(iD.revisits)||typeof iD.settings!=='object'||iD.settings===null){throw new Error("Invalid file structure");}showConfirmationDialog(t('dialog.confirmImportMessage'),()=>{try{recordedEntries=iD.entries.map(en=>({...en,notes:en.notes?.substring(0,NOTES_MAX_LENGTH)||'',tag:en.tag||DEFAULT_TAG_VALUE,updatedAt:en.updatedAt||Date.now()}));recordedEntries.forEach(en=>entriesGun?.get(en.id.toString()).put(en));plannedEntries=iD.plans.map(pl=>{if(pl.plannedHours!==undefined&&typeof pl.plannedHours==='number'){pl.hours=pl.plannedHours;delete pl.plannedHours;}return {...pl,updatedAt:pl.updatedAt||Date.now()};});plannedEntries.forEach(pl=>plansGun?.get(pl.id.toString()).put(pl));revisits=iD.revisits.map(rv=>({...rv,status:rv.status||'pending',notes:rv.notes?.substring(0,REVISIT_NOTES_MAX_LENGTH)||'',dateAdded:rv.dateAdded||getCurrentDateString(),scheduledDate:rv.scheduledDate||null,updatedAt:rv.updatedAt||Date.now()}));revisits.forEach(rv=>revisitsGun?.get(rv.id.toString()).put(rv));const iSet=iD.settings;settings.monthlyGoal=(!isNaN(iSet.monthlyGoal)&&iSet.monthlyGoal>0)?iSet.monthlyGoal:70;settings.goalHasBeenSet=typeof iSet.goalHasBeenSet==='boolean'?iSet.goalHasBeenSet:false;const iLang=iSet.language;settings.language=(iLang&&supportedLanguages.includes(iLang))?iLang:currentLang;settings.updatedAt=Date.now();settingsGun?.put(settings);if(iD.lastExportTimestamp&&(typeof iD.lastExportTimestamp==='number'||iD.lastExportTimestamp===null)){lastExportTimestamp=iD.lastExportTimestamp;lastExportTimestampGun?.put(lastExportTimestamp);}if(monthlyGoalInput)monthlyGoalInput.value=settings.monthlyGoal;sortAllDataLocally();if(settings.language!==currentLang){currentLang=settings.language;loadTranslations().then(()=>{saveDataToLocalStorage();updateAllDisplays();showFeedback('feedback.importSuccess','success');});}else{saveDataToLocalStorage();updateAllDisplays();showFeedback('feedback.importSuccess','success');}}catch(iE){console.error("Error applying imported data:",iE);showFeedback('feedback.importProcessError','danger');}}); }catch(e){console.error("Import failed:",e);showFeedback('feedback.importErrorInvalidFile','danger');}finally{ev.target.value=null;}};r.onerror=()=>{showFeedback('feedback.importErrorReadFile','danger');ev.target.value=null;};r.readAsText(f);}

            function populateLanguageSelector(){if(!languageSelector||!translations)return;const aL=Object.keys(translations).filter(l=>supportedLanguages.includes(l));languageSelector.innerHTML='';aL.forEach(lC=>{const o=document.createElement('option');o.value=lC;const lN=getNestedValue(translations[lC],'languageName')||lC;o.textContent=lN;if(lC===currentLang){o.selected=true;}languageSelector.appendChild(o);});}
            async function handleLanguageChange(ev){const nL=ev.target.value;if(nL&&nL!==currentLang&&supportedLanguages.includes(nL)){currentLang=nL;settings.language=nL;settings.updatedAt=Date.now();saveDataToLocalStorage();settingsGun?.put(settings);if(loadingIndicator)loadingIndicator.classList.remove('hidden');await loadTranslations();updateAllDisplays();if(loadingIndicator)loadingIndicator.classList.add('hidden');showFeedback('feedback.languageChanged','success',{lang:getNestedValue(translations[currentLang],'languageName')||currentLang});}}

            function updateDashboard(){const tdy=new Date();const cM=tdy.getMonth();const cY=tdy.getFullYear();let mH=0,wH=0;const sOWS=getStartOfWeek(tdy);const tS=getCurrentDateString();recordedEntries.forEach(en=>{if(en.type!=='revisit_completed'){const eD=parseLocalDate(en.date);if(isNaN(eD.valueOf()))return;if(eD.getMonth()===cM&&eD.getFullYear()===cY){mH+=en.hours;}if(en.date>=sOWS){wH+=en.hours;}}});if(dashboardWeekHours)dashboardWeekHours.textContent=formatHoursExtensive(wH,true);const g=settings.monthlyGoal||70;const p=g>0?Math.min(100,(mH/g)*100):0;if(dashboardMonthPercentage)dashboardMonthPercentage.textContent=`${Math.round(p)}%`;if(dashboardBox){dashboardBox.style.setProperty('--progress-percent',p);if(p>=100){if(!dashboardBox.classList.contains('goal-met')){dashboardBox.classList.add('goal-met');createConfetti();}}else{if(dashboardBox.classList.contains('goal-met')){dashboardBox.classList.remove('goal-met');removeConfetti();}}}if(dashboardMonthTotal)dashboardMonthTotal.innerHTML=`${t('dashboard.monthTotalLabel')} <strong>${formatHoursExtensive(mH)}</strong>`;const lDOMO=new Date(cY,cM+1,0);const lDOM=lDOMO.getDate();const tDD=tdy.getDate();const rD=Math.max(0,lDOM-tDD);const rHN=Math.max(0,g-mH);let fT='';if(!settings.goalHasBeenSet){fT=`<span>${t('dashboard.setGoalPrompt')}</span>`;}else if(rHN<=0){fT=`<span>${t('dashboard.goalMet')}</span>`;}else if(rD<=0&&tDD===lDOM){fT=`<span>${t('dashboard.goalNotMetMonthEnd')}</span>`;}else if(rD<=0){fT=`<span>${t('dashboard.forecastPrefix')} ${formatHoursExtensive(rHN)}.</span>`;}else{let aNPD=rHN/rD;let dTW=rD;if(aNPD>0&&aNPD<MIN_HOURS_PER_DAY_FORECAST){dTW=Math.ceil(rHN/MIN_HOURS_PER_DAY_FORECAST);aNPD=MIN_HOURS_PER_DAY_FORECAST;}const dS=t(dTW===1?'dashboard.forecastSuffixDaysSingular':'dashboard.forecastSuffixDaysPlural');const sug=`${t('dashboard.attemptPrefix')}<strong>${formatHoursExtensive(aNPD,true)}</strong> ${t('dashboard.perDay')} ${dTW} ${dS}.`;fT=`<span>${t('dashboard.forecastPrefix')} ${formatHoursExtensive(rHN)}.</span><span>${sug}</span>`;}const fS=document.querySelector('#dashboard-summary #dashboard-forecast');if(fS)fS.innerHTML=fT;const pR=revisits.filter(rv=>rv.status==='pending');pR.sort((a,b)=>{const aHF=a.scheduledDate&&a.scheduledDate>=tS;const bHF=b.scheduledDate&&b.scheduledDate>=tS;if(aHF&&bHF)return a.scheduledDate.localeCompare(b.scheduledDate);if(aHF)return-1;if(bHF)return 1;if(a.scheduledDate&&!b.scheduledDate)return-1;if(!a.scheduledDate&&b.scheduledDate)return 1;return(a.dateAdded||'').localeCompare(b.dateAdded||'');});const dR=pR.slice(0,DASHBOARD_REVISIT_LIMIT);if(dashboardRevisitList)dashboardRevisitList.innerHTML='';if(dR.length>0){dashboardRevisitsSection?.classList.remove('hidden');dR.forEach(rv=>{const li=document.createElement('li');li.dataset.id=rv.id;let rT='';if(rv.scheduledDate){rT=`<span class="revisit-date">${formatRelativeDate(rv.scheduledDate)}:</span> <span class="revisit-name">${rv.name}</span>`;}else{rT=`<span class="revisit-name">${rv.name}</span>`;}li.innerHTML=rT;dashboardRevisitList?.appendChild(li);});}else{dashboardRevisitsSection?.classList.add('hidden');}}
            function updateDashboardPlannedDates(){const tS=getCurrentDateString();const uP=plannedEntries.filter(p=>p.date>=tS).sort((a,b)=>a.date.localeCompare(b.date));const dP=uP.slice(0,3);if(dashboardPlanList)dashboardPlanList.innerHTML='';if(dP.length>0){dashboardPlannedDatesContainer?.classList.remove('hidden');dP.forEach(p=>{const li=document.createElement('li');li.dataset.id=p.id;let pT=`<strong>${formatRelativeDate(p.date)}:</strong> ${formatHoursExtensive(p.hours,true)}`;li.innerHTML=pT;dashboardPlanList?.appendChild(li);});}else{dashboardPlannedDatesContainer?.classList.add('hidden');}}
            function renderHistory(){if(!historyList)return;historyList.innerHTML='';const sT=historySearchInput?.value.trim().toLowerCase()||'';let rs=[];let lT='';const hS=sT.length>0;const aHI=recordedEntries.sort((a,b)=>b.date.localeCompare(a.date));if(hS){rs=aHI.filter(e=>{const iR=e.type==='revisit_completed';const tI=iR?t('historyCard.revisitCompletedTag'):(e.tag||DEFAULT_TAG_VALUE);const tTr=iR?tI.toLowerCase():t(tagKeyMapping[tI]||'tags.noTag').toLowerCase();const fD=formatDisplayDate(e.date).toLowerCase();const hS=iR?'':(e.hours||0).toString().replace('.',',');const hRS=iR?'':Math.round(e.hours||0).toString();const hF=iR?'':formatHoursExtensive(e.hours).toLowerCase();const n=(e.notes||'').toLowerCase();return(fD.includes(sT)||(!iR&&(hS.includes(sT)||hRS.includes(sT)||hF.includes(sT)))||tTr.includes(sT)||n.includes(sT)||(iR&&n.includes(sT))||tI.toLowerCase().includes(sT));});const cK=rs.length===1?'historyCard.resultsCountForTermSingular':'historyCard.resultsCountForTermPlural';lT=t(cK,{count:rs.length,term:sT});}else{const dLS=getDateMonthsAgo(HISTORY_MONTH_LIMIT);rs=aHI.filter(e=>e.date>=dLS);if(aHI.length===0){lT=t('historyCard.listPlaceholderNoRecords');}else if(rs.length===0){lT=t('historyCard.noRecordsLastMonths',{limit:HISTORY_MONTH_LIMIT});}else{lT=t('historyCard.showingLastMonths',{limit:HISTORY_MONTH_LIMIT});}}if(showingResultsLabel)showingResultsLabel.textContent=lT;if(rs.length===0){let pK='historyCard.listPlaceholderNoRecords';if(aHI.length>0){pK=hS?'historyCard.listPlaceholderNoSearchResults':'historyCard.listPlaceholderNoRecent';}if(historyListPlaceholder){historyListPlaceholder.textContent=t(pK);historyListPlaceholder.classList.remove('hidden');}}else{historyListPlaceholder?.classList.add('hidden');rs.forEach(e=>{const li=document.createElement('li');li.dataset.id=e.id;const iR=e.type==='revisit_completed';let dH='';let aH='';if(iR){const rM=`<span class="revisit-completed-marker">${t('historyCard.revisitCompletedMarker')}</span>`;const nL=(e.notes||'').split('\n');let nD=nL[0]||'';if(nL.length>1)nD+=` (${t('historyCard.originalNotesPreviewSuffix')}...)`;const nP=e.notes?`<span class="notes-preview">${nD}</span>`:`<span class="notes-preview" style="opacity:0.5;">${t('historyCard.noNotes')}</span>`;dH=`<div class="entry-details">${rM}<strong>${formatDisplayDate(e.date)}:</strong> ${nP}</div>`;aH='<div class="entry-actions"></div>';}else{const tI=e.tag||DEFAULT_TAG_VALUE;const tTx=t(tagKeyMapping[tI]||'tags.noTag');const tB=`<span class="tag-badge" ${tI===DEFAULT_TAG_VALUE?'style="opacity:0.6;"':''}>${tTx}</span>`;const nP=e.notes?`<span class="notes-preview">${e.notes.replace(/\n/g,' ')}</span>`:`<span class="notes-preview" style="opacity:0.5;">${t('historyCard.noNotes')}</span>`;const hF=formatHoursExtensive(e.hours);dH=`<div class="entry-details"><strong>${formatDisplayDate(e.date)}:</strong> <span class="hours">${hF}</span> ${tB} ${nP}</div>`;aH=`<div class="entry-actions"><button class="edit-btn secondary">${t('common.editButton')}</button> <button class="delete-btn danger">${t('common.deleteButton')}</button></div>`;}li.innerHTML=dH+aH;if(!iR){li.querySelector('.edit-btn')?.addEventListener('click',ev=>{ev.stopPropagation();editRecordEntry(e.id);});li.querySelector('.delete-btn')?.addEventListener('click',ev=>{ev.stopPropagation();deleteRecordEntry(e.id);});}historyList.appendChild(li);});}}
            function renderPlanning(){if(!planningList)return;planningList.innerHTML='';const tS=getCurrentDateString();const aP=[...plannedEntries].sort((a,b)=>a.date.localeCompare(b.date));if(aP.length===0){if(planningListPlaceholder){planningListPlaceholder.textContent=t('planCard.listPlaceholderNoPastOrFuture');planningListPlaceholder.classList.remove('hidden');}return;}planningListPlaceholder?.classList.add('hidden');aP.forEach(p=>{const li=document.createElement('li');li.dataset.id=p.id;const hD=formatHoursExtensive(p.hours);const iP=p.date<tS;const pDS=iP?`<span style="opacity:0.7;margin-left:5px;">(${t('planCard.pastDateSuffix')})</span>`:'';li.innerHTML=`<div class="entry-details"><strong>${formatDisplayDate(p.date)} (${formatRelativeDate(p.date)}):</strong> <span class="hours">${hD}</span> ${pDS}</div><div class="plan-actions"><button class="done-plan-btn success">${t('planCard.markDoneButton')}</button> <button class="delete-plan-btn danger">${t('common.deleteButton')}</button></div>`;li.querySelector('.done-plan-btn')?.addEventListener('click',e=>{e.stopPropagation();markPlanAsDone(p.id);});li.querySelector('.delete-plan-btn')?.addEventListener('click',e=>{e.stopPropagation();deletePlanEntry(p.id);});planningList.appendChild(li);});}
            function renderRevisits(){if(!revisitList)return;revisitList.innerHTML='';const pR=revisits.filter(rv=>rv.status==='pending').sort((a,b)=>{if(a.scheduledDate&&b.scheduledDate)return a.scheduledDate.localeCompare(b.scheduledDate);if(a.scheduledDate)return-1;if(b.scheduledDate)return 1;return(a.dateAdded||'').localeCompare(b.dateAdded||'');});if(pR.length===0){if(revisitListPlaceholder){revisitListPlaceholder.textContent=t('revisitCard.listPlaceholderNoPending');revisitListPlaceholder.classList.remove('hidden');}return;}revisitListPlaceholder?.classList.add('hidden');pR.forEach(rv=>{const li=document.createElement('li');li.dataset.id=rv.id;const nP=rv.notes?`<span class="notes-preview">${rv.notes.replace(/\n/g,' ')}</span>`:`<span class="notes-preview" style="opacity:0.5;">${t('revisitCard.noNotes')}</span>`;const sDH=rv.scheduledDate?`<span class="revisit-scheduled-date">(${t('revisitCard.scheduledForLabel')} <strong>${formatRelativeDate(rv.scheduledDate)}</strong>)</span>`:'';li.innerHTML=`<div class="entry-details"><strong>${rv.name}</strong>${sDH}${nP}</div><div class="revisit-actions"><button class="complete-revisit-btn success">${t('revisitCard.markCompleteButton')}</button><button class="delete-revisit-btn danger">${t('common.deleteButton')}</button></div>`;li.querySelector('.complete-revisit-btn')?.addEventListener('click',e=>{e.stopPropagation();markRevisitComplete(rv.id);});li.querySelector('.delete-revisit-btn')?.addEventListener('click',e=>{e.stopPropagation();deleteRevisit(rv.id);});revisitList.appendChild(li);});}
            function updateStatistics(){const tdy=new Date();const cM=tdy.getMonth();const cY=tdy.getFullYear();let tHM=0;const aD=new Set();recordedEntries.filter(e=>e.type!=='revisit_completed').filter(e=>{const d=parseLocalDate(e.date);if(isNaN(d.valueOf()))return false;return d.getMonth()===cM&&d.getFullYear()===cY;}).forEach(e=>{tHM+=e.hours;aD.add(e.date);});const g=settings.monthlyGoal||70;const pP=settings.goalHasBeenSet?(g>0?Math.min(Math.round((tHM/g)*100),100):0):0;const dAC=aD.size;const aHPAD=dAC>0?(tHM/dAC):0;if(statsMonthHours)statsMonthHours.textContent=formatHoursExtensive(tHM);if(statsMonthGoalProgress)statsMonthGoalProgress.textContent=settings.goalHasBeenSet?`${pP}%`:'--%';if(statsMonthProgressBar)statsMonthProgressBar.style.width=`${pP}%`;if(statsAvgHoursDay)statsAvgHoursDay.textContent=formatHoursExtensive(aHPAD);if(statsMonthDaysActive)statsMonthDaysActive.textContent=dAC;}
            function populateMonthSelector(){if(!chartMonthSelector)return;const aM=new Set();recordedEntries.filter(e=>e.type!=='revisit_completed').forEach(e=>{const dO=parseLocalDate(e.date);if(!isNaN(dO.valueOf())){aM.add(getMonthYearString(dO));}});const sM=Array.from(aM).sort((a,b)=>{const[mA,yA]=a.split('/').map(Number);const[mB,yB]=b.split('/').map(Number);return(yB-yA)||(mB-mA);});const oSV=chartMonthSelector.value;chartMonthSelector.innerHTML='';if(sM.length===0){const o=document.createElement('option');o.value='';o.textContent=t('chartsCard.noDataOption');chartMonthSelector.append(o);chartMonthSelector.disabled=true;return;}chartMonthSelector.disabled=false;const cMS=getMonthYearString(new Date());let cMF=formatMonthYearExtensive(cMS);let hCMD=false;let dSOV=false;sM.forEach(mYV=>{const o=document.createElement('option');let mF=formatMonthYearExtensive(mYV);o.value=mYV;o.textContent=mF||mYV;if(mYV===oSV){o.selected=true;dSOV=true;}else if(mYV===cMS&&!dSOV){o.selected=true;}if(mYV===cMS){hCMD=true;}chartMonthSelector.append(o);});if(!hCMD&&cMF&&Array.isArray(MONTH_NAMES)&&MONTH_NAMES.length>0){const o=document.createElement('option');o.value=cMS;o.textContent=`${cMF} (${t('chartsCard.currentMonthSuffix')})`;chartMonthSelector.insertBefore(o,chartMonthSelector.firstChild);if(!dSOV&&!chartMonthSelector.querySelector('option[selected]')){o.selected=true;}}if(!chartMonthSelector.value&&chartMonthSelector.options.length>0){chartMonthSelector.options[0].selected=true;}}
            function renderCharts(sMY){if(monthlyHoursChartInstance){monthlyHoursChartInstance.destroy();monthlyHoursChartInstance=null;}if(!sMY||sMY===''){clearChartWithMessage(t('chartsCard.selectMonthMessage'));return;}try{const[sM,sY]=sMY.split('/').map(Number);const mI=sM-1;const eFM=recordedEntries.filter(e=>e.type!=='revisit_completed').filter(e=>{const d=parseLocalDate(e.date);if(isNaN(d.valueOf()))return false;return d.getMonth()===mI&&d.getFullYear()===sY;});if(eFM.length===0){clearChartWithMessage(t('chartsCard.noRecordsInMonthMessage',{month:formatMonthYearExtensive(sMY)}));return;}let tH=0;const hBT={};eFM.forEach(e=>{const tN=e.tag||DEFAULT_TAG_VALUE;const h=e.hours||0;tH+=h;hBT[tN]=(hBT[tN]||0)+h;});if(chartTotalHoursDisplay)chartTotalHoursDisplay.innerHTML=`${t('chartsCard.totalHoursLabel')} <strong>${formatHoursExtensive(tH)}</strong>`;const aD=Object.entries(hBT).map(([tg,hs])=>({label:t(tagKeyMapping[tg]||'tags.noTag'),value:hs}));aD.sort((a,b)=>b.value-a.value);const lbls=aD.map(i=>i.label);const vals=aD.map(i=>i.value);const bCs=lbls.map((_,i)=>chartColors[i%chartColors.length]);if(!monthlyHoursChartCtx)return;monthlyHoursChartInstance=new Chart(monthlyHoursChartCtx,{type:'pie',data:{labels:lbls,datasets:[{data:vals,backgroundColor:bCs,borderColor:tooltipBgColor||'#1c1c1e',borderWidth:1.5}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:t('chartsCard.percentageDistributionTitle'),color:textMutedColor,font:{size:12,weight:'normal'},padding:{bottom:15}},tooltip:{backgroundColor:tooltipBgColor,titleColor:textColor,bodyColor:textColor,displayColors:true,padding:10,cornerRadius:6,callbacks:{label:c=>{const l=c.label||'';const v=c.parsed||0;const p=tH>0?((v/tH)*100).toFixed(1):0;return`${l}: ${formatHoursExtensive(v)} (${p}%)`;}}},legend:{position:'bottom',align:'center',labels:{color:textMutedColor,boxWidth:12,padding:15}}}}});}catch(e){clearChartWithMessage(t('chartsCard.renderErrorMessage'));}}
            function clearChartWithMessage(m){if(monthlyHoursChartInstance){monthlyHoursChartInstance.destroy();monthlyHoursChartInstance=null;}if(chartTotalHoursDisplay)chartTotalHoursDisplay.textContent='';const c=monthlyHoursChartCtx;if(c){c.clearRect(0,0,c.canvas.width,c.canvas.height);c.save();c.textAlign='center';c.textBaseline='middle';c.fillStyle=textMutedColor;c.font=`14px ${computedStyles?.fontFamily||'sans-serif'}`;c.fillText(m,c.canvas.width/2,c.canvas.height/2);c.restore();}}
            function updateLastExportDateDisplay(){if(lastExportDateDisplay){const fD=formatTimestamp(lastExportTimestamp);lastExportDateDisplay.textContent=t('settingsCard.lastExportLabel')+' '+fD;}}
            function updateAllDisplays(){if(typeof t!=='function'||!translations?.[currentLang]){console.warn("Translations not ready, skipping update.");return;}try{applyStaticTranslations();updateDashboard();updateDashboardPlannedDates();updateStatistics();renderHistory();renderPlanning();renderRevisits();populateMonthSelector();const sV=chartMonthSelector?.value;if(!chartMonthSelector?.disabled&&sV){renderCharts(sV);}else if(!chartMonthSelector?.disabled&&chartMonthSelector?.options?.length>0&&chartMonthSelector.options[0]?.value){chartMonthSelector.options[0].selected=true;renderCharts(chartMonthSelector.options[0].value);}else{clearChartWithMessage(t(recordedEntries.length===0?'chartsCard.noDataYetMessage':'chartsCard.selectMonthMessage'));}if(plansSection){const iRV=!dashboardRevisitsSection?.classList.contains('hidden');const iPV=!dashboardPlannedDatesContainer?.classList.contains('hidden');plansSection.classList.toggle('hidden',!(iRV||iPV));}updateSyncStatusDisplay();}catch(er){console.error("Error during updateAllDisplays:",er);}}
            function formatTimeInputOnType(ev){const i=ev.target;let v=i.value;let oP=i.selectionStart;let nV=v.replace(/[^\d]/g,'').substring(0,4);let fV=nV;let cA=false;if(nV.length===3){fV=`${nV.substring(0,1)}:${nV.substring(1)}`;if(v.indexOf(':')===-1&&oP>=1){cA=true;}}else if(nV.length>=4){fV=`${nV.substring(0,nV.length-2)}:${nV.substring(nV.length-2)}`;if(v.indexOf(':')===-1&&oP>=fV.indexOf(':')){cA=true;}}if(i.value!==fV){i.value=fV;let nP=oP;if(cA){nP++;}nP=Math.min(nP,fV.length);requestAnimationFrame(()=>{try{i.setSelectionRange(nP,nP);}catch(e){}});}}
            function registerServiceWorker(){if('serviceWorker'in navigator){window.addEventListener('load',()=>{navigator.serviceWorker.register('./service-worker.js').then(r=>console.log('SW registered:',r.scope)).catch(e=>console.error('SW reg failed:',e));});navigator.serviceWorker.addEventListener('controllerchange',()=>{console.log('SW controller changed.');});}}
            function checkDateAndUpdate(){const nDS=getCurrentDateString();if(nDS!==lastCheckedDateString){lastCheckedDateString=nDS;updateAllDisplays();}}

            loadDataFromLocalStorage();
            selectDOMElements();
            await loadTranslations();
            applyStaticTranslations();

            if(monthlyGoalInput)monthlyGoalInput.value=settings.monthlyGoal;if(recordDateInput)recordDateInput.value=getCurrentDateString();lastCheckedDateString=getCurrentDateString();setDateInputVisibility(false);clearRecordForm();clearPlanForm();clearRevisitForm();
            document.querySelectorAll('.card').forEach(c=>{const sE=(c.id==='record-card');c.classList.toggle('expanded',sE);const ic=c.querySelector('.toggle-icon');if(ic)ic.textContent=sE?'▲':'▼';});
            appElement?.addEventListener('click',e=>{const h=e.target.closest('.card-header');if(h){toggleCard(h.closest('.card'));}});
            document.querySelectorAll('.card-header').forEach(h=>{h.setAttribute('role','button');h.setAttribute('tabindex','0');h.addEventListener('keydown',e=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleCard(h.closest('.card'));}});});
            changeDateBtn?.addEventListener('click',()=>setDateInputVisibility(true));recordHoursInput?.addEventListener('input',formatTimeInputOnType);planHoursInput?.addEventListener('input',formatTimeInputOnType);
            recordHoursInput?.addEventListener('blur',e=>{const d=parseTimeInputToDecimal(e.target.value);if(!isNaN(d)&&d>=0){e.target.value=formatDecimalToTimeInput(d);}else if(e.target.value.trim()!==''){e.target.value='';}});
            planHoursInput?.addEventListener('blur',e=>{const d=parseTimeInputToDecimal(e.target.value);if(!isNaN(d)&&d>0){e.target.value=formatDecimalToTimeInput(d);}else if(e.target.value.trim()!==''){e.target.value='';}});
            recordNotesInput?.addEventListener('input',e=>{if(e.target.value.length>NOTES_MAX_LENGTH){e.target.value=e.target.value.substring(0,NOTES_MAX_LENGTH);showFeedback('feedback.notesLengthLimit','info',{maxLength:NOTES_MAX_LENGTH});}});
            revisitNotesInput?.addEventListener('input',e=>{if(e.target.value.length>REVISIT_NOTES_MAX_LENGTH){e.target.value=e.target.value.substring(0,REVISIT_NOTES_MAX_LENGTH);showFeedback('feedback.notesLengthLimit','info',{maxLength:REVISIT_NOTES_MAX_LENGTH});}});
            historySearchInput?.addEventListener('input',renderHistory);recordForm?.addEventListener('submit',handleRecordSubmit);planForm?.addEventListener('submit',handlePlanSubmit);revisitForm?.addEventListener('submit',handleRevisitSubmit);
            clearPlanFormBtn?.addEventListener('click',clearPlanForm);clearRevisitFormBtn?.addEventListener('click',clearRevisitForm);saveGoalBtn?.addEventListener('click',handleGoalSave);
            monthlyGoalInput?.addEventListener('keypress',e=>{if(e.key==='Enter'){e.preventDefault();handleGoalSave();e.target.blur();}});
            chartMonthSelector?.addEventListener('change',e=>renderCharts(e.target.value));
            dialogConfirmBtn?.addEventListener('click',()=>{if(typeof currentConfirmCallback==='function'){currentConfirmCallback();}hideConfirmationDialog();});
            dialogCancelBtn?.addEventListener('click',hideConfirmationDialog);confirmationDialog?.addEventListener('click',e=>{if(e.target===confirmationDialog){hideConfirmationDialog();}});
            window.addEventListener('beforeinstallprompt',e=>{e.preventDefault();deferredInstallPrompt=e;console.log('Install prompt event captured.');});
            exportDataBtn?.addEventListener('click',handleExportData);importDataBtn?.addEventListener('click',handleImportData);importFileInput?.addEventListener('change',processImportFile);languageSelector?.addEventListener('change',handleLanguageChange);
            openSyncSettingsBtn?.addEventListener('click',openSyncSettingsModal);closeSyncSettingsBtn?.addEventListener('click',closeSyncSettingsModal);saveSyncPinBtn?.addEventListener('click',saveSyncPinHandler);
            syncSettingsModal?.addEventListener('click',e=>{if(e.target===syncSettingsModal)closeSyncSettingsModal();});
            if(dateCheckInterval)clearInterval(dateCheckInterval);dateCheckInterval=setInterval(checkDateAndUpdate,60*1000);
            
            initializeSyncFramework();
            updateAllDisplays();
            registerServiceWorker();

            if (!settings.goalHasBeenSet && currentSyncPin && !document.querySelector('.dialog-backdrop.visible') && !syncSettingsModal.classList.contains('active')) {
                setTimeout(promptForMonthlyGoal, 800);
            }
            if(loadingIndicator)loadingIndicator.classList.add('hidden');console.log("App init complete.");
        })();
    </script>
</body>
</html>
