<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro de Campo Pioneiro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>
    <style>
        :root {
            --system-font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            --primary-color: #0A84FF;
            --secondary-color: #000000;
            --card-bg: #1c1c1e;
            --input-bg: #2c2c2e;
            --text-color: #ffffff;
            --text-color-secondary: rgba(235, 235, 245, 0.6);
            --border-color: #3a3a3c;
            --shadow-color: rgba(0, 0, 0, 0.2);
            --danger-color: #FF453A;
            --success-color: #30D158;
            --placeholder-color: rgba(235, 235, 245, 0.3);
            --dialog-backdrop: rgba(0, 0, 0, 0.7);
            --progress-track-color: #38383a;
            --progress-bar-color: var(--success-color);
            --avg-line-color-1: #FF9F0A; /* Orange */
            --avg-line-color-2: #AF52DE; /* Purple */
            --avg-line-color-3: #5E5CE6; /* Indigo */

            --font-family: var(--system-font);
            --border-radius: 10px;
            --card-padding: 18px;
            --outer-padding: 15px;
            --transition-speed: 0.3s;
            --transition-speed-fast: 0.1s;
            --content-transition: max-height 0.35s ease-out, opacity 0.25s ease-out 0.1s, padding 0.35s ease-out, margin 0.35s ease-out;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; -webkit-tap-highlight-color: rgba(0,0,0,0); }
        body { font-family: var(--font-family); background-color: var(--secondary-color); color: var(--text-color); line-height: 1.5; padding: var(--outer-padding); overscroll-behavior-y: contain; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; font-size: 16px; }

        #dashboard-box { background-color: var(--card-bg); border-radius: var(--border-radius); padding: 15px var(--card-padding); margin-bottom: 20px; display: flex; justify-content: space-around; align-items: flex-start; text-align: center; gap: 15px; }
        .dashboard-item { position: relative; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; flex: 1; }
        .dashboard-item--progress { width: 90px; height: 90px; flex-shrink: 0; margin-top: 5px; }
        .progress-ring { position: absolute; top: 0; left: 0; width: 100%; height: 100%; transform: rotate(-90deg); }
        .progress-ring__circle { fill: none; stroke-width: 5; transition: stroke-dashoffset 0.5s ease-out; }
        .progress-ring__bg { stroke: var(--progress-track-color); }
        .progress-ring__fg { stroke: var(--progress-bar-color); stroke-linecap: round; }
        .dashboard-item--progress .dashboard-content { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; }
        #dashboard-month-percentage { font-size: 1.6em; color: var(--text-color); margin-bottom: 0; font-weight: 600;}
        .dashboard-item--progress .dashboard-label { margin-top: 2px; margin-bottom: 0; font-size: 0.65em; }
        .dashboard-label { font-size: 0.85em; color: var(--text-color-secondary); margin-bottom: 4px; display: block; }
        .dashboard-value { font-size: 1.4em; font-weight: 500; color: var(--primary-color); line-height: 1.2; margin-bottom: 5px; }
        .dashboard-value .unit { font-size: 0.6em; font-weight: 500; color: var(--text-color-secondary); margin-left: 2px; }

        #dashboard-summary { margin-top: 12px; font-size: 0.85em; color: var(--text-color-secondary); line-height: 1.35; }
        #dashboard-summary strong { color: var(--text-color); font-weight: 500; }
        #dashboard-summary span { display: block; margin-bottom: 3px;}

        #dashboard-planned-dates .dashboard-label { margin-bottom: 8px; margin-top: 15px; }
         #dashboard-plan-list { list-style: none; padding: 0; margin: 0; text-align: left; font-size: 0.8em; line-height: 1.4; color: var(--text-color-secondary); width: 100%; max-height: 60px; overflow: hidden; }
         #dashboard-plan-list li { margin-bottom: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
         #dashboard-plan-list li strong { color: var(--text-color); }

        #app { max-width: 700px; margin: 0 auto; display: flex; flex-direction: column; gap: 12px; }
        h1 { display: none; }
        .card { background-color: var(--card-bg); border-radius: var(--border-radius); overflow: hidden; transition: box-shadow var(--transition-speed) ease; }
        .card-header { display: flex; justify-content: space-between; align-items: center; padding: 15px var(--card-padding); cursor: pointer; transition: background-color var(--transition-speed-fast) ease; position: relative; }
        .card-header::after { content: ''; position: absolute; bottom: 0; left: var(--card-padding); right: var(--card-padding); height: 1px; background-color: var(--border-color); opacity: 1; transition: opacity var(--transition-speed-fast) ease; }
        .card.expanded .card-header::after { opacity: 0; }
        .card:not(.expanded) .card-header:hover { background-color: rgba(255, 255, 255, 0.03); }
        .card-header h2 { color: var(--text-color); margin-bottom: 0; font-size: 1.15em; font-weight: 600; pointer-events: none; }
        .toggle-icon { font-size: 0.8em; font-weight: bold; transition: transform var(--transition-speed) ease; color: var(--text-color-secondary); margin-left: 10px; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; pointer-events: none; }
        .card.expanded .toggle-icon { transform: rotate(180deg); }
        .card-content { padding: 0 var(--card-padding) 0 var(--card-padding); max-height: 0; opacity: 0; overflow: hidden; border-top: 1px solid var(--border-color); transition: var(--content-transition); margin-top: -1px; }
        .card.expanded .card-content { padding-top: var(--card-padding); padding-bottom: calc(var(--card-padding) + 5px); max-height: 1500px; opacity: 1; margin-top: 0; overflow: visible; }
        .form-group { margin-bottom: 16px; }
        label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color-secondary); font-size: 0.9em; }
        input[type="date"], input[type="number"], input[type="text"], input[type="search"], textarea, select { width: 100%; padding: 11px 14px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 1em; font-family: var(--font-family); transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease; appearance: none; -webkit-appearance: none; -moz-appearance: none; background-color: var(--input-bg); color: var(--text-color); }
        input[type="text"].time-input { font-variant-numeric: tabular-nums; }
        input[type="search"] { padding-right: 35px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgba(235, 235, 245, 0.6)" class="bi bi-search" viewBox="0 0 16 16"><path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/></svg>'); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px 16px; }
        input[type="search"]::-webkit-search-cancel-button{ appearance: none; height: 14px; width: 14px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgba(235, 235, 245, 0.6)" class="bi bi-x-circle-fill" viewBox="0 0 16 16"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>'); background-size: 14px 14px; cursor: pointer; }
        select { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="rgba(235, 235, 245, 0.6)" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>'); background-repeat: no-repeat; background-position: right 14px center; background-size: 12px 12px; padding-right: 40px; }
        select:focus { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%230A84FF" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/></svg>'); }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0.8); cursor: pointer; }
        input::placeholder, textarea::placeholder { color: var(--placeholder-color); opacity: 1; }
        input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(10, 132, 255, 0.3); }
        input[type="number"] { -moz-appearance: textfield; } input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        textarea { resize: vertical; min-height: 90px; }
        button { background-color: var(--primary-color); color: var(--text-color); border: none; padding: 11px 22px; border-radius: 8px; font-size: 1em; font-weight: 600; cursor: pointer; transition: background-color var(--transition-speed-fast) ease, transform var(--transition-speed-fast) ease, filter var(--transition-speed-fast) ease; display: inline-block; margin-right: 8px; margin-top: 10px; width: auto; transform: scale(1); filter: brightness(1); -webkit-user-select: none; /* Prevent text selection during quick taps */ user-select: none; }
        button:hover { filter: brightness(1.15); }
        button:active { transform: scale(0.95); filter: brightness(0.8); transition-duration: 0.05s; }
        button.secondary { background-color: var(--input-bg); color: var(--primary-color); border: 1px solid var(--border-color); } button.secondary:hover { background-color: #3a3a3c; filter: none; } button.secondary:active { background-color: #48484a; transform: scale(0.96); filter: brightness(1); }
        button.danger { background-color: var(--danger-color); color: var(--text-color); } button.danger:hover { background-color: #ff3b30; filter: brightness(1.15); } button.danger:active { background-color: #E0352D; transform: scale(0.96); filter: brightness(0.85); }
        /* Removido ajuste para 50% - bot√µes de registro agora s√£o de largura autom√°tica */
        #record-form .text-center button, #plan-form .text-center button { width: auto; margin-right: 8px; } /* Default width */
        /* Corre√ß√£o: Assegurar que bot√£o Salvar registro fique √† esquerda */
         #record-form .text-center button:last-child { margin-right: 0; }
        /* Mantem media query apenas para plano se necess√°rio, mas geralmente 'auto' funciona */
         @media (min-width: 600px) { #plan-form .text-center button { /* width: auto;  -- j√° √© auto */ } }


        .change-date-button { background: none; border: none; color: var(--primary-color); cursor: pointer; font-size: 0.9em; padding: 5px 0; margin-left: 5px; text-align: left; width: auto; margin-right: 0; margin-top: 0; } .change-date-button:hover { text-decoration: underline; } .change-date-button:active { transform: scale(0.95); filter: brightness(0.8); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; text-align: center; margin-top: 10px;}
        .stat-item { background-color: var(--input-bg); padding: 16px 12px; border-radius: 8px; }
        .stat-value { font-size: 1.7em; font-weight: 600; color: var(--text-color); display: block; margin-bottom: 2px; }
        .stat-label { font-size: 0.85em; color: var(--text-color-secondary); }
        .progress-bar-container { background-color: var(--border-color); border-radius: 5px; overflow: hidden; height: 8px; margin-top: 8px; }
        .progress-bar { background-color: var(--progress-bar-color); height: 100%; width: 0; transition: width var(--transition-speed) ease-out; }
        #history-controls { margin-bottom: 15px; display: flex; gap: 10px; padding: 0 var(--card-padding) }
        .history-search-input { flex-grow: 1; }
        #showing-results-label { font-size: 0.85em; color: var(--text-color-secondary); margin-top: 5px; display: block; text-align: right; padding: 0 var(--card-padding) 5px var(--card-padding) ; min-height: 1.2em;}
        .data-list { list-style: none; padding: 0; max-height: 400px; overflow-y: auto; margin-top: 0; }
        .data-list li { background-color: transparent; border-bottom: 1px solid var(--border-color); padding: 14px var(--card-padding); margin: 0; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; transition: background-color var(--transition-speed-fast) ease; }
        .data-list li:last-child { border-bottom: none; }
        .data-list li:hover { background-color: rgba(255, 255, 255, 0.02); }
        .entry-details { font-size: 0.95em; flex-grow: 1; margin-right: 10px; line-height: 1.4; padding-bottom: 5px; }
        .entry-details strong { color: var(--text-color); font-weight: 500; }
        .entry-details .hours { color: var(--primary-color); font-weight: 600; margin-left: 5px; margin-right: 5px; }
        .entry-details .tag-badge { display: inline-block; background-color: var(--input-bg); color: var(--text-color-secondary); font-size: 0.75em; padding: 2px 6px; border-radius: 5px; margin-left: 8px; vertical-align: middle; }
        .entry-details .notes-preview { color: var(--text-color-secondary); font-size: 0.9em; display: block; margin-top: 5px; white-space: normal; overflow-wrap: break-word; max-height: 4.5em; overflow: hidden; }
        .entry-actions { flex-shrink: 0; align-self: center; }
        .entry-actions button, .plan-actions button { padding: 6px 10px; font-size: 0.85em; margin-left: 5px; margin-top: 0; width: auto; border-radius: 6px; }
        .plan-actions button { margin-top: 5px; }
        .entry-actions button.secondary, .plan-actions button.secondary { background-color: #3a3a3c; }
        .chart-container { position: relative; height: 280px; width: 100%; margin-top: 25px; }
        .dialog-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--dialog-backdrop); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity var(--transition-speed) ease, visibility var(--transition-speed) ease; }
        .dialog-backdrop.visible { opacity: 1; visibility: visible; }
        .dialog-content { background-color: #2c2c2e; color: var(--text-color); padding: 25px; border-radius: 14px; box-shadow: 0 8px 30px rgba(0,0,0,0.4); text-align: center; max-width: 90%; width: 320px; transform: scale(0.95); transition: transform var(--transition-speed) ease; }
        .dialog-backdrop.visible .dialog-content { transform: scale(1); }
        .dialog-content p { margin-bottom: 25px; font-size: 1.05em; line-height: 1.5; }
        .dialog-actions button { width: calc(50% - 5px); margin-top: 0; padding: 10px; font-size: 1em;}
        .hidden { display: none !important; }
        .visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }
        .text-center { text-align: center; } .mt-1 { margin-top: 10px; } .mt-2 { margin-top: 20px; }
    </style>
</head>
<body>
    <div id="dashboard-box">
         <div class="dashboard-item" style="align-items: flex-start; text-align: left;">
             <span class="dashboard-label">Horas Semana</span>
             <span id="dashboard-week-hours" class="dashboard-value">0 horas</span>
              <div id="dashboard-summary" style="margin-top: 12px;">
                 <span id="dashboard-month-total">M√™s: <strong>0 horas</strong></span>
                 <span id="dashboard-forecast">Meta: ...</span>
             </div>
             <div class="hidden" id="dashboard-planned-dates">
                <span class="dashboard-label" style="margin-top: 15px;">Pr√≥ximos Planos</span>
                <ul id="dashboard-plan-list"></ul>
             </div>
         </div>
         <div class="dashboard-item dashboard-item--progress">
            <svg viewBox="0 0 36 36" class="progress-ring">
                 <circle class="progress-ring__circle progress-ring__bg" cx="18" cy="18" r="15.9155"></circle>
                 <circle id="progress-ring-fg" class="progress-ring__circle progress-ring__fg" cx="18" cy="18" r="15.9155" stroke-dasharray="100 100" stroke-dashoffset="100"></circle>
            </svg>
            <div class="dashboard-content">
                <span id="dashboard-month-percentage" class="dashboard-value">0%</span>
                <span class="dashboard-label">Meta M√™s</span>
             </div>
         </div>

    </div>

    <div id="app">

        <div class="card expanded" id="record-card">
             <div class="card-header">
                 <h2>Registrar Atividade</h2>
                 <span class="toggle-icon">‚ñ≤</span>
             </div>
            <div class="card-content">
                <form id="record-form">
                    <input type="hidden" id="record-id">
                    <div class="form-group">
                        <label for="record-date" id="date-label">
                             Data: <strong id="display-date">Hoje</strong>
                            <button type="button" class="change-date-button" id="change-date-btn">(Alterar)</button>
                        </label>
                        <input type="date" id="record-date" class="hidden">
                    </div>
                     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                         <div class="form-group">
                             <label for="record-hours">Tempo:</label>
                             <input type="text" inputmode="numeric" id="record-hours" class="time-input" required placeholder="Ex: 2:30 ou 130">
                         </div>
                        <div class="form-group">
                            <label for="record-tag">Modalidade:</label>
                            <select id="record-tag">
                                <option value="Casa em casa" selected>Casa em casa</option>
                                <option value="Carrinho">Carrinho</option>
                                <option value="Cartas">Cartas</option>
                                <option value="Telefone">Telefone</option>
                                <option value="Outro">Outro</option>
                            </select>
                        </div>
                     </div>
                    <div class="form-group">
                        <label for="record-notes">Notas / Observa√ß√µes (max 300):</label>
                        <textarea id="record-notes" rows="3" maxlength="300" placeholder="Descreva a atividade..."></textarea>
                    </div>
                    <div class="text-center" style="margin-top: 20px;">
                        <button type="submit" id="save-record-btn">Salvar Registro</button>
                        <!-- Bot√£o Limpar foi removido -->
                    </div>
                </form>
            </div>
        </div>

        <div class="card" id="plan-card">
             <div class="card-header">
                <h2>Planejar Horas</h2>
                <span class="toggle-icon">‚ñº</span>
             </div>
             <div class="card-content">
                <form id="plan-form"> <input type="hidden" id="plan-id"> <div class="form-group"><label for="plan-date">Data Futura:</label><input type="date" id="plan-date" required></div> <div class="form-group"><label for="plan-hours">Horas Planejadas (HH:MM):</label> <input type="text" inputmode="numeric" id="plan-hours" class="time-input" required placeholder="Ex: 3:00 ou 130"></div> <div class="text-center"> <button type="submit" id="save-plan-btn">Salvar Plano</button> <button type="button" id="clear-plan-form-btn" class="secondary">Limpar</button> </div> </form>
                <div id="planning-list-container" class="mt-2">
                    <h3 style="font-size: 1em; font-weight: 600; color: var(--text-color-secondary); margin-bottom: 10px; padding-left: var(--card-padding);">Pr√≥ximos Planos (Interno):</h3>
                    <ul id="planning-list" class="data-list"> <li class="placeholder hidden" style="padding-left: var(--card-padding);">Nenhum planejamento futuro.</li> </ul>
                </div>
             </div>
        </div>

        <div class="card" id="stats-card">
            <div class="card-header">
                <h2>Resumo Mensal Detalhado</h2>
                <span class="toggle-icon">‚ñº</span>
             </div>
             <div class="card-content">
                <div class="form-group" style="max-width: 200px; margin: 0 auto 25px auto; text-align:center;"> <label for="monthly-goal">Meta Mensal (Horas):</label> <input type="number" id="monthly-goal" min="1" step="1" value="70"> <button id="save-goal-btn" class="mt-1 secondary" style="width:100%; font-size:0.9em; padding: 8px 10px;">Definir Meta</button> </div> <div class="stats-grid"> <div class="stat-item"> <span id="stats-month-hours" class="stat-value">0</span> <span class="stat-label">Horas no M√™s</span> </div> <div class="stat-item"> <span id="stats-month-goal-progress" class="stat-value">0%</span> <span class="stat-label">Progresso Meta</span> <div class="progress-bar-container"><div id="stats-month-progress-bar" class="progress-bar"></div></div> </div> <div class="stat-item"> <span id="stats-avg-hours-day" class="stat-value">0</span> <span class="stat-label">M√©dia / Dia Ativo</span> </div> <div class="stat-item"> <span id="stats-month-days-active" class="stat-value">0</span> <span class="stat-label">Dias Ativos</span> </div> </div>
             </div>
        </div>

        <div class="card" id="charts-card">
            <div class="card-header">
                 <h2>Gr√°fico de Horas</h2>
                 <span class="toggle-icon">‚ñº</span>
             </div>
             <div class="card-content">
                 <div class="form-group"> <label for="chart-month-selector">Visualizar M√™s:</label> <select id="chart-month-selector"></select> </div> <div class="chart-container"> <canvas id="monthlyHoursChart"></canvas> </div>
             </div>
        </div>

        <div class="card" id="history-card">
            <div class="card-header">
                <h2>Hist√≥rico de Registros</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
             <div class="card-content">
                 <div id="history-controls">
                    <input type="search" id="history-search-input" class="history-search-input" placeholder="Pesquisar notas, tags, datas...">
                 </div>
                 <span id="showing-results-label"></span>
                 <ul id="history-list" class="data-list">
                    <li class="placeholder hidden" style="padding-left: var(--card-padding);">Nenhum registro encontrado.</li>
                 </ul>
            </div>
        </div>

        <div class="card" id="settings-card">
            <div class="card-header">
                <h2>Configura√ß√µes</h2>
                <span class="toggle-icon">‚ñº</span>
            </div>
            <div class="card-content">
                <div class="text-center"> <button id="clear-all-data-btn" class="danger">Limpar Todos os Dados</button> </div> <p style="margin-top: 15px; font-size: 0.9em; color: var(--text-color-secondary); text-align: center; line-height: 1.4;"> Aten√ß√£o: Limpar os dados remover√° permanentemente todos os seus registros, planos e meta deste navegador. Esta a√ß√£o n√£o pode ser desfeita. </p>
            </div>
        </div>

    </div>

    <div id="confirmation-dialog" class="dialog-backdrop"> <div class="dialog-content"> <p id="dialog-message">Voc√™ tem certeza?</p> <div class="dialog-actions"> <button id="dialog-confirm-btn" class="danger">Confirmar</button> <button id="dialog-cancel-btn" class="secondary">Cancelar</button> </div> </div> </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {

            const appElement = document.getElementById('app');
            const dashboardWeekHours = document.getElementById('dashboard-week-hours');
            const dashboardMonthPercentage = document.getElementById('dashboard-month-percentage');
            const dashboardMonthTotal = document.getElementById('dashboard-month-total');
            const dashboardForecast = document.getElementById('dashboard-forecast');
            const dashboardPlannedDatesContainer = document.getElementById('dashboard-planned-dates');
            const dashboardPlanList = document.getElementById('dashboard-plan-list');
            const progressRingFg = document.getElementById('progress-ring-fg');
            const recordCard = document.getElementById('record-card');
            const recordForm = document.getElementById('record-form');
            const recordIdInput = document.getElementById('record-id');
            const recordDateInput = document.getElementById('record-date');
            const dateLabel = document.getElementById('date-label');
            const displayDate = document.getElementById('display-date');
            const changeDateBtn = document.getElementById('change-date-btn');
            const recordHoursInput = document.getElementById('record-hours');
            const recordTagSelect = document.getElementById('record-tag');
            const recordNotesInput = document.getElementById('record-notes');
            const saveRecordBtn = document.getElementById('save-record-btn');
            const planCard = document.getElementById('plan-card');
            const planForm = document.getElementById('plan-form');
            const planIdInput = document.getElementById('plan-id');
            const planDateInput = document.getElementById('plan-date');
            const planHoursInput = document.getElementById('plan-hours');
            const savePlanBtn = document.getElementById('save-plan-btn');
            const clearPlanFormBtn = document.getElementById('clear-plan-form-btn');
            const planningList = document.getElementById('planning-list');
            const planningListPlaceholder = planningList.querySelector('.placeholder');
            const monthlyGoalInput = document.getElementById('monthly-goal');
            const saveGoalBtn = document.getElementById('save-goal-btn');
            const statsMonthHours = document.getElementById('stats-month-hours');
            const statsMonthGoalProgress = document.getElementById('stats-month-goal-progress');
            const statsMonthProgressBar = document.getElementById('stats-month-progress-bar');
            const statsAvgHoursDay = document.getElementById('stats-avg-hours-day');
            const statsMonthDaysActive = document.getElementById('stats-month-days-active');
            const chartMonthSelector = document.getElementById('chart-month-selector');
            const monthlyHoursChartCtx = document.getElementById('monthlyHoursChart').getContext('2d');
            const historyList = document.getElementById('history-list');
            const historySearchInput = document.getElementById('history-search-input');
            const historyListPlaceholder = historyList.querySelector('.placeholder');
            const showingResultsLabel = document.getElementById('showing-results-label');
            const clearAllDataBtn = document.getElementById('clear-all-data-btn');
            const confirmationDialog = document.getElementById('confirmation-dialog');
            const dialogMessage = document.getElementById('dialog-message');
            const dialogConfirmBtn = document.getElementById('dialog-confirm-btn');
            const dialogCancelBtn = document.getElementById('dialog-cancel-btn');

            let recordedEntries = [];
            let plannedEntries = [];
            let settings = { monthlyGoal: 70, goalHasBeenSet: false };
            let monthlyHoursChartInstance = null;
            let currentEditingId = null;
            let currentConfirmCallback = null;
            let isDateInputVisible = false;
            const DEFAULT_TAG = "Casa em casa";
            const HISTORY_MONTH_LIMIT = 3;
            const NOTES_MAX_LENGTH = 300;
            const MIN_HOURS_PER_DAY_FORECAST = 1.0;
            const progressRingRadius = progressRingFg.r.baseVal.value;
            const progressRingCircumference = 2 * Math.PI * progressRingRadius;

            const computedStyles = getComputedStyle(document.body);
            const textColor = computedStyles.getPropertyValue('--text-color').trim();
            const textMutedColor = computedStyles.getPropertyValue('--text-color-secondary').trim();
            const gridColor = computedStyles.getPropertyValue('--border-color').trim();
            const tooltipBgColor = computedStyles.getPropertyValue('--card-bg').trim();
            const primaryColor = computedStyles.getPropertyValue('--primary-color').trim();
            const avgLineColor1 = computedStyles.getPropertyValue('--avg-line-color-1').trim();
            const avgLineColor2 = computedStyles.getPropertyValue('--avg-line-color-2').trim();
            const avgLineColor3 = computedStyles.getPropertyValue('--avg-line-color-3').trim();

            const MONTH_NAMES_PT = ["janeiro", "fevereiro", "mar√ßo", "abril", "maio", "junho", "julho", "agosto", "setembro", "outubro", "novembro", "dezembro"];
            const WEEKDAY_NAMES_PT = ["Dom", "Seg", "Ter", "Qua", "Qui", "Sex", "S√°b"];

            const LOCAL_STORAGE_KEYS = {
                ENTRIES: 'pioneerTracker_entries_v5.1',
                PLANS: 'pioneerTracker_plans_v1.1',
                SETTINGS: 'pioneerTracker_settings_v1.1'
            };

            if (window.ChartAnnotation) {
                Chart.register(ChartAnnotation);
            } else {
                console.error("ChartAnnotation plugin failed to load or register!");
            }

            function getCurrentDateString() { const t=new Date();return `${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`; }
            function formatDisplayDate(dateString) { if (!dateString || !dateString.includes('-')) return dateString; const [y, m, d] = dateString.split('-'); return `${d}/${m}/${y}`; }
            function getMonthYearString(date) { const m = String(date.getMonth() + 1).padStart(2, '0'); const y = date.getFullYear(); return `${m}/${y}`; }
            function getStartOfWeek(date = new Date()) { const d = new Date(date); const dayOfWeek = d.getDay(); const diff = d.getDate() - dayOfWeek; const sOW = new Date(d.setDate(diff)); sOW.setHours(0,0,0,0); return `${sOW.getFullYear()}-${String(sOW.getMonth()+1).padStart(2,'0')}-${String(sOW.getDate()).padStart(2,'0')}`; }
            function getDateMonthsAgo(months) { const d = new Date(); d.setMonth(d.getMonth() - months); d.setHours(0,0,0,0); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
            function formatMonthYearExtensive(monthYearString) { if (!monthYearString || !monthYearString.includes('/')) return monthYearString; const [m, y] = monthYearString.split('/'); const monthIndex = parseInt(m, 10) - 1; if (monthIndex < 0 || monthIndex > 11) return monthYearString; return `${MONTH_NAMES_PT[monthIndex]} de ${y}`; }
            function formatHoursExtensive(hoursDecimal, short = false) { if (isNaN(hoursDecimal) || hoursDecimal < 0) return short ? '0h' : '0 horas'; const totalMinutes = Math.round((hoursDecimal || 0) * 60); const hours = Math.floor(totalMinutes / 60); const minutes = totalMinutes % 60; let result = ''; const hSuffix = short ? 'h' : ` ${hours === 1 ? 'hora' : 'horas'}`; const mSuffix = short ? 'm' : ` ${minutes === 1 ? 'minuto' : 'minutos'}`; if (hours > 0) { result += `${hours}${hSuffix}`; } if (minutes > 0) { result += `${hours > 0 ? (short ? ' ' : ' e ') : ''}${minutes}${mSuffix}`; } if (!result && hoursDecimal === 0) { result = short ? '0h' : '0 horas'; } else if (!result && minutes > 0) { result = `${minutes}${mSuffix}`; } return result; }
            function formatDecimalToTimeInput(decimalHours) { if (isNaN(decimalHours) || decimalHours <= 0) return ""; const totalMinutes = Math.round((decimalHours || 0) * 60); const hours = Math.floor(totalMinutes / 60); const minutes = totalMinutes % 60; return `${hours}:${String(minutes).padStart(2, '0')}`; }
            function parseTimeInputToDecimal(timeString) {
                 if (!timeString) return 0;
                 const trimmed = timeString.trim();
                 if (!trimmed) return 0;
                 const colonMatch = trimmed.match(/^(\d{1,3}):(\d{1,2})$/);
                 if (colonMatch) {
                     const hours = parseInt(colonMatch[1], 10);
                     const minutes = parseInt(colonMatch[2], 10);
                     if (!isNaN(hours) && !isNaN(minutes) && minutes >= 0 && minutes < 60 && hours >= 0) {
                         return hours + (minutes / 60);
                     } else {
                         return NaN;
                     }
                 }
                 const numberMatch = trimmed.match(/^(\d+)$/);
                 if (numberMatch) {
                     const numStr = numberMatch[1];
                     const numVal = parseInt(numStr, 10);
                     if(isNaN(numVal)) return NaN;
                     if (numStr.length <= 2) {
                         if (numVal < 60) return numVal / 60;
                     }
                     if (numStr.length >= 3) {
                        const potentialHoursStr = numStr.slice(0, -2);
                        const potentialMinutesStr = numStr.slice(-2);
                        const hours = parseInt(potentialHoursStr, 10);
                        const minutes = parseInt(potentialMinutesStr, 10);
                        if (!isNaN(hours) && !isNaN(minutes) && minutes >= 0 && minutes < 60 && hours >= 0) {
                           return hours + (minutes / 60);
                        } else {
                           return NaN;
                        }
                     }
                     return NaN;
                 }
                 return NaN;
            }
            function formatRelativeDate(dateString) { const today = new Date(); today.setHours(0,0,0,0); const inputDate = new Date(dateString+'T00:00:00'); if (isNaN(inputDate)) return formatDisplayDate(dateString); const tomorrow = new Date(today); tomorrow.setDate(today.getDate() + 1); const oneWeekFromToday = new Date(today); oneWeekFromToday.setDate(today.getDate() + 7); if (inputDate.getTime() === today.getTime()) { return "Hoje"; } if (inputDate.getTime() === tomorrow.getTime()) { return "Amanh√£"; } if (inputDate > tomorrow && inputDate < oneWeekFromToday) { return `Pr√≥x. ${WEEKDAY_NAMES_PT[inputDate.getDay()]}`; } return formatDisplayDate(dateString); }

            function saveData() { try{localStorage.setItem(LOCAL_STORAGE_KEYS.ENTRIES, JSON.stringify(recordedEntries)); localStorage.setItem(LOCAL_STORAGE_KEYS.PLANS, JSON.stringify(plannedEntries)); localStorage.setItem(LOCAL_STORAGE_KEYS.SETTINGS, JSON.stringify(settings));} catch(e) { console.error("SAVE ERR:",e); showFeedback('Falha ao salvar dados.', 'danger');} }
            function loadData() { try { let sER = localStorage.getItem(LOCAL_STORAGE_KEYS.ENTRIES); if (sER) { try { const parsedEntries = JSON.parse(sER); if(Array.isArray(parsedEntries)) { recordedEntries = parsedEntries.map(e => ({ ...e, notes: e.notes?.substring(0, NOTES_MAX_LENGTH) || '' }));} else { throw new Error("Stored entries not an array"); } } catch (parseErr) { console.error("Error parsing stored entries, resetting:", parseErr); sER = null; recordedEntries = []; localStorage.removeItem(LOCAL_STORAGE_KEYS.ENTRIES); } } else { recordedEntries = []; } recordedEntries.sort((a, b) => new Date(b.date) - new Date(a.date)); const sP = localStorage.getItem(LOCAL_STORAGE_KEYS.PLANS); plannedEntries = sP ? JSON.parse(sP) : []; plannedEntries.forEach(p => { if (p.plannedHours !== undefined && typeof p.plannedHours === 'number') { p.hours = p.plannedHours; delete p.plannedHours; } }); plannedEntries.sort((a, b) => new Date(a.date) - new Date(b.date)); const sSR = localStorage.getItem(LOCAL_STORAGE_KEYS.SETTINGS); let lS = sSR ? JSON.parse(sSR) : {}; settings = { monthlyGoal: 70, goalHasBeenSet: false, ...lS }; if (isNaN(settings.monthlyGoal) || settings.monthlyGoal <= 0) settings.monthlyGoal = 70; if (typeof settings.goalHasBeenSet !== 'boolean') settings.goalHasBeenSet = false; monthlyGoalInput.value = settings.monthlyGoal; console.log("Data loaded.");} catch(err) { console.error("Load Err:", err); recordedEntries = []; plannedEntries = []; settings = { monthlyGoal: 70, goalHasBeenSet: false }; try { localStorage.removeItem(LOCAL_STORAGE_KEYS.ENTRIES); localStorage.removeItem(LOCAL_STORAGE_KEYS.PLANS); localStorage.removeItem(LOCAL_STORAGE_KEYS.SETTINGS); } catch (e) { console.error("Error removing invalid storage items:", e);} showFeedback('Erro ao carregar, dados resetados.', 'danger');} }

            function promptForMonthlyGoal() { let gS=false; while(!gS){ const gI=prompt("Por favor, informe sua meta mensal de horas (ex: 70):", settings.monthlyGoal); if (gI===null){ gS=true; if (!settings.goalHasBeenSet) settings.goalHasBeenSet = true; saveData(); } else { const g = parseInt(gI,10); if (!isNaN(g)&&g>0) { settings.monthlyGoal=g; settings.goalHasBeenSet=true; monthlyGoalInput.value=g; saveData(); gS=true; updateAllDisplays(); showFeedback("Meta definida!","success"); } else { alert("Valor inv√°lido. Por favor, insira um n√∫mero positivo para a meta."); } } } }
            function setDateInputVisibility(visible) { isDateInputVisible=visible; if(visible){ recordDateInput.classList.remove('hidden'); dateLabel.classList.add('visually-hidden'); recordDateInput.focus(); } else { recordDateInput.classList.add('hidden'); dateLabel.classList.remove('visually-hidden'); displayDate.textContent=(!recordDateInput.value || recordDateInput.value===getCurrentDateString())?"Hoje":formatDisplayDate(recordDateInput.value);}}
            changeDateBtn.addEventListener('click',()=>setDateInputVisibility(true));
            function toggleCard(cardElement){ if(!cardElement)return;const iE=cardElement.classList.contains('expanded');cardElement.classList.toggle('expanded',!iE);const ic=cardElement.querySelector('.toggle-icon');if(ic){ic.textContent=!iE?'‚ñ≤':'‚ñº';}}
            appElement.addEventListener('click', (event) => { const header = event.target.closest('.card-header'); if (header) { const card = header.closest('.card'); if (card) { toggleCard(card); } } });
            document.querySelectorAll('.card-header').forEach(header => { header.setAttribute('role','button');header.setAttribute('tabindex','0');header.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleCard(header.closest('.card'));}});});

            function clearRecordForm() {
                 recordForm.reset(); recordIdInput.value='';
                 recordDateInput.value = getCurrentDateString(); setDateInputVisibility(false);
                 recordTagSelect.value = DEFAULT_TAG;
                 recordNotesInput.value = '';
                 recordHoursInput.value='';
                 saveRecordBtn.textContent='Salvar Registro';
                 saveRecordBtn.classList.remove('editing');
                 currentEditingId=null;
             }

            function handleRecordSubmit(event) { event.preventDefault(); const id=recordIdInput.value?parseInt(recordIdInput.value, 10):Date.now(); const date=(isDateInputVisible||(recordDateInput.value&&recordDateInput.value!==getCurrentDateString()))?recordDateInput.value:getCurrentDateString(); const hoursInput = recordHoursInput.value; const hours = parseTimeInputToDecimal(hoursInput); const tag = recordTagSelect.value || DEFAULT_TAG; const notes = recordNotesInput.value.trim().substring(0, NOTES_MAX_LENGTH); if (isNaN(hours) || hours <= 0){ alert("Formato de Tempo inv√°lido (ex: 2:30, 1:15, 45, 130). O tempo deve ser positivo."); recordHoursInput.focus(); return; } if (!date){ alert("Data inv√°lida."); return; } const newEntry = {id, date, hours, tag, notes}; const eI=recordedEntries.findIndex(entry => entry.id === id); if (eI > -1) {recordedEntries[eI]=newEntry;} else {recordedEntries.push(newEntry);} recordedEntries.sort((a,b) => new Date(b.date)-new Date(a.date)); saveData(); clearRecordForm(); updateAllDisplays(); showFeedback('Registro salvo!','success');}
            function editRecordEntry(id) { const entry=recordedEntries.find(e => e.id === id); if(entry) { if(!recordCard.classList.contains('expanded')){toggleCard(recordCard);} currentEditingId=id; recordIdInput.value=entry.id; recordDateInput.value=entry.date; if(entry.date !== getCurrentDateString()){setDateInputVisibility(true);} else {setDateInputVisibility(false);} recordHoursInput.value=formatDecimalToTimeInput(entry.hours); recordTagSelect.value=entry.tag||DEFAULT_TAG; recordNotesInput.value=entry.notes||''; saveRecordBtn.textContent='Atualizar Registro'; saveRecordBtn.classList.add('editing'); recordCard.scrollIntoView({behavior:'smooth', block:'start'}); recordHoursInput.focus();}}
            function deleteRecordEntry(id) { showConfirmationDialog(`Tem certeza que deseja excluir este registro? Esta a√ß√£o n√£o pode ser desfeita.`, () => { const index = recordedEntries.findIndex(e => e.id === id); if (index > -1) { recordedEntries.splice(index, 1); saveData(); updateAllDisplays(); showFeedback('Registro exclu√≠do.','info'); if(currentEditingId === id) {clearRecordForm();}} else { console.warn("Entry not found for deletion:", id);} }); }

            function clearPlanForm(){ planForm.reset(); planIdInput.value=''; planDateInput.value=''; planHoursInput.value=''; savePlanBtn.textContent='Salvar Plano'; currentEditingId=null; }
            function handlePlanSubmit(event){ event.preventDefault(); const id=planIdInput.value?parseInt(planIdInput.value,10):Date.now(); const date=planDateInput.value; const hoursInput = planHoursInput.value; const hours = parseTimeInputToDecimal(hoursInput); const todayStr=getCurrentDateString(); if(!date||isNaN(hours)||hours<=0){alert("Preencha a Data Futura e as Horas Planejadas (ex: 2:30, 45). Devem ser valores positivos."); planHoursInput.focus(); return;} if(date<todayStr){alert("A data do planejamento deve ser hoje ou uma data futura."); planDateInput.focus(); return;} const nP={id, date, hours}; const eI=plannedEntries.findIndex(p=>p.id===id); if(eI>-1){plannedEntries[eI]=nP;}else{plannedEntries.push(nP);} plannedEntries.sort((a,b)=>new Date(a.date)-new Date(b.date)); saveData(); clearPlanForm(); renderPlanning(); updateDashboardPlannedDates(); showFeedback('Planejamento salvo!','success'); }
            function editPlanEntry(id){ const plan=plannedEntries.find(p=>p.id===id); if(plan){ if(!planCard.classList.contains('expanded')){toggleCard(planCard);} currentEditingId=id; planIdInput.value=plan.id; planDateInput.value=plan.date; planHoursInput.value=formatDecimalToTimeInput(plan.hours); savePlanBtn.textContent='Atualizar Plano'; planCard.scrollIntoView({behavior:'smooth',block:'start'}); planHoursInput.focus();} }
            function deletePlanEntry(id){ showConfirmationDialog(`Tem certeza que deseja excluir este planejamento?`,()=>{plannedEntries=plannedEntries.filter(p=>p.id!==id);saveData();renderPlanning(); updateDashboardPlannedDates(); showFeedback('Planejamento exclu√≠do.','info');if(currentEditingId===id){clearPlanForm();}}); }

            function handleGoalSave(){ const nG=parseInt(monthlyGoalInput.value,10);if(!isNaN(nG)&&nG>0){ settings.monthlyGoal=nG; settings.goalHasBeenSet=true; saveData(); updateAllDisplays(); showFeedback('Meta mensal atualizada!','success');}else{alert("Meta inv√°lida. Use um n√∫mero positivo.");monthlyGoalInput.value=settings.monthlyGoal;} }
            function handleClearAllData() { showConfirmationDialog('ATEN√á√ÉO! TEM CERTEZA? Isto apagar√° TODOS os registros, planos e sua meta PERMANENTEMENTE. Esta a√ß√£o √© IRREVERS√çVEL!', () => { recordedEntries=[]; plannedEntries=[]; settings={ monthlyGoal: 70, goalHasBeenSet: false }; monthlyGoalInput.value = settings.monthlyGoal; saveData(); clearRecordForm(); clearPlanForm(); updateAllDisplays(); showFeedback('Todos os dados foram apagados com sucesso.', 'danger'); document.querySelectorAll('.card').forEach(c => { if(c.id!=='record-card'&&c.classList.contains('expanded')) toggleCard(c); else if(c.id==='record-card'&&!c.classList.contains('expanded')) toggleCard(c); }); }); }

            function showConfirmationDialog(message,onConfirm){dialogMessage.textContent=message;currentConfirmCallback=onConfirm;confirmationDialog.classList.add('visible'); dialogConfirmBtn.focus();}
            function hideConfirmationDialog(){confirmationDialog.classList.remove('visible'); setTimeout(() => { currentConfirmCallback = null;}, 300); }
            dialogConfirmBtn.addEventListener('click',()=>{ try { if(typeof currentConfirmCallback === 'function'){ currentConfirmCallback(); } } catch(e) { console.error("Error in confirmation callback:", e); } finally { hideConfirmationDialog(); } });
            dialogCancelBtn.addEventListener('click',hideConfirmationDialog); confirmationDialog.addEventListener('click',(e)=>{if(e.target===confirmationDialog){hideConfirmationDialog();}});
            function showFeedback(message, type='info'){
                console.log(`Feedback[${type}]: ${message}`);
                const feedbackElement = document.createElement('div');
                 feedbackElement.textContent = message;
                 feedbackElement.style.position = 'fixed';
                 feedbackElement.style.bottom = '20px';
                 feedbackElement.style.left = '50%';
                 feedbackElement.style.transform = 'translateX(-50%)';
                 feedbackElement.style.padding = '10px 20px';
                 feedbackElement.style.borderRadius = '8px';
                 feedbackElement.style.zIndex = '1100';
                 feedbackElement.style.boxShadow = '0 4px 15px rgba(0,0,0,0.2)';
                 feedbackElement.style.fontSize = '0.95em';
                 feedbackElement.style.transition = 'opacity 0.5s ease, bottom 0.5s ease';
                 feedbackElement.style.opacity = '0';
                 switch (type) {
                     case 'success': feedbackElement.style.backgroundColor = 'var(--success-color)'; feedbackElement.style.color = 'var(--text-color)'; break;
                     case 'danger': feedbackElement.style.backgroundColor = 'var(--danger-color)'; feedbackElement.style.color = 'var(--text-color)'; break;
                     case 'info': default: feedbackElement.style.backgroundColor = 'var(--primary-color)'; feedbackElement.style.color = 'var(--text-color)'; break;
                 }
                 document.body.appendChild(feedbackElement);
                 setTimeout(() => { feedbackElement.style.opacity = '1'; feedbackElement.style.bottom = '30px'; }, 10);
                 setTimeout(() => { feedbackElement.style.opacity = '0'; feedbackElement.style.bottom = '10px'; }, 3500);
                 setTimeout(() => { if (feedbackElement.parentNode) { feedbackElement.parentNode.removeChild(feedbackElement); } }, 4000);
             }

            function updateDashboard() {
                const today=new Date(); const cM=today.getMonth(); const cY=today.getFullYear(); const sOW=getStartOfWeek(today); let mH=0; let wH=0;
                recordedEntries.forEach(e => { const eD = new Date(e.date+'T00:00:00'); if(eD.getMonth() === cM && eD.getFullYear() === cY){ mH += e.hours; } if(e.date >= sOW && e.date <= getCurrentDateString()){ wH += e.hours; } });
                dashboardWeekHours.textContent = formatHoursExtensive(wH);
                const goal = settings.monthlyGoal || 70; const percent = goal > 0 ? Math.min(100, (mH / goal) * 100) : 0; dashboardMonthPercentage.textContent = `${Math.round(percent)}%`; updateProgressRing(mH, goal); dashboardMonthTotal.innerHTML = `M√™s: <strong>${formatHoursExtensive(mH)}</strong>`;
                const lastDay = new Date(cY, cM + 1, 0).getDate(); const todayDay = today.getDate(); const remainingDays = Math.max(0, lastDay - todayDay); const remainingHours = Math.max(0, goal - mH); let forecastText = '';
                if (!settings.goalHasBeenSet) { forecastText = `<span>Defina sua meta mensal.</span>`;}
                 else if (remainingHours <= 0) { forecastText = `<span>Meta Alcan√ßada! üéâ</span>`; }
                else if (remainingDays <= 0) { forecastText = `<span>Meta n√£o atingida este m√™s.</span>`; }
                 else { let avgNeeded = remainingHours / remainingDays; let daysNeeded = remainingDays; let suggestion = ''; if (avgNeeded > 0 && avgNeeded < MIN_HOURS_PER_DAY_FORECAST) { daysNeeded = Math.ceil(remainingHours / MIN_HOURS_PER_DAY_FORECAST); avgNeeded = MIN_HOURS_PER_DAY_FORECAST; } suggestion = `Tente ‚âà<strong>${formatHoursExtensive(avgNeeded, true)}</strong>/${daysNeeded > 1 ? 'dia' : 'dia'} por ${daysNeeded} ${daysNeeded === 1 ? 'dia' : 'dias'}.`; forecastText = `<span>Faltam ${formatHoursExtensive(remainingHours)}.</span><span>${suggestion}</span>`; } dashboardForecast.innerHTML = forecastText; updateDashboardPlannedDates();
             }
            function updateProgressRing(cV,mV) { const p=mV>0?Math.min(100,(cV/mV)*100):0; const offset=progressRingCircumference*(1-p/100); progressRingFg.style.strokeDasharray = `${progressRingCircumference} ${progressRingCircumference}`; progressRingFg.style.strokeDashoffset=Math.max(0, offset);}
            function updateDashboardPlannedDates() { const todayStr = getCurrentDateString(); const futurePlans = plannedEntries.filter(p => p.date >= todayStr).sort((a,b) => new Date(a.date) - new Date(b.date)).slice(0, 3); dashboardPlanList.innerHTML = ''; if(futurePlans.length > 0) { dashboardPlannedDatesContainer.classList.remove('hidden'); futurePlans.forEach(plan => { const li = document.createElement('li'); li.innerHTML = `<strong>${formatRelativeDate(plan.date)}:</strong> ${formatHoursExtensive(plan.hours)}`; dashboardPlanList.appendChild(li); }); } else { dashboardPlannedDatesContainer.classList.add('hidden'); } }
            function renderHistory() { historyList.innerHTML = ''; const sT=historySearchInput.value.trim().toLowerCase(); let res = []; let lblTxt=''; const hasSearch = sT.length > 0; if(hasSearch) { res = recordedEntries.filter(e => { const hrStr = Math.round(e.hours||0).toString(); const dspDt = formatDisplayDate(e.date); const notes = (e.notes || '').toLowerCase(); const tag = (e.tag || '').toLowerCase(); const fHE = formatHoursExtensive(e.hours).toLowerCase(); return (dspDt.includes(sT) || e.hours.toString().replace('.',',').includes(sT) || hrStr.includes(sT) || tag.includes(sT) || notes.includes(sT) || fHE.includes(sT));}); lblTxt = `${res.length} resultado(s)${sT ? ' para "' + sT + '"':''}`; } else { const tMA = getDateMonthsAgo(HISTORY_MONTH_LIMIT); res = recordedEntries.filter(e => e.date >= tMA); lblTxt = `Mostrando √∫ltimos ${HISTORY_MONTH_LIMIT} meses`; if(recordedEntries.length > 0 && res.length === 0) { lblTxt = `Nenhum registro nos √∫ltimos ${HISTORY_MONTH_LIMIT} meses`;} else if (recordedEntries.length === 0) {lblTxt='';}} showingResultsLabel.textContent = lblTxt; if (res.length === 0) { historyListPlaceholder.textContent = recordedEntries.length > 0 ? (hasSearch ? 'Nenhum resultado para a busca' : `Nenhum registro recente (use a busca para mais antigos)`) : 'Nenhum registro encontrado.'; historyListPlaceholder.classList.remove('hidden'); } else { historyListPlaceholder.classList.add('hidden'); } res.forEach(entry => { const li = document.createElement('li'); li.dataset.id=entry.id; const tagDisp = entry.tag && entry.tag !== DEFAULT_TAG ? `<span class="tag-badge">${entry.tag}</span>` : ''; const ntPrev = entry.notes ? `<span class="notes-preview">${entry.notes.replace(/\n/g, ' ')}</span>` : '<span class="notes-preview" style="opacity:0.5;">Sem notas</span>'; const hrsDisp = formatHoursExtensive(entry.hours); li.innerHTML=`<div class="entry-details"> <strong>${formatDisplayDate(entry.date)}:</strong> <span class="hours">${hrsDisp}</span> ${tagDisp} ${ntPrev} </div> <div class="entry-actions"> <button class="edit-btn secondary">Editar</button> <button class="delete-btn danger">Excluir</button> </div>`; li.querySelector('.edit-btn').addEventListener('click',(e)=>{e.stopPropagation();editRecordEntry(entry.id);}); li.querySelector('.delete-btn').addEventListener('click',(e)=>{e.stopPropagation();deleteRecordEntry(entry.id);}); historyList.appendChild(li);}); }
            function renderPlanning() { planningList.innerHTML = ''; const tS=getCurrentDateString(); const fP=plannedEntries.filter(p=>p.date>=tS).sort((a,b)=>new Date(a.date)-new Date(b.date)); if(fP.length===0){planningListPlaceholder.classList.remove('hidden');return;} planningListPlaceholder.classList.add('hidden'); fP.forEach(plan=>{const li=document.createElement('li');li.dataset.id=plan.id; const hD=formatHoursExtensive(plan.hours); li.innerHTML=`<div class="entry-details"> <strong>${formatDisplayDate(plan.date)}:</strong> <span class="hours">${hD}</span> Planejadas </div> <div class="plan-actions"> <button class="edit-plan-btn secondary">Editar</button> <button class="delete-plan-btn danger">Excluir</button> </div>`; li.querySelector('.edit-plan-btn').addEventListener('click',(e)=>{e.stopPropagation();editPlanEntry(plan.id);}); li.querySelector('.delete-plan-btn').addEventListener('click',(e)=>{e.stopPropagation();deletePlanEntry(plan.id);}); planningList.appendChild(li); }); }
            function updateStatistics() { const cM=new Date().getMonth();const cY=new Date().getFullYear(); const eM=recordedEntries.filter(e=>{const d=new Date(e.date+'T00:00:00'); return d.getMonth()===cM && d.getFullYear()===cY;}); let tH=0;const aD=new Set(); eM.forEach(e=>{tH+=e.hours;aD.add(e.date);}); const g=settings.monthlyGoal||70; const pP = settings.goalHasBeenSet ? (g > 0 ? Math.min(Math.round((tH/g)*100),100) : 0) : 0; const aH=aD.size>0?(tH/aD.size):0; const dAC=aD.size; statsMonthHours.textContent=formatHoursExtensive(tH); statsMonthGoalProgress.textContent=settings.goalHasBeenSet ? `${pP}%` : '--%'; statsMonthProgressBar.style.width=`${pP}%`;statsAvgHoursDay.textContent=formatHoursExtensive(aH); statsMonthDaysActive.textContent=dAC; }
            function populateMonthSelector() { const aM=new Set(); recordedEntries.forEach(e => {aM.add(getMonthYearString(new Date(e.date + 'T00:00:00')));}); const sM=Array.from(aM).sort((a,b)=>{const[mA,yA]=a.split('/');const[mB,yB]=b.split('/'); return new Date(yB,mB-1)-new Date(yA,mA-1);}); const oldSelectedValue = chartMonthSelector.value; chartMonthSelector.innerHTML=''; if(sM.length===0){const o=document.createElement('option');o.value='';o.textContent='Nenhum dado';chartMonthSelector.appendChild(o);chartMonthSelector.disabled=true;return;} chartMonthSelector.disabled=false;const cMSValue=getMonthYearString(new Date()); const cMSFormatted=formatMonthYearExtensive(cMSValue); let hCM=false; let didSelectOld = false; sM.forEach(mSValue=>{const o=document.createElement('option');const mSFormatted=formatMonthYearExtensive(mSValue);o.value=mSValue;o.textContent=mSFormatted;if(mSValue === oldSelectedValue){ o.selected = true; didSelectOld = true; } else if (mSValue===cMSValue && !didSelectOld){ o.selected=true; } if (mSValue === cMSValue) { hCM = true; } chartMonthSelector.appendChild(o);}); if(!hCM){const o=document.createElement('option');o.value=cMSValue;o.textContent=`${cMSFormatted} (M√™s Atual)`; chartMonthSelector.insertBefore(o, chartMonthSelector.firstChild); if (!didSelectOld) o.selected=true; } if(!chartMonthSelector.value && chartMonthSelector.options.length > 0) { chartMonthSelector.options[0].selected = true; } }

            function getAveragesForChart(year, monthIndex) {
                 const entriesThisYear = recordedEntries.filter(e => new Date(e.date+'T00:00:00').getFullYear() === year);
                 const entriesThisMonth = entriesThisYear.filter(e => new Date(e.date+'T00:00:00').getMonth() === monthIndex);
                 let totalHoursMonth = 0; const activeDaysMonth = new Set();
                 entriesThisMonth.forEach(e => { totalHoursMonth += e.hours; activeDaysMonth.add(e.date); });
                 let totalHoursYear = 0; const monthsWithActivityYear = new Set();
                 entriesThisYear.forEach(e => { totalHoursYear += e.hours; monthsWithActivityYear.add(getMonthYearString(new Date(e.date+'T00:00:00'))); });
                 const daysInMonth = new Date(year, monthIndex + 1, 0).getDate();
                 return {
                     avgDaily: activeDaysMonth.size > 0 ? totalHoursMonth / activeDaysMonth.size : 0,
                     avgWeekly: daysInMonth >= 7 && totalHoursMonth > 0 ? (totalHoursMonth / daysInMonth) * 7 : 0,
                     avgMonthly: monthsWithActivityYear.size > 0 ? totalHoursYear / monthsWithActivityYear.size : 0
                 };
            }

            function renderCharts(selectedMonthYearValue) {
                 if (!selectedMonthYearValue) { return; }
                 try {
                     const selectedMonthYearFormatted = formatMonthYearExtensive(selectedMonthYearValue);
                     const [selectedMonth, selectedYear] = selectedMonthYearValue.split('/').map(Number);
                     const monthIndex = selectedMonth - 1;
                     const year = selectedYear;
                     const entriesSelectedMonth = recordedEntries.filter(e => { const d = new Date(e.date+'T00:00:00'); return d.getMonth() === monthIndex && d.getFullYear() === year; });
                     const daysInSelectedMonth = new Date(year, monthIndex + 1, 0).getDate();
                     const dailyHoursData = Array(daysInSelectedMonth).fill(0);
                     entriesSelectedMonth.forEach(e => { dailyHoursData[new Date(e.date+'T00:00:00').getDate()-1] += e.hours; });
                     const chartLabels = Array.from({length: daysInSelectedMonth}, (_,i) => i + 1);
                     const averages = getAveragesForChart(year, monthIndex);

                     const annotations = {};
                     if (averages.avgDaily > 0) { annotations.avgDay = { type:'line', scaleID:'y', value: averages.avgDaily, borderColor: avgLineColor1, borderWidth: 1.5, borderDash: [6, 6], label:{ content:`M√©dia Di√°ria: ${formatHoursExtensive(averages.avgDaily, true)}`, display: true, position: 'end', color: avgLineColor1, backgroundColor: tooltipBgColor, font:{size:9}, yAdjust: -10 }}; }
                     if (averages.avgWeekly > 0) { annotations.avgWeek = { type: 'line', scaleID: 'y', value: averages.avgWeekly, borderColor: avgLineColor2, borderWidth: 1.5, borderDash: [10, 10], label:{ content:`M√©dia Semanal (est.): ${formatHoursExtensive(averages.avgWeekly, true)}`, display: true, position: 'end', color: avgLineColor2, backgroundColor: tooltipBgColor, font:{size:9}, yAdjust: 2 }}; }
                     if (averages.avgMonthly > 0) { annotations.avgMonth = { type: 'line', scaleID: 'y', value: averages.avgMonthly, borderColor: avgLineColor3, borderWidth: 1.5, borderDash: [2, 2], label:{ content:`M√©dia Mensal (no ano): ${formatHoursExtensive(averages.avgMonthly, true)}`, display: true, position: 'end', color: avgLineColor3, backgroundColor: tooltipBgColor, font:{size:9}, yAdjust: 14 }}; }

                     if(monthlyHoursChartInstance){monthlyHoursChartInstance.destroy();}
                     monthlyHoursChartInstance=new Chart(monthlyHoursChartCtx,{
                        type:'bar',
                        data:{
                             labels:chartLabels,
                             datasets:[{label:`Horas Di√°rias`, data:dailyHoursData, backgroundColor:primaryColor, borderColor:primaryColor, borderWidth:0, borderRadius:4}]
                        },
                        options:{
                             responsive:true,maintainAspectRatio:false,
                             scales:{
                                 y:{ beginAtZero:true, title:{display:false},ticks:{color:textMutedColor,padding:10, callback: function(value) { return formatHoursExtensive(value, true); } }, grid:{color:gridColor,drawBorder:false}},
                                 x:{ title:{display:false},ticks:{color:textMutedColor}, grid:{display:false}}
                            },
                            plugins:{
                                annotation: { drawTime: 'afterDatasetsDraw', annotations: annotations },
                                title:{display:true, text:selectedMonthYearFormatted, color:textColor, font:{size:14,weight:'normal'}, padding:{bottom:15}},
                                tooltip:{backgroundColor:tooltipBgColor,titleColor:textColor,bodyColor:textColor,displayColors:false,padding:10,cornerRadius:6,callbacks:{label:ctx=>`Dia ${ctx.label}: ${formatHoursExtensive(ctx.parsed.y)}`}},
                                legend:{display:false}
                            }
                         }
                    });
                 } catch(e) {
                     console.error("Chart render error:", e);
                     if (monthlyHoursChartInstance) monthlyHoursChartInstance.destroy();
                     monthlyHoursChartInstance = null;
                     const ctx = monthlyHoursChartCtx;
                     ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                     ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle=textMutedColor; ctx.font="14px " + computedStyles.fontFamily; ctx.fillText("Erro ao renderizar gr√°fico.", ctx.canvas.width/2, ctx.canvas.height/2); ctx.restore();
                 }
            }

            function updateAllDisplays() {
                updateDashboard();
                updateStatistics();
                populateMonthSelector();
                renderHistory();
                renderPlanning();
                const selectedMonthValue = chartMonthSelector.value;
                let chartNeedsUpdate = false;
                let clearChartMsg = 'Selecione um m√™s para visualizar';

                if (recordedEntries.length === 0) {
                    clearChartMsg = 'Comece registrando suas horas.';
                } else if (selectedMonthValue) {
                    const hasDataForSelectedMonth = recordedEntries.some(e => getMonthYearString(new Date(e.date + 'T00:00:00')) === selectedMonthValue);
                    if (hasDataForSelectedMonth) {
                         renderCharts(selectedMonthValue);
                         chartNeedsUpdate = true;
                    } else {
                        clearChartMsg = `Nenhum registro encontrado em ${formatMonthYearExtensive(selectedMonthValue)}.`;
                    }
                } else if (chartMonthSelector.options.length > 0 && chartMonthSelector.options[0].value) {
                   chartMonthSelector.options[0].selected = true;
                   renderCharts(chartMonthSelector.value);
                   chartNeedsUpdate = true;
                } else {
                   clearChartMsg = 'Nenhum dado registrado ainda.';
                }

                 if (!chartNeedsUpdate) {
                     if(monthlyHoursChartInstance) {
                         monthlyHoursChartInstance.destroy();
                         monthlyHoursChartInstance = null;
                     }
                     const ctx=monthlyHoursChartCtx;
                     ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
                     ctx.save(); ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle=textMutedColor; ctx.font="14px " + computedStyles.fontFamily; ctx.fillText(clearChartMsg, ctx.canvas.width/2, ctx.canvas.height/2); ctx.restore();
                 }
            }

            function formatTimeInputOnType(event) {
                const input = event.target;
                let value = input.value;
                let originalCursorPos = input.selectionStart;
                let numericValue = value.replace(/[^\d]/g, '');

                numericValue = numericValue.substring(0, 4);

                let formattedValue = numericValue;
                let colonWasAdded = false;

                if (numericValue.length > 2) {
                     const hoursPart = numericValue.substring(0, numericValue.length - 2);
                     const minutesPart = numericValue.substring(numericValue.length - 2);
                     formattedValue = `${hoursPart}:${minutesPart}`;
                     if (value.length < formattedValue.length && value.indexOf(':') === -1) {
                        colonWasAdded = true;
                     }
                }

                if (input.value !== formattedValue) {
                     input.value = formattedValue;
                     let newCursorPos = originalCursorPos;
                     if (colonWasAdded && originalCursorPos >= formattedValue.indexOf(':') +1) {
                        newCursorPos++;
                     }
                     newCursorPos = Math.min(newCursorPos, formattedValue.length);
                     requestAnimationFrame(() => {
                        input.setSelectionRange(newCursorPos, newCursorPos);
                    });
                }
             }
            recordHoursInput.addEventListener('input', formatTimeInputOnType);
            planHoursInput.addEventListener('input', formatTimeInputOnType);

            recordHoursInput.addEventListener('blur', (e) => {
                 const decimalValue = parseTimeInputToDecimal(e.target.value);
                 if (!isNaN(decimalValue) && decimalValue >= 0) {
                    e.target.value = formatDecimalToTimeInput(decimalValue);
                } else if (e.target.value.trim() !== '') {
                     e.target.value = '';
                }
            });
            planHoursInput.addEventListener('blur', (e) => {
                 const decimalValue = parseTimeInputToDecimal(e.target.value);
                 if (!isNaN(decimalValue) && decimalValue > 0) {
                    e.target.value = formatDecimalToTimeInput(decimalValue);
                } else if (e.target.value.trim() !== '') {
                    e.target.value = '';
                 }
            });
            historySearchInput.addEventListener('input', () => { renderHistory(); });
            recordNotesInput.addEventListener('input', (e) => { if (e.target.value.length > NOTES_MAX_LENGTH) { e.target.value = e.target.value.substring(0, NOTES_MAX_LENGTH); showFeedback(`Limite de ${NOTES_MAX_LENGTH} caracteres atingido.`,'info'); } });
            recordForm.addEventListener('submit', handleRecordSubmit);
            planForm.addEventListener('submit', handlePlanSubmit); clearPlanFormBtn.addEventListener('click', clearPlanForm);
            saveGoalBtn.addEventListener('click', handleGoalSave); monthlyGoalInput.addEventListener('keypress',(e)=>{if(e.key==='Enter'){e.preventDefault();handleGoalSave();monthlyGoalInput.blur();}});
            chartMonthSelector.addEventListener('change', (event)=>{ updateAllDisplays(); });
            clearAllDataBtn.addEventListener('click', handleClearAllData);

            function init() {
                console.log(`Initializing PWT v${LOCAL_STORAGE_KEYS.ENTRIES.split('_v')[1]}...`);
                loadData();
                 if (!settings.goalHasBeenSet && recordedEntries.length > 0) {
                     setTimeout(() => showFeedback("Lembre-se de definir sua meta mensal.", "info"), 1000);
                     setTimeout(promptForMonthlyGoal, 1500);
                 } else if (!settings.goalHasBeenSet) {
                 }
                 recordDateInput.value = getCurrentDateString(); setDateInputVisibility(false);
                 clearRecordForm(); clearPlanForm();
                 document.querySelectorAll('.card').forEach(card => { const shouldBeExpanded = (card.id === 'record-card'); const isExpanded = card.classList.contains('expanded'); if (isExpanded !== shouldBeExpanded) { toggleCard(card); } else { const icon = card.querySelector('.toggle-icon'); if (icon) icon.textContent = shouldBeExpanded ? '‚ñ≤' : '‚ñº'; } });
                 updateAllDisplays();
                 console.log("Init complete.");
            }

            init();

        });
    </script>

</body>
</html>
